name: Visual Regression

on:
  pull_request:
    paths:
      - "src/**"
      - "tests/regression/**"
      - "tools/regression/**"
  workflow_dispatch:

jobs:
  smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ${{ env.LOCALAPPDATA }}\ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('tools/regression/requirements.txt') }}

      - name: Cache regression references
        uses: actions/cache@v4
        with:
          path: tests/regression/reference
          key: ${{ runner.os }}-regression-ref-${{ hashFiles('tests/regression/manifest.toml', 'tools/regression/reference.css', 'tools/regression/reference_renderer.py') }}

      - name: Install regression dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/regression/requirements.txt
          python -m playwright install chromium

      - name: Build mdmdview
        run: cargo build --release

      - name: Run regression smoke
        run: |
          python tools/regression/runner.py run --reference markdown-it --case 001-headings --mdmdview target/release/mdmdview.exe

      - name: Upload regression artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-artifacts
          path: |
            tests/regression/diff
            tests/regression/report
