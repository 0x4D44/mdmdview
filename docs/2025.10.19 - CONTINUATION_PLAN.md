# Continuation Plan - 2025-10-19

## Completed Since 2025-10-18 Notes
- Legacy encoding fallback and regression coverage in `src/app.rs`.
- Unicode-aware search folding across app and renderer, with accent tests.
- Window state persistence now throttled to actual changes.
- Bounded Kroki worker pool with queue messaging and regression tests for disconnects and queue saturation.
- Image cache invalidation helper plus filesystem-based unit test.
- Windows resource metadata pulled from `Cargo.toml` inside `build.rs`.
- README updated with search, encoding, cache, and Mermaid mode guidance; `.gitignore` created for `target/`.
- Footnote markers now covered by regression tests to guard the "footnotes disabled" behaviour.
- Window titles now use the `mdmdview - <document>` format via viewport commands, keeping the OS caption in sync with the active file.
- Window geometry is clamped to the active monitor and minimum size to avoid restores that end up off-screen or tiny.
- Added `search.md` sample with accent-aware search examples plus coverage.

## Next Actions
1. Track the historical review documents under `docs/` (or restore the root files) and commit `Cargo.lock`.
2. Evaluate module decomposition for `src/app.rs` and `src/markdown_renderer.rs` (prepare design sketch before Stage 3).
3. Consider exposing a configuration knob for Kroki concurrency (per open question) and document any decision.

### Repo Hygiene Notes
- Retain the historical review markdown files under `docs/` and stage them via `git add docs/*.md` so the earlier deletions are accounted for.
- Stage the freshly generated `Cargo.lock` (`git add Cargo.lock`) alongside `.gitignore` before the next commit to keep dependency locks in sync.

### Module Decomposition Outline
- **App (`src/app.rs`)**
  - Split UI event handling into `ui/events.rs` (menu + keyboard) and `ui/search.rs`.
  - Move persistence helpers (`load_file`, window state) into `state/persistence.rs`.
  - Extract search state (`fold_for_search`, navigation helpers) into `state/search.rs`.
- **Renderer (`src/markdown_renderer.rs`)**
  - Create `renderer/highlight.rs` for search highlighting + grapheme handling.
  - Move Mermaid-specific code (Kroki, QuickJS, cache) into `renderer/mermaid.rs`.
  - Relocate image cache helpers into `renderer/image_cache.rs`.
  - Keep parsing primitives (`parse_*`, `InlineSpan`) in a lean `renderer/mod.rs`.

## Validation Checklist
- `cargo fmt --all`
- `cargo clippy --all-targets -- -D warnings`
- `cargo test`
- Manual QA: load a Windows-1252 sample, verify Kroki queue messaging, edit a linked image on disk, confirm search highlight for dotted/dotless I, ensure README instructions match behaviour.

## Open Questions
- Do we want to expose a setting to cap Kroki concurrency below four for low-powered devices?
- Is module split work happening before or after the remaining documentation/UI follow-ups?
