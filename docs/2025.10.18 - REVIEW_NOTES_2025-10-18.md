# mdmdview Code Review (2025-10-18)

## Overview
- Observed the application entry (`src/main.rs`), UI/state management (`src/app.rs`), rendering engine (`src/markdown_renderer.rs`), persistence helpers, and supporting assets.
- Focused on correctness, user facing reliability, performance, security posture, and test coverage.

## High Priority Issues
- Non UTF-8 markdown files cannot be opened because `load_file` relies on `std::fs::read_to_string` and propagates the error (`src/app.rs:319`). Real world markdown often contains Windows-1252 or ISO-8859 text; consider falling back to `fs::read` plus `String::from_utf8_lossy` so the viewer degrades gracefully instead of failing.
- Saving a document to a new location does not update the renderer's base directory, so relative image links resolve against the previously loaded path (or none at all) until the file is reopened (`src/app.rs:1294`). Hook `renderer.set_base_dir` when `current_file` changes during `save_current_document`.
- Inline code spans lose leading and trailing whitespace because `.trim()` is applied before rendering (`src/markdown_renderer.rs:1089`). Markdown expects spaces to be preserved; drop the trim or replace it with logic that only strips newline artefacts.
- The `fix_unicode_chars` helper performs brittle literal replacements for mojibake patterns and can silently corrupt legitimate content (`src/markdown_renderer.rs:1030-1051`). Prefer using Unicode normalization and leave unexpected bytes untouched so users can see the original text.
- Mermaid diagrams default to sending the source to `https://kroki.io` without any timeout or opt in (`src/markdown_renderer.rs:2163-2198`). This breaks the repository guideline of "no network calls", leaks private documents, and blocks rendering when the service hangs. Gate the call behind a user setting, add timeouts, and provide an offline fallback instead of shipping live network IO.
- Footnotes are enabled in the parser options but never rendered. `parse_element` skips `Event::FootnoteReference` and footnote definitions entirely (`src/markdown_renderer.rs:209-303`), so references disappear from the document.

## Medium Priority Issues and Opportunities
- Window state persistence writes to disk every second even if nothing changed (`src/app.rs:997-1002`, `src/app.rs:1259-1275`). Cache the last saved state and only emit writes on actual changes to reduce I/O churn.
- Mermaid rendering spawns an unbounded thread per distinct diagram request with `std::thread::spawn` (`src/markdown_renderer.rs:2168-2188`). Large documents can flood the system. A bounded worker queue or async client would be safer.
- Image textures are cached forever and never invalidated when the backing file changes (`src/markdown_renderer.rs:2568-2620`). Consider storing modification timestamps or exposing a manual refresh.
- Search highlighting lowercases ASCII only (`src/markdown_renderer.rs:1275-1335`), so non Latin languages and Turkish casing behave poorly. Swap in `to_lowercase` with locale aware fallback or work with the original graphemes.
- `build.rs` hard codes Windows resource metadata such as version `1.0.0` and "Martin's Simple Markdown viewer", which diverges from `Cargo.toml` (`build.rs:10-25`). Tie the values to `env!("CARGO_PKG_VERSION")` and the package metadata to avoid drift.
- `generate_mermaid_js` shells out to `powershell` during every Windows build (`build.rs:28-52`). This fails in minimal environments (CI, cross compilation). Replace it with Rust date formatting or guard behind a feature.

## Testing and Tooling Notes
- Several app tests do not assert meaningful behaviour (for example `test_load_invalid_markdown` only checks that an option is either `Some` or `None`, which is always true; `src/app.rs:1467-1478`). Replace tautologies with concrete expectations or remove them.
- Core rendering paths (`MarkdownRenderer::render_to_ui`, Mermaid fallbacks, search flows) lack direct tests. Integration coverage around raw edit mode, zoom, and keyboard navigation would make regression detection easier.
- No automated checks exist for Windows resource mismatches or Mermaid configuration; consider adding unit tests or smoke tests around those helper routines.

## Additional Suggestions
- Document the Mermaid network behaviour prominently in the README and offer a configuration knob so users understand the privacy trade off.
- Consider splitting `src/app.rs` and `src/markdown_renderer.rs` into smaller modules; each file currently exceeds 1k lines which slows code review and maintenance.
- Review emoji rendering paths to ensure they behave correctly on HiDPI screens; the cache currently keys only on size and emoji code point.

## Multi Stage Improvement Plan
### Stage 1 (stabilise user facing bugs)
- Switch file loading to tolerate non UTF-8 input and surface partial content instead of errors.
- Update `save_current_document` to refresh the renderer base directory after "Save" and "Save As".
- Remove inline code trimming and replace `fix_unicode_chars` with a safer normalization strategy.
- Add an opt in gate and timeout protected client for Mermaid over-the-network rendering, with documentation updates.
- Render footnotes (or explicitly disable the parser option) so reference markers stop disappearing.

### Stage 2 (hardening and performance)
- Track window state deltas to avoid redundant writes and extend tests to cover the persistence layer.
- Introduce a bounded worker pool (or reuse a single `ureq::Agent` with timeouts) for Mermaid jobs and provide cancellation.
- Implement cache invalidation for image textures and expose a manual refresh button in the UI.
- Improve search highlighting to work on full Unicode case mappings and add tests for multi language input.
- Align Windows resource metadata with crate metadata via `CARGO_PKG_*` environment variables.

### Stage 3 (polish and coverage)
- Break down `app.rs` and `markdown_renderer.rs` into focused modules with targeted unit tests.
- Expand automated tests around raw edit mode, zoom persistence, and Mermaid fallbacks.
- Offer user facing settings for network usage, cache clearing, and emoji packs, rounding out documentation accordingly.


## Stage 2 Progress (Oct 19)
- Added a bounded Kroki worker pool with queue messaging and a regression test (`src/markdown_renderer.rs`).
- Introduced timestamp-aware image cache invalidation with focused coverage.
- Extended Unicode-aware search folding and lossy load tests in `src/app.rs`.
- Aligned Windows resource metadata with `Cargo.toml` inside `build.rs`.
- Updated README with notes on encoding fallback, search behaviour, and cache refresh guidance.
## Stage 1 Progress (Oct 18)
- Added lossy fallback for non-UTF8 markdown loads and regression test.
- Updated save logic to refresh renderer base directory after writing files.
- Documented Mermaid network opt-in and gated Kroki rendering behind MDMDVIEW_ENABLE_KROKI with request timeouts.
- Replaced brittle mojibake substitutions with Unicode normalization helpers and added coverage.
- Clarified inline code expectations in tests and ensured rendering no longer trims content.
- Added regression coverage ensuring footnote markers remain visible while the parser keeps footnotes disabled.


