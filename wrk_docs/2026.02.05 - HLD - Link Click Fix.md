# High-Level Design: Link Click Fix

**Date:** 2026-02-05
**Status:** Investigation & Design
**Priority:** High (core user-facing functionality)

## 1. Problem Statement

Links in the mdmdview markdown viewer are visually responsive (show blue color, pointing hand cursor on hover) but clicks do not trigger navigation. The `Response::clicked()` method returns `false` even when the user clicks directly on a link.

### Symptoms
- Links render correctly in blue
- Hover state works (cursor changes to pointing hand)
- `r.clicked()` returns `false` when clicking
- Debug output confirms click detection fails
- Both `egui::Link` widget and `ui.interact()` approaches fail

### Working Functionality (for comparison)
- Menu buttons work (outside ScrollArea, in overlay context)
- Welcome screen "Open File" button works (inside ScrollArea, but NOT inside `horizontal_wrapped`)
- Context menus work (right-click, different event path)

## 2. Architecture Analysis

### Current Layout Hierarchy

```
ScrollArea (app.rs:2518)
  scroll_bar_visibility: AlwaysVisible
  auto_shrink: [false, false]

  CentralPanel
    render_to_ui()
      Frame::none() (for element rect tracking)
        render_element_body()
          Paragraph -> render_inline_spans()
            horizontal_wrapped (line 2747)           <-- SUSPECTED ISSUE
              render_inline_span()
                egui::Link or ui.interact()
```

### Link Rendering Code (markdown_renderer.rs:2892-2948)

**Simple links (no emoji):**
```rust
let r = ui.add(egui::Link::new(rich));
if render_action_triggered(r.clicked(), "link_click") {
    self.trigger_link(url);
}
r.context_menu(|ui| { ... });  // Right-click menu
```

**Links with emoji:**
```rust
let group = ui.scope(|ui| {
    self.render_text_with_emojis(ui, &fixed_text, size, style);
});
let id = egui::Id::new(format!("link:{}:{}", *counter, url));
let r = ui.interact(group.response.rect, id, egui::Sense::click());
if render_action_triggered(r.hovered(), "link_hover") {
    ui.output_mut(|o| o.cursor_icon = egui::CursorIcon::PointingHand);
}
if render_action_triggered(r.clicked(), "link_click") {
    self.trigger_link(url);
}
```

### Test Infrastructure Evidence

Tests use `ForcedRenderActions` to bypass normal click detection:
```rust
let _guard = ForcedRenderActions::new(&["link_hover", "link_click"]);
```

This pattern suggests:
1. The developers anticipated click detection might be unreliable
2. Tests don't exercise the actual egui click path
3. The production click mechanism may have never worked correctly

## 3. Root Cause Hypotheses

### Hypothesis A: `horizontal_wrapped` Layout Interference (MOST LIKELY)

The `horizontal_wrapped` layout creates a nested UI context with special layout behavior for wrapping inline elements. This may:
- Intercept or not properly propagate click events
- Create a conflicting interaction region
- Have widget ID conflicts within the wrapped context

**Evidence:** Welcome screen button works (not inside `horizontal_wrapped`), links fail (inside `horizontal_wrapped`).

### Hypothesis B: Context Menu Interference

The `.context_menu()` extension is called on the Response after checking `clicked()`. While the order seems correct, egui's context menu system might:
- Pre-register for click events during widget creation
- Create an invisible interaction layer
- Affect the Response state for subsequent frames

**Evidence:** Context menus use right-click (secondary button) which works, but the existence of the context_menu handler might affect primary click routing.

### Hypothesis C: ScrollArea Event Consumption

The ScrollArea might be consuming primary mouse clicks for:
- Drag-to-scroll functionality (even though not explicitly enabled)
- Selection behavior
- Focus management

**Evidence:** Buttons NOT inside ScrollArea (menu) work. Need to test if buttons inside ScrollArea but outside `horizontal_wrapped` work.

### Hypothesis D: Frame Wrapper Interference

Each element is wrapped in `Frame::none()` for rect tracking:
```rust
let ir = egui::Frame::none().show(ui, |ui| {
    self.render_element_body(ui, element);
});
```

This extra layer might affect event propagation.

## 4. Investigation Plan

### Phase 1: Isolate the Problem

1. **Test A: Remove `horizontal_wrapped`**
   - Temporarily render a link directly in a paragraph without `horizontal_wrapped`
   - If clicks work, confirms Hypothesis A

2. **Test B: Remove `context_menu`**
   - Comment out `.context_menu()` calls on links
   - If clicks work, confirms Hypothesis B

3. **Test C: Test outside Frame wrapper**
   - Render a test link directly in `render_to_ui` without the Frame wrapper
   - If clicks work, confirms Hypothesis D

4. **Test D: Add diagnostic logging**
   - Log `r.hovered()`, `r.clicked()`, `r.secondary_clicked()` for every link
   - Log interaction IDs to check for conflicts

### Phase 2: Verify with egui Internals

1. Check egui 0.27 source for:
   - `horizontal_wrapped` event handling
   - `Link` widget implementation
   - `Response` lifecycle in nested layouts

2. Search egui GitHub issues for:
   - Click detection in wrapped layouts
   - ScrollArea click passthrough
   - Known 0.27 regressions

### Phase 3: Implement Fix

Based on findings, implement one of the solutions below.

## 5. Proposed Solutions

### Solution 1: Direct Widget Approach (Simplest)

Replace `horizontal_wrapped` with direct widget placement for link-containing spans.

```rust
fn render_inline_spans(&self, ui: &mut egui::Ui, spans: &[InlineSpan]) {
    // Don't use horizontal_wrapped for spans containing links
    let has_link = spans.iter().any(|s| matches!(s, InlineSpan::Link { .. }));

    if has_link {
        // Render each span directly
        for span in spans {
            self.render_inline_span(ui, span, None, None);
        }
    } else {
        ui.horizontal_wrapped(|ui| {
            ui.spacing_mut().item_spacing.x = 0.0;
            for span in spans {
                self.render_inline_span(ui, span, None, None);
            }
        });
    }
}
```

**Pros:** Minimal change, preserves existing layout for non-link content
**Cons:** May affect text wrapping behavior for link-containing paragraphs

### Solution 2: Click Passthrough Layer

Add an explicit click passthrough layer over links using `ui.allocate_rect`:

```rust
let r = ui.add(egui::Link::new(rich));
let rect = r.rect;
// Create a click-sensitive overlay
let click_r = ui.interact(rect, id, egui::Sense::click());
if click_r.clicked() {
    self.trigger_link(url);
}
```

**Pros:** Explicit control over click detection
**Cons:** May create interaction conflicts, needs careful ID management

### Solution 3: Custom Link Widget

Create a custom clickable link widget that doesn't use `egui::Link`:

```rust
fn render_clickable_link(&self, ui: &mut egui::Ui, text: &str, url: &str, size: f32, color: Color32) {
    let id = ui.auto_id_with(url);
    let galley = ui.fonts(|f| {
        f.layout_no_wrap(text.to_string(), FontId::proportional(size), color)
    });

    let (rect, response) = ui.allocate_exact_size(galley.size(), egui::Sense::click());

    if ui.is_rect_visible(rect) {
        ui.painter().galley(rect.min, galley, color);

        // Underline on hover
        if response.hovered() {
            let stroke = Stroke::new(1.0, color);
            let y = rect.bottom() - 2.0;
            ui.painter().line_segment([pos2(rect.left(), y), pos2(rect.right(), y)], stroke);
        }
    }

    if response.clicked() {
        self.trigger_link(url);
    }
}
```

**Pros:** Full control over rendering and interaction
**Cons:** More code to maintain, need to replicate Link widget features

### Solution 4: Response Union Pattern

Collect all link responses and process clicks at the end of the frame:

```rust
// In MarkdownRenderer struct
pending_link_clicks: RefCell<Vec<(Response, String)>>,

// In render_inline_span
let r = ui.add(egui::Link::new(rich));
self.pending_link_clicks.borrow_mut().push((r, url.clone()));

// At end of render_to_ui
for (response, url) in self.pending_link_clicks.borrow().drain(..) {
    if response.clicked() {
        self.trigger_link(&url);
        break; // Only handle one click per frame
    }
}
```

**Pros:** Defers click processing, may avoid timing issues
**Cons:** Architectural change, response may be stale

### Solution 5: egui Version Upgrade

Upgrade to a newer egui version if the issue is a known bug in 0.27.

**Pros:** May get the fix "for free"
**Cons:** May introduce other breaking changes, requires testing

## 6. Recommended Approach

### Phase 1: Quick Investigation (1-2 hours)
1. Add detailed debug logging to link click handling
2. Test removal of `horizontal_wrapped` for link-containing paragraphs
3. Test removal of `.context_menu()` calls

### Phase 2: Targeted Fix (based on findings)
- If `horizontal_wrapped` is the issue: Implement Solution 1
- If `context_menu` is the issue: Restructure context menu attachment
- If neither: Implement Solution 3 (custom link widget)

### Phase 3: Validation
1. Manual testing with test_stress.md
2. Test internal anchor links (e.g., `[Section](#section)`)
3. Test external links (open in browser)
4. Verify existing tests still pass

## 7. Test Plan

### Unit Tests (existing)
- `test_render_action_triggered_forced_paths` - verifies test infrastructure
- Link rendering tests use `ForcedRenderActions` - won't catch real click issues

### New Tests Needed
1. Integration test that simulates actual mouse click events via egui's test harness
2. Test click propagation through `horizontal_wrapped`
3. Test click propagation through ScrollArea

### Manual Testing
1. Click links in various contexts:
   - Paragraph links
   - Header links (TOC)
   - Links with emoji
   - Internal anchor links (`#section`)
   - External links (should open browser)
2. Test at different zoom levels
3. Test after scrolling
4. Test with long documents

## 8. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Fix breaks text wrapping | Medium | Medium | Test with various content |
| Fix introduces new bugs | Low | Medium | Comprehensive testing |
| egui upgrade breaks other features | Medium | High | Avoid unless necessary |
| Performance regression | Low | Low | Profile if custom widget used |

## 9. Success Criteria

1. Links respond to single left-click
2. Link hover state unchanged (pointing hand cursor)
3. Internal anchor links scroll to target
4. External links open in default browser
5. No regression in text layout/wrapping
6. All existing tests pass
7. Context menus still work (right-click)

## 10. References

- Research document: `wrk_docs/2026.02.05 - egui Link Click Research.md`
- Link rendering: `src/markdown_renderer.rs:2892-2951`
- Inline span layout: `src/markdown_renderer.rs:2745-2754`
- ScrollArea setup: `src/app.rs:2518-2528`
- Test infrastructure: `src/markdown_renderer.rs:5674-5697`
- egui documentation: https://docs.rs/egui/0.27.0/egui/
