# PLN - Mermaid Renderer Completion

Date: 2025.12.29
Based on: wrk_docs/2025.12.29 - HLD - Mermaid Renderer Completion.md

## Overview
Complete the built-in Mermaid renderer by making embedded rendering the default, gating Kroki behind an explicit feature, and adding missing validation, regression coverage, and documentation updates.

## Stage 1 - Feature and dependency gating
Goal: make embedded rendering the default build and isolate Kroki behind a feature.
- Update `Cargo.toml`:
  - Add `mermaid-embedded = ["mermaid-quickjs"]`.
  - Add `mermaid-kroki = ["dep:ureq"]`.
  - Set `default = ["mermaid-embedded"]`.
  - Make `ureq` optional and referenced only by `mermaid-kroki`.
- Add `#[cfg(feature = "mermaid-kroki")]` guards to Kroki fields, worker setup, and functions in `src/mermaid_renderer.rs`.
- Provide no-op or fallback messages when Kroki is not compiled.
Deliverables:
- Default build uses embedded renderer.
- Kroki code compiles only when `mermaid-kroki` is enabled.
Exit criteria:
- `cargo build` succeeds with defaults.
- `cargo build --no-default-features` succeeds (Mermaid off).
- `cargo build --features mermaid-kroki` succeeds.

## Stage 2 - Renderer capability handling
Goal: ensure renderer selection is deterministic and reports capability gaps.
- Add a capability check for embedded and Kroki availability.
- If embedded is requested but not compiled or JS missing, show a clear message and fall back to source rendering.
- If Kroki is requested but not compiled, show a clear message and fall back to source rendering.
- Update tests for renderer preference and capability mapping.
Deliverables:
- Preference logic and UI messaging are accurate for all combinations.
Exit criteria:
- Unit tests cover embedded/kroki/off preference cases and capability gaps.

## Stage 3 - QuickJS validation tests
Goal: add feature-gated tests that exercise the embedded renderer.
- Add QuickJS tests that render a flowchart and sequence diagram to SVG and verify non-empty output.
- Add a rasterization smoke test to confirm RGBA output and size.
- Add a test that asserts `MERMAID_JS` is non-empty when `mermaid-quickjs` is enabled.
Deliverables:
- Feature-gated tests that run with `--features mermaid-quickjs`.
Exit criteria:
- `cargo test --features mermaid-quickjs` passes locally.

## Stage 4 - Regression harness coverage
Goal: lock Mermaid output into the regression harness.
- Update `tools/regression/runner.py` to set:
  - `MDMDVIEW_MERMAID_RENDERER=embedded`
  - `MDMDVIEW_ENABLE_KROKI=0`
- Regenerate baseline/reference outputs for `tests/regression/cases/008-mermaid.md`.
- Store reference images/metadata under `tests/regression/reference/008-mermaid`.
Deliverables:
- Mermaid regression case produces a stable reference output.
Exit criteria:
- Regression run completes without invoking network rendering.

## Stage 5 - Docs, samples, and licensing
Goal: align documentation with the new defaults.
- Update `README.md` to describe embedded as the default and Kroki as optional.
- Update `src/sample_files.rs` to remove feature-gated language.
- Add Mermaid license text under `assets/vendor/` or a `THIRD_PARTY_NOTICES.md` file.
Deliverables:
- Docs and samples match the new default behavior.
Exit criteria:
- README and sample output reflect embedded rendering without extra flags.

## Stage 6 - Final validation
Goal: verify the repo builds cleanly with new defaults and features.
- Run `cargo fmt --all`.
- Run `cargo clippy --all-targets -- -D warnings`.
- Run `cargo test` and `cargo test --features mermaid-quickjs`.
- Run `cargo build --release` (defaults) and `cargo build --release --features mermaid-kroki`.
Deliverables:
- Clean checks and release builds across feature variants.
Exit criteria:
- All commands succeed with no warnings.
