# HLD - Mermaid Renderer Completion Update

Date: 2025.12.30
Status: Draft

## Summary

## Progress Review (Current State)
- Renderer module is present with QuickJS path, worker pool, caching, and error handling in `src/mermaid_renderer.rs`.
- Markdown integration delegates Mermaid blocks via `MermaidRenderer::render_block` in `src/markdown_renderer.rs`.
- Build embeds `assets/vendor/mermaid.min.js` into `OUT_DIR/mermaid_js.rs` in `build.rs`.
- Regression case exists (`tests/regression/cases/008-mermaid.md`) with current references in `tests/regression/reference/008-mermaid`.
- README and samples still describe Mermaid as feature-gated.

## Gaps
1. Default features are empty; embedded rendering is not the default.
3. Capability handling does not report "embedded requested but not compiled".
4. QuickJS tests do not assert real render output.
6. Mermaid license is not recorded alongside the vendor asset.

## Design Goals
- Offline embedded rendering is the default behavior.
- Network rendering remains optional and explicit.
- Renderer selection is deterministic and reports capability gaps.
- QuickJS path has regression and smoke coverage.
- Documentation and licensing reflect the embedded default.

## Proposed Changes

### Feature Model and Build Defaults
- Add `mermaid-embedded = ["mermaid-quickjs"]`.
- Set `[features] default = ["mermaid-embedded"]`.

### Renderer Capability Detection
- If `MDMDVIEW_MERMAID_RENDERER=embedded` but embedded is not compiled or JS missing:
  - Show a warning panel and fall back to source rendering.
- Keep `off` behavior as-is with clear messaging.

### Embedded JS Asset Validation
- Add a feature-gated test that asserts `mermaid_embed::MERMAID_JS` is non-empty.
- If JS bytes are empty at runtime, show a clear warning and disable embedded rendering.


### Validation and Regression Coverage
- Add QuickJS tests (feature-gated) that render a flowchart, sequence diagram, and class/state diagram:
  - Assert non-empty SVG output.
  - Assert rasterization produces non-empty RGBA output with size bounds.
- Update regression runner to set:
  - `MDMDVIEW_MERMAID_RENDERER=embedded`
- Regenerate `tests/regression/reference/008-mermaid` with embedded output.

### Documentation and Licensing
- Add Mermaid license text under `assets/vendor/` or `THIRD_PARTY_NOTICES.md`.
- Update `src/sample_files.rs` and other docs to remove feature-gated language.

## Compatibility
- Keep `mermaid-quickjs` for compatibility; `mermaid-embedded` becomes the default alias.
- Keep env vars but treat them as no-ops when features are not compiled.

## Risks and Mitigations
- Mermaid version drift: pin vendor version and document it.
- QuickJS reliability: add render smoke tests and timeouts.

## Open Questions
- Should missing Mermaid JS under embedded builds be a hard error?
- Do we want a UI selector for renderer choice, or keep env vars only?
