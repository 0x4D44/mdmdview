# Implementation Plan - Markdown Table Wrapping Overhaul

**Date:** 2025-11-10  
**Author:** Codex (autogen)  
**Source HLD:** `2025.11.10 - HLD - Table Wrapping Overhaul.md`

---

## 0. Plan Review Summary

**Update (2025-11-11):** The table wrap renderer now always runs (legacy path removed).

Issues found during review and their resolutions:

1. **Unstated dependencies between stages** - Stage 3 implicitly depends on the layout builder, but the earlier plan did not spell out sequencing or rollback triggers. Added explicit *Prerequisites* and *Rollback/Exit* bullets per stage.
2. **Missing acceptance criteria** - Each stage now has measurable *Quality Gates* (tests, manual steps, or benchmarks) so we know when to merge.
3. **No migration/back-out strategy** - Introduced a temporary `table_wrap_overhaul` feature flag toggled in Stage 3 to allow dogfooding without blocking releases.
4. **Performance/caching left unquantified** - Stage 4 now includes target hit rates and profiling guidance so we can prove the cache is worthwhile.
5. **Regression sample + documentation left optional** - Recast as mandatory cross-cut deliverables to guarantee future QA coverage.

---

## 1. Global Milestones & Governance

| Milestone | Contents | Exit Criteria |
| --- | --- | --- |
| M1 | Stages 1-2 merged behind no-op feature flag | Fragment + layout job builders fully tested, no UI change |
| M2 | Stage 3 behind `table_wrap_overhaul` flag | Table rendering uses new pipeline when flag is on; default off |
| M3 | Stage 4 caching + flag removal | Cache validated (>=80% hit rate on sample doc) and flag defaults on |

Governance notes:
- Keep PRs per stage < 400 LOC where possible; larger chunks require reviewer sign-off.
- Coordinate merges with QA so they can capture screenshots of the canonical sample file.

---

## 2. Stage 1 - Fragment Builder & Helpers

**Prerequisites:** None.  
**Feature flag:** Not needed (no UI impact).  

### Scope
- Define `CellFragment` enum.
- Provide helper utilities for span classification, text extraction, and highlight-aware slicing (shared with Stage 2).

### Tasks
1. Add `CellFragment` (Text, Emoji, Image) and helper `is_text_like_span`.
2. Implement `fn cell_fragments(spans: &[InlineSpan]) -> Vec<CellFragment>` including highlight-aware slicing boundaries.
3. Unit tests:
   - `test_cell_fragments_split_on_emoji`.
   - `test_cell_fragments_preserve_order_and_counts`.
   - `test_cell_fragments_merge_consecutive_text_spans`.
4. Benchmark (informal) on SAMPLE_FILES to confirm fragment builder does not allocate excessively (log fragment counts under `cfg(test)`).

### Quality Gates
- `cargo test` (new tests + existing suite).
- Perf assertion: fragment builder adds <5% to parsing time on `sample_files::FORMAT_GUIDE` (manual measurement using `Instant`). Record results in PR description.

### Rollback/Exit
- If fragment builder causes regressions, revert to last stable commit (no user-visible change yet). No flag necessary.

---

## 3. Stage 2 - Layout Job Builder

**Prerequisites:** Stage 1 merged.  
**Feature flag:** Introduce `table_wrap_overhaul` (default false) to gate new rendering once Stage 3 lands.  

### Scope
- Convert text fragments into `LayoutJob`s that honor wrap widths, highlight_phrase, inline code styling, and link colors.
- Provide response metadata (plain text) for context menus and copy actions.

### Tasks
1. Implement `build_layout_job(&self, spans, wrap_width, strong_override, highlight_phrase) -> LayoutJobBuild` where `LayoutJobBuild` bundles `LayoutJob`, plain text, and any link metadata.
2. Reuse existing helpers for emoji shortcodes, inline code backgrounds, and hyperlink styling.
3. Tests:
   - `test_layout_job_respects_wrap_width` (simulate narrow width).
   - `test_layout_job_highlight_splits_sections`.
   - `test_layout_job_link_color_and_metadata`.
4. Add documentation comments describing how the builder interacts with `highlight_phrase`.
5. Update `MarkdownRenderer` to expose the builder but keep existing rendering path for now.

### Quality Gates
- `cargo test` plus new layout builder tests.
- Manual dev-tool check: temporary debug UI (guarded by `cfg(feature = "devtools")`) rendering a single cell using the builder; verify wrap visually.

### Rollback/Exit
- Because the builder is unused until Stage 3, rollback is low risk. If tests fail, revert the builder before continuing.

---

## 4. Stage 3 - Table Renderer Refactor

**Prerequisites:** Stages 1-2 merged.  
**Feature flag:** `table_wrap_overhaul` controls whether the new renderer runs. Default OFF for this stage; toggled to ON only in QA builds.  

### Scope
- Replace `horizontal_wrapped` loops with fragment iteration + layout job rendering.
- Constrain each cell `Ui` width, render emoji/images in-line, and restore context menus/link behavior.

### Tasks
1. Add column-child `Ui` creation with both `set_width` and `set_max_width` using computed column width.
2. Iterate fragments:
   - Text fragment -> call layout builder, render via `ui.label(job)`, attach context menu + link click handlers.
   - Emoji/Image fragment -> clamp width, flush pending layout job before/after widget.
3. Implement hover tooltip fallback: when a cell wraps (galley rows > 1), attach `on_hover_text_full` with the plain text.
4. Wire feature flag in app settings (`AppState::table_wrap_overhaul_enabled` or CLI env var) so QA can toggle without rebuild.
5. Manual QA checklist:
   - Provided problematic table.
   - Table with emojis, inline code, and images.
   - Highlight phrase in table cell.
6. Add screenshot(s) to `docs/` demonstrating before/after (optional but recommended for release notes).

### Quality Gates
- Automated: `cargo test`, `cargo clippy --all-targets -- -D warnings`.
- Manual: QA sign-off recorded in PR (screenshots + steps).
- Flag fallback: ability to disable new path at runtime confirmed.

### Rollback/Exit
- If regressions found, keep flag OFF and file follow-up tasks; existing renderer remains available.

---

## 5. Stage 4 - Caching & Performance Polish

**Prerequisites:** Stage 3 merged (flag may still be off by default).  
**Feature flag:** Continue respecting `table_wrap_overhaul`; cache is only active when flag is ON.  

### Scope
- Add `CellLayoutCache` with key `(row_idx, col_idx, content_hash, wrap_width, font_scale, theme_variant)`.
- Provide invalidation hooks and instrumentation for hit-rate tracking.

### Tasks
1. Implement cache struct (likely `lru::LruCache` or custom `HashMap` + FIFO) stored in `MarkdownRenderer`.
2. Add invalidation triggers: file load, zoom in/out/reset, font size change, viewport resize, theme toggle.
3. Expose `debug_metrics.table_layout_cache_hits/misses` for logging.
4. Tests:
   - `test_cell_layout_cache_hits_same_width`.
   - `test_cell_layout_cache_miss_on_width_change`.
   - `test_cell_layout_cache_clear_on_zoom`.
5. Benchmark large markdown (N=500 rows) measuring render time before/after cache; target >=80% hit rate after warm-up.
6. Update feature flag default to ON once cache meets performance target; remove old rendering path after burn-in period.

### Quality Gates
- Unit tests + integration tests covering cache behavior.
- Perf report attached to PR (table summarizing render times with/without cache).
- Final acceptance: with flag ON, user-reported table renders correctly and scrolling remains smooth (<16 ms/frame on dev hardware).

### Rollback/Exit
- If cache introduces regressions, keep flag ON but disable cache via hidden config, file new issue to revisit.

---

## 6. Cross-Cutting Deliverables

1. **Regression sample markdown** - Add the problematic table to `examples/regressions/table-wrap.md` and reference it in manual QA steps.
2. **Documentation updates** - Mention improved table layout + tooltip behavior in README release notes section.
3. **Telemetry hooks (optional)** - If feasible, log once per session that the table wrap overhaul is active to aid support.
4. **Issue tracking** - Create follow-up ticket for potential migration to `egui_extras::TableBuilder` after Stage 4 stabilizes.

---

## 7. Exit Criteria (Project-Level)

- `table_wrap_overhaul` flag defaults to ON (and legacy path removed after burn-in if no regressions).
- Automated suite: `cargo fmt`, `cargo clippy --all-targets -- -D warnings`, `cargo test` all green in CI.
- Manual QA checklist completed on Windows (primary target) and at least one other platform (if applicable).
- Regression sample renders without overlap at multiple zoom levels, with highlight phrase, emojis, and inline images verified.
- Cache metrics captured and documented in CHANGELOG/PR (hit rate, render time improvement).

Once these criteria are met, we can ship the overhaul confidently and close the original issue.


