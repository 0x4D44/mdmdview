# HLD: Light/Dark Mode Toggle — V3

**Date:** 2026-02-09
**Status:** Final Draft
**Author:** Arthur + Claude
**Previous:** V2 — fixed 5 issues | V1 — initial design
**Changes in V3:** Fixed configure_egui_style regression (see Section 11)

## 1. Problem Statement

mdmdview is dark-mode only. Lawyers need light mode. The app has ~30 theme-critical hardcoded color sites across 4 files. We need a runtime toggle with persistence.

## 2. Requirements

1. **Toggle**: Status bar button + `Ctrl+Shift+T` shortcut
2. **Persistence**: Theme preference survives restart
3. **Complete**: All elements correct in both modes
4. **Default**: New installs default to dark mode
5. **Minimal disruption**: Don't change `MarkdownRenderer::new()` signature (222 test call sites)

## 3. Scope Analysis

### 3.1 Color Audit

**Theme-critical** (~30 sites):

| Category | File | Lines | Dark Colors |
|----------|------|-------|-------------|
| External links | markdown_renderer.rs | 743, 2905 | `(120, 190, 255)` |
| Internal links | markdown_renderer.rs | 745, 2907 | `LIGHT_BLUE` |
| Inline code | markdown_renderer.rs | 872, 2844 | bg `(30,30,30)` fg `(180,255,180)` |
| Blockquote | markdown_renderer.rs | 2643-2669 | bg `(24,24,24)` border `(40,40,40)` text WHITE bar `(255,103,25)` |
| Code blocks | markdown_renderer.rs | 2964-3972 | bg `(25-30)` border `(60,60,60)` label `(140-150)` fallback `(220,220,220)` |
| Syntect theme | markdown_renderer.rs | 5778 | `"base16-ocean.dark"` |
| Mermaid boxes | mermaid_renderer.rs | 769-1009 (×6) | bg `(25,25,25)` border `(60,60,60)` title `(200,160,80)` body `(180,180,180)` |
| Status accents | app.rs | 2131-2145 | loading `(120,200,255)` queue `(100,150,255)` hint GRAY |

**No changes needed:** search highlighting (uses `visuals.selection`), table dividers (uses `visuals.widgets.noninteractive`), list markers (uses `text_color()`), menu text (already theme-aware), emoji colors (intrinsic), error RED, drag overlay, `Color32::WHITE` in `layout_no_wrap()` measurement calls.

### 3.2 Syntax Highlighting: Parse-Time Baking

Syntect highlighting is baked at parse time into `MarkdownElement::CodeBlock.highlighted`. Theme toggle requires re-parsing. `parse()` returns `Result` — error must be handled.

### 3.3 Code Block Color Unification

Two slight inconsistencies in current code — bg: `(30)` vs `(25)`, label: `(140)` vs `(150)` — unified to `(30)` and `(140)`. Likely accidental, not intentional differentiation.

## 4. Design

### 4.1 Architecture

```
ThemeColors::current(dark_mode) → &'static palette
    Used by: markdown_renderer, mermaid_renderer, app

AppSettings.dark_mode → Persisted in settings.txt + Windows registry

Toggle flow:
  1. Flip settings.dark_mode
  2. apply_dark_mode_visuals(ctx, dark) — sets visuals + true-black
  3. renderer.set_dark_mode(dark)
  4. Re-parse content (match on Result)
  5. Save settings to disk
```

### 4.2 ThemeColors (`src/theme.rs` — NEW)

```rust
use egui::Color32;

pub struct ThemeColors {
    // Links
    pub link: Color32,
    pub link_internal: Color32,
    // Code blocks
    pub code_bg: Color32,
    pub code_border: Color32,
    pub code_label: Color32,
    pub code_fallback_text: Color32,
    // Inline code
    pub inline_code_bg: Color32,
    pub inline_code_fg: Color32,
    // Blockquotes
    pub blockquote_bg: Color32,
    pub blockquote_border: Color32,
    pub blockquote_text: Color32,
    pub blockquote_bar: Color32,
    // Info/error boxes
    pub box_bg: Color32,
    pub box_border: Color32,
    pub box_title: Color32,
    pub box_body: Color32,
    // Status bar
    pub status_loading: Color32,
    pub status_queue: Color32,
    pub status_hint: Color32,
}

impl ThemeColors {
    pub const DARK: Self = Self { /* see Section 5 */ };
    pub const LIGHT: Self = Self { /* see Section 5 */ };

    pub fn current(dark_mode: bool) -> &'static Self {
        if dark_mode { &Self::DARK } else { &Self::LIGHT }
    }

    pub fn syntect_theme(dark_mode: bool) -> &'static str {
        if dark_mode { "base16-ocean.dark" } else { "InspiredGitHub" }
    }
}
```

Also in `theme.rs`, the shared visuals helper:

```rust
/// Apply dark or light visuals with true-black overrides for dark mode.
/// Clones the current style to preserve spacing/rounding.
pub fn apply_dark_mode_visuals(ctx: &egui::Context, dark: bool) {
    let mut style = (*ctx.style()).clone();
    style.visuals = if dark {
        egui::Visuals::dark()
    } else {
        egui::Visuals::light()
    };
    if dark {
        style.visuals.window_fill = Color32::BLACK;
        style.visuals.panel_fill = Color32::BLACK;
        style.visuals.faint_bg_color = Color32::from_gray(20);
        style.visuals.extreme_bg_color = Color32::BLACK;
    }
    ctx.set_style(style);
}
```

### 4.3 `configure_egui_style()` — NOT modified

V2 proposed replacing the true-black block in `configure_egui_style()` (main.rs:451-456) with a call to `apply_dark_mode_visuals()`. This creates a regression:

- With `--theme dark` (no screenshot): `configure_egui_style()` runs after visuals are set. If the true-black block is removed, dark mode loses true-black overrides because `apply_saved_theme()` is skipped when `resolved_theme.is_some()`.
- Also, `configure_egui_style()` calls `configure_font_fallbacks()` at line 460 — can't simply replace the whole function.

**V3 decision:** Leave `configure_egui_style()` completely unchanged. Accept the 4-line duplication of true-black overrides between `configure_egui_style()` and `apply_dark_mode_visuals()`. This is the minimal-risk approach — it touches fewer code paths and keeps the startup flow identical to today.

### 4.4 AppSettings (`src/window_state.rs`)

- Add `dark_mode: bool` to `AppSettings`
- Manual `Default` impl: `dark_mode: true` (derive gives false)
- File: parse/write `dark_mode=0|1`
- Registry: `DarkMode` DWORD, default `1`
- Backward compatible: missing key → default true

### 4.5 MarkdownRenderer (`src/markdown_renderer.rs`)

- Add `dark_mode: bool` field (default `true` in `new()` — signature unchanged, 222 test sites safe)
- Add `pub fn set_dark_mode(&mut self, dark: bool)` setter
- Replace ~12 hardcoded color sites with `ThemeColors::current(ui.visuals().dark_mode)`
- Syntect: `&self.theme_set.themes[ThemeColors::syntect_theme(self.dark_mode)]`

### 4.6 Mermaid Renderer (`src/mermaid_renderer.rs`)

Replace ~6 error/info box color sites with `ThemeColors::current(ui.visuals().dark_mode)`.

Rendered mermaid diagram images (from QuickJS) are theme-independent — no cache invalidation needed.

### 4.7 App Toggle (`src/app.rs`)

**Signature change:** `render_status_bar(&self, ctx)` → `render_status_bar(&mut self, ctx)` so it can set `theme_toggle_requested`. Safe: `render_menu_bar` already `&mut self`, all test sites use `let mut app`.

**Struct changes:**
- Replace `allow_remote_images: bool` field with `settings: AppSettings`
- Add `theme_toggle_requested: bool`

**Status bar** (rightmost in right-to-left layout):
```rust
let label = if self.settings.dark_mode { "Dark" } else { "Light" };
if ui.small_button(label).clicked() {
    self.theme_toggle_requested = true;
}
```

**Shortcut** (in `handle_shortcuts()`): `Ctrl+Shift+T` (no conflicts with existing shortcuts).

**Deferred handling** (top of `update()`, alongside other deferred actions):
```rust
if self.theme_toggle_requested {
    self.theme_toggle_requested = false;
    self.toggle_theme(ctx);
}
```

**toggle_theme():**
```rust
fn toggle_theme(&mut self, ctx: &egui::Context) {
    self.settings.dark_mode = !self.settings.dark_mode;
    apply_dark_mode_visuals(ctx, self.settings.dark_mode);
    self.renderer.set_dark_mode(self.settings.dark_mode);
    if !self.current_content.is_empty() {
        match self.renderer.parse(&self.current_content) {
            Ok(elements) => self.parsed_elements = elements,
            Err(e) => self.error_message = Some(format!("Failed to parse markdown: {e}")),
        }
    }
    let _ = save_app_settings(&self.settings);
}
```

### 4.8 Startup (`src/main.rs`)

```rust
let mut app = MarkdownViewerApp::new();
// Apply saved theme ONLY when no explicit --theme flag
if resolved_theme.is_none() {
    app.apply_saved_theme(&cc.egui_ctx);
}
```

Where `apply_saved_theme()` calls `apply_dark_mode_visuals(ctx, self.settings.dark_mode)`.

When `resolved_theme` is `Some`, the theme was set at lines 318-331, then `configure_egui_style()` applies true-black (if dark). Saved preference is NOT applied — explicit CLI flags take precedence.

### 4.9 Module Registration (`src/lib.rs`)

```rust
pub mod theme;
pub use theme::{ThemeColors, apply_dark_mode_visuals};
```

## 5. Color Palette

| Name | Dark | Light | Rationale |
|------|------|-------|-----------|
| link | `(120, 190, 255)` | `(0, 102, 204)` | Standard web blue |
| link_internal | `(135, 206, 250)` | `(0, 80, 180)` | Slightly darker than external |
| code_bg | `(30, 30, 30)` | `(245, 245, 245)` | GitHub-style |
| code_border | `(60, 60, 60)` | `(210, 210, 210)` | Subtle |
| code_label | `(140, 140, 140)` | `(120, 120, 120)` | Muted |
| code_fallback_text | `(220, 220, 220)` | `(50, 50, 50)` | High contrast |
| inline_code_bg | `(30, 30, 30)` | `WHITE` | Clean |
| inline_code_fg | `(180, 255, 180)` | `(60, 80, 150)` | Already existed |
| blockquote_bg | `(24, 24, 24)` | `(245, 245, 248)` | Subtle warm gray |
| blockquote_border | `(40, 40, 40)` | `(215, 215, 220)` | Subtle |
| blockquote_text | `WHITE` | `(40, 40, 40)` | Near-black |
| blockquote_bar | `(255, 103, 25)` | `(255, 103, 25)` | Same orange both |
| box_bg | `(25, 25, 25)` | `(245, 245, 245)` | Match code blocks |
| box_border | `(60, 60, 60)` | `(200, 200, 200)` | Match code blocks |
| box_title | `(200, 160, 80)` | `(160, 100, 20)` | Darker amber |
| box_body | `(180, 180, 180)` | `(80, 80, 80)` | Medium gray |
| status_loading | `(120, 200, 255)` | `(30, 120, 200)` | Darker blue |
| status_queue | `(100, 150, 255)` | `(30, 100, 200)` | Darker blue |
| status_hint | `GRAY` | `(130, 130, 130)` | Slightly darker |

Syntect: dark = `"base16-ocean.dark"`, light = `"InspiredGitHub"`.

## 6. Edge Cases

1. **New install**: `AppSettings::default().dark_mode == true`
2. **Upgrade (missing key)**: Retains default (true = dark)
3. **Registry missing key**: `unwrap_or(1)` → dark
4. **`--theme` CLI flag**: Saved preference skipped; explicit flag wins
5. **Re-parse failure**: Error shown, old elements preserved
6. **Mermaid images**: Theme-independent, no invalidation needed
7. **First frame after toggle**: `toggle_theme()` runs in deferred section before rendering — all rendering uses new visuals in the same frame

## 7. Files Modified

| File | Type | Summary |
|------|------|---------|
| `src/theme.rs` | NEW | ThemeColors palette + `apply_dark_mode_visuals()` |
| `src/lib.rs` | Edit | `pub mod theme` + re-exports |
| `src/window_state.rs` | Edit | `dark_mode` in AppSettings, file + registry persistence |
| `src/app.rs` | Edit | `settings` field, status bar `&mut self` + toggle button, `Ctrl+Shift+T`, `toggle_theme()` |
| `src/markdown_renderer.rs` | Edit | `dark_mode` field + setter, ThemeColors at ~12 sites, syntect switch |
| `src/mermaid_renderer.rs` | Edit | ThemeColors at ~6 box sites |
| `src/main.rs` | Edit | `apply_saved_theme()` at startup, guarded by `resolved_theme.is_none()` |

## 8. Testing

**Existing tests:** 222 `MarkdownRenderer::new()` unchanged. Test `AppSettings { ... }` constructors get `dark_mode: true`.

**New tests:**
- ThemeColors: `current(true/false)` returns correct palette, valid syntect theme names
- AppSettings: `default().dark_mode == true`, round-trip persistence, missing key defaults
- Renderer: highlight_code with dark/light syntect themes
- `Ctrl+Shift+T` shortcut fires toggle

**Manual:** Toggle via button + shortcut, verify all elements, restart for persistence, `mdscreensnap` comparison.

## 9. Version

Minor bump (new feature).

## 10. Resolved Decisions

1. `Ctrl+Shift+T` shortcut (no conflict with existing shortcuts)
2. Status bar accent colors in ThemeColors
3. Code block bg/label unified (was inconsistent: 25 vs 30, 140 vs 150)
4. Mermaid diagram textures — theme-independent, no cache invalidation
5. Button shows current state ("Dark"/"Light") not action — common convention for mode indicators
6. `configure_egui_style()` left unchanged — accept 4-line duplication over risky refactor

## 11. Changelog

| V | # | Issue | Severity | Fix |
|---|---|-------|----------|-----|
| V2 | 1 | `render_status_bar(&self)` can't set deferred flag | Critical | Change to `&mut self` |
| V2 | 2 | `apply_saved_theme()` overrides CLI `--theme` | Critical | Guard: `if resolved_theme.is_none()` |
| V2 | 3 | `parse()` returns `Result`, toggle ignored error | Critical | Added `match` with error handling |
| V2 | 4 | True-black duplication | Moderate | Proposed shared helper |
| V2 | 5 | Code bg/label inconsistencies | Low | Documented as intentional unification |
| V3 | 6 | Replacing true-black in `configure_egui_style()` breaks `--theme dark` CLI | Moderate | Leave `configure_egui_style()` unchanged, accept 4-line duplication |
