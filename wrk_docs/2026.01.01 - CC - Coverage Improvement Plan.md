# Coverage Improvement Plan - 2026.01.01

## Goal
Raise `src/` line coverage to **>= 98%** (currently 84.15%: 9013 / 10711) using `cargo llvm-cov` with `--ignore-filename-regex "target/llvm-cov-target"`.

## Measurement Command
```
cargo llvm-cov --workspace --all-targets --json --output-path wrk_docs/coverage-latest.json --ignore-filename-regex "target/llvm-cov-target"
```

## Stage 1 - App Core Logic Coverage (Largest Gap)
**Target:** Raise `src/app.rs` from 59.95% to >= 95%.

Planned tests:
- Screenshot workflow: start, stable layout, scroll ratio handling, metadata, and save path error handling.
- Navigation + history: back/forward boundaries, queue handling, and title updates on navigation.
- Keyboard shortcuts and input-driven state transitions (search toggle, view toggle, write toggle).
- Window state persistence: dirty detection, throttle logic, and max/min size adjustment paths.
- File dialog and drag/drop error paths (empty drops, invalid extensions, directory scan failures).

Verification:
```
cargo test app::tests -- --nocapture
cargo llvm-cov --workspace --all-targets --json --output-path wrk_docs/coverage-stage1.json --ignore-filename-regex "target/llvm-cov-target"
```

## Stage 2 - Renderer Branch Coverage
**Target:** Raise `src/markdown_renderer.rs` from 89.67% to >= 97%.

Planned tests:
- Inline span rendering branches (links, code spans, images with titles, emphasis/strong combinations).
- Code block rendering variants (language detection, fallback paths, missing language cases).
- Table rendering branches (nowrap, alignment variants, column widths, empty cells).
- Link handling (web/browser open suppression paths, fragment jumps).

Verification:
```
cargo test markdown_renderer::tests -- --nocapture
cargo llvm-cov --workspace --all-targets --json --output-path wrk_docs/coverage-stage2.json --ignore-filename-regex "target/llvm-cov-target"
```

## Stage 3 - CLI and Entry Points
**Target:** Raise `src/main.rs` to >= 98%.

Planned tests:
- CLI parsing for screenshot args (valid/invalid combos, defaults).
- Theme selection and font source parsing.
- Error path coverage for invalid config/inputs.

Verification:
```
cargo test tests::test_parse_cli_screenshot_args -- --nocapture
cargo llvm-cov --workspace --all-targets --json --output-path wrk_docs/coverage-stage3.json --ignore-filename-regex "target/llvm-cov-target"
```

## Stage 4 - Final Gap Sweep
**Target:** Overall `src/` line coverage >= 98%.

Actions:
- Review `wrk_docs/coverage-latest-missing.txt` for any remaining line clusters.
- Add minimal, behavior-anchored tests for any remaining uncovered blocks (focus on app.rs and renderer edge branches).
- Rerun coverage after each set of tests.

Verification:
```
cargo llvm-cov --workspace --all-targets --json --output-path wrk_docs/coverage-final.json --ignore-filename-regex "target/llvm-cov-target"
```

## Notes
- Avoid fragile UI tests; prefer deterministic unit tests with egui contexts and synthetic input.
- Keep tests focused (AAA structure), one behavior per test.
- Do not relax coverage by excluding first-party source files.
