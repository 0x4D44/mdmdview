# PLN: Windows MSI Installer Implementation

**Date:** 2026-02-09
**Design:** `2026.02.09 - HLD - Windows MSI Installer V4.md`

---

## Stage 1: License & Cargo Metadata

**Goal:** Add MIT license file and update Cargo.toml metadata. No tooling required.

### Actions

1. Create `LICENSE` at repo root with standard MIT license text:
   - Copyright year: 2025 (project inception year)
   - Copyright holder: Martin Davidson

2. Edit `Cargo.toml` -- update `[package]` fields:
   ```toml
   description = "A markdown viewer for Windows"
   authors = ["Martin Davidson <martingdavidson@gmail.com>"]
   license = "MIT"
   ```

3. Add `[package.metadata.wix]` section to `Cargo.toml`:
   ```toml
   [package.metadata.wix]
   product-icon = "icon.ico"
   ```
   Note: `upgrade-guid` will be added in Stage 2 after `cargo wix init` generates it.

### Verification

- `cargo build` succeeds (metadata changes don't break anything)
- `LICENSE` file exists at repo root

### Commit

Commit `LICENSE` and `Cargo.toml` changes: `"feat: add MIT license and update package metadata for MSI installer"`

---

## Stage 2: WiX Scaffolding

**Goal:** Install prerequisites and generate the WiX template files. The UpgradeCode GUID is established here and must be committed immediately.

### Prerequisites (manual, one-time)

1. **Install WiX Toolset v3.14.1:**
   - Download `wix314.exe` from https://github.com/wixtoolset/wix3/releases
   - Run installer (sets `WIX` env var automatically)
   - Verify: `where candle.exe` should resolve
   - Open a **new terminal** after install (env var needs to be picked up)

2. **Install cargo-wix:**
   ```bash
   cargo install cargo-wix
   ```

### Actions

1. Run `cargo wix init` from the project root
   - Generates `wix/main.wxs` with a unique UpgradeCode GUID
   - Generates `wix/License.rtf` from the MIT template (because `license = "MIT"` is in Cargo.toml)

2. Copy the `UpgradeCode` GUID from the generated `wix/main.wxs` into `Cargo.toml`:
   ```toml
   [package.metadata.wix]
   upgrade-guid = "<GUID-from-main.wxs>"
   product-icon = "icon.ico"
   ```

### Verification

- `wix/main.wxs` exists and contains a valid `UpgradeCode` GUID
- `wix/License.rtf` exists and contains MIT license text
- Sanity-check: `cargo wix` produces an MSI (default template, not yet customized)
  - Output: `target/wix/mdmdview-<version>-x86_64.msi`
  - Can double-click the MSI to verify it opens the wizard (cancel -- don't install yet)

### Commit

Commit `wix/main.wxs`, `wix/License.rtf`, and `Cargo.toml`: `"feat: add WiX installer scaffolding with stable UpgradeCode"`

**Critical:** This commit locks the UpgradeCode GUID. Never regenerate `wix/main.wxs` from scratch after this point.

---

## Stage 3: Customize WXS

**Goal:** Modify the generated `wix/main.wxs` to match the HLD V4 design: flat directory, file associations, Start Menu shortcut, WixUI_Minimal.

### Actions

Work through these changes to `wix/main.wxs`, referencing HLD V4 section 6:

1. **Update Product metadata** (HLD 6.1):
   - Set `Manufacturer='Martin Davidson'`
   - Verify `Name='mdmdview'`

2. **Update Package description** (HLD 6.2):
   - Set `Description='Markdown viewer for Windows'`
   - Set `Manufacturer='Martin Davidson'`

3. **Flatten directory structure** (HLD 6.3):
   - Remove the `<Directory Id='Bin' Name='bin'>` nesting
   - Move the binary Component (`binary0`) directly into `APPLICATIONFOLDER`
   - Keep the `PlatformProgramFilesFolder` preprocessor conditional as-is

4. **Remove PATH component and Environment sub-Feature**:
   - Delete the `<Component Id='Path' ...>` element (contains `<Environment>` for PATH)
   - Delete the `<Feature Id='Environment' ...>` sub-feature and its `<ComponentRef Id='Path'/>`

5. **Add file associations to binary component** (HLD 6.4):
   - Inside `<Component Id='binary0'>`, after the `<File>` element, add:
     ```xml
     <ProgId Id='mdmdview.MarkdownFile'
         Description='Markdown Document'
         Icon='exe0' IconIndex='0'>
         <Extension Id='md' ContentType='text/markdown'>
             <Verb Id='open_md' Command='Open' TargetFile='exe0' Argument='"%1"' />
         </Extension>
         <Extension Id='markdown' ContentType='text/markdown'>
             <Verb Id='open_markdown' Command='Open' TargetFile='exe0' Argument='"%1"' />
         </Extension>
     </ProgId>
     ```

6. **Add License file component** (HLD 6.5):
   - Inside `APPLICATIONFOLDER` directory, add:
     ```xml
     <Component Id='License' Guid='*'>
         <File Id='LicenseFile' Name='LICENSE' DiskId='1' Source='LICENSE' KeyPath='yes'/>
     </Component>
     ```

7. **Add Start Menu directory and shortcut component** (HLD 6.3, 6.6):
   - Add `ProgramMenuFolder` directory structure under `TARGETDIR`:
     ```xml
     <Directory Id='ProgramMenuFolder' Name='Programs'>
         <Directory Id='ApplicationProgramsFolder' Name='mdmdview'/>
     </Directory>
     ```
   - Add shortcut component (can be placed after the APPLICATIONFOLDER directory block):
     ```xml
     <Component Id='ApplicationShortcut' Guid='*' Directory='ApplicationProgramsFolder'>
         <Shortcut Id='ApplicationStartMenuShortcut'
             Name='mdmdview' Description='Markdown Viewer'
             Target='[#exe0]' WorkingDirectory='APPLICATIONFOLDER'
             Icon='ProductICO' />
         <RemoveFolder Id='CleanUpShortcutFolder'
             Directory='ApplicationProgramsFolder' On='uninstall'/>
         <RegistryValue Root='HKCU' Key='Software\mdmdview\Installer'
             Name='StartMenuShortcut' Type='integer' Value='1' KeyPath='yes'/>
     </Component>
     ```

8. **Update Feature tree** (HLD 6.7):
   - Rename the main Feature `Id` to `'Complete'`
   - Set `Absent='disallow'` (required)
   - Ensure ComponentRefs: `binary0`, `License`, `ApplicationShortcut`
   - Remove the PATH sub-Feature (already deleted in step 4)

9. **Update Add/Remove Programs** (HLD 6.8):
   - Verify `<Icon Id='ProductICO' SourceFile='icon.ico'/>` is present
   - Set `<Property Id='ARPHELPLINK' Value='https://github.com/0x4D44/mdmdview'/>`
   - Keep existing `ARPPRODUCTICON` and `ARPINSTALLLOCATION` properties

10. **Switch to WixUI_Minimal** (HLD 6.9):
    - Replace `<UIRef Id='WixUI_FeatureTree'/>` with `<UIRef Id='WixUI_Minimal'/>`
    - Ensure `<WixVariable Id='WixUILicenseRtf' Value='wix\License.rtf'/>` is present
    - Remove any `<Publish>` overrides for EULA skipping (not needed with Minimal)

### Verification

- `cargo wix` succeeds -- produces `target/wix/mdmdview-<version>-x86_64.msi`
- No candle.exe or light.exe errors

### Commit

Commit `wix/main.wxs`: `"feat: customize WiX installer with file associations, Start Menu shortcut, and flat layout"`

---

## Stage 4: Manual Testing

**Goal:** Verify the MSI works end-to-end on a real system.

### Actions

Build the MSI:
```bash
cargo wix
```

Run through the test checklist from HLD V4 section 9:

| # | Test | Expected Result | Pass? |
|---|------|----------------|-------|
| 1 | Double-click `.msi` | UAC prompt, then: Welcome (MIT license) -> Install -> Finish | |
| 2 | Check `C:\Program Files\mdmdview\` | `mdmdview.exe` and `LICENSE` present | |
| 3 | Start Menu search "mdmdview" | Shortcut present; launches app correctly | |
| 4 | Right-click `.md` file -> Open With | "mdmdview" appears as an option | |
| 5 | Double-click `.md` file | Opens in mdmdview (if set as default) | |
| 6 | Settings -> Apps -> "mdmdview" | Entry with correct icon, version, Uninstall button | |
| 7 | `msiexec /i mdmdview.msi /qn` | Silent install succeeds | |
| 8 | Install newer version over old | Old version removed, new installed, settings preserved | |
| 9 | Uninstall via Add/Remove Programs | Files, shortcuts, registry cleaned; `HKCU\Software\MarkdownView` preserved | |

### Fixing Issues

If any test fails, fix the WXS and rebuild (`cargo wix`). The most likely issues:
- **File not found errors in light.exe**: Source paths wrong (check relative to project root)
- **Shortcut doesn't appear**: ComponentRef missing from Feature
- **File association not registered**: ProgId/Extension XML structure wrong
- **License dialog blank**: License.rtf missing or corrupt

### Commit

If any fixes were needed in Stage 3, amend the WXS commit or create a fix commit.

---

## Stage 5: CI/CD Integration

**Goal:** Update GitHub Actions release workflow to produce MSI alongside the existing ZIP.

### Actions

Edit `.github/workflows/release.yml`:

1. Add WiX install step after "Cache cargo build", before "Build release":
   ```yaml
   - name: Install WiX Toolset
     shell: pwsh
     run: |
       Invoke-WebRequest -Uri "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314.exe" -OutFile wix314.exe
       Start-Process -Wait -FilePath .\wix314.exe -ArgumentList '/install','/quiet','/norestart'

   - name: Install cargo-wix
     run: cargo install cargo-wix
   ```

2. Add MSI build step after "Build release":
   ```yaml
   - name: Build MSI installer
     run: cargo wix --no-build
   ```

3. Update "Package artifact" step to include MSI:
   ```yaml
   - name: Package artifacts
     shell: pwsh
     run: |
       New-Item -ItemType Directory -Force -Path dist | Out-Null
       Copy-Item target/release/mdmdview.exe dist/mdmdview.exe
       Compress-Archive -Path dist/mdmdview.exe -DestinationPath "mdmdview-${{ github.ref_name }}-windows-x86_64.zip"
       Copy-Item target/wix/*.msi "mdmdview-${{ github.ref_name }}-windows-x86_64.msi"
   ```

4. Update "Upload artifact" to include both:
   ```yaml
   - name: Upload artifacts
     uses: actions/upload-artifact@v4
     with:
       name: mdmdview-Windows
       path: |
         mdmdview-${{ github.ref_name }}-windows-x86_64.zip
         mdmdview-${{ github.ref_name }}-windows-x86_64.msi
   ```

5. Update release job's `files:` glob to pick up MSI:
   ```yaml
   files: |
     artifacts/*.zip
     artifacts/*.msi
   ```

### Verification

- Push a test tag or use `workflow_dispatch` to trigger the pipeline
- Verify both ZIP and MSI appear as release artifacts
- Download the MSI from the release and verify it installs correctly

### Commit

Commit `release.yml`: `"ci: add MSI installer to release pipeline"`

---

## Stage 6: Documentation

**Goal:** Update project documentation with MSI build instructions.

### Actions

1. Add to `CLAUDE.md` under "Build Commands":
   ```
   # Build MSI installer (requires WiX Toolset v3 + cargo-wix)
   cargo wix                    # full: build release + create MSI
   cargo wix --no-build         # MSI only (if release binary already built)
   ```

2. Add a brief "Installer" subsection to `CLAUDE.md` architecture section noting:
   - WiX source in `wix/main.wxs` (never regenerate -- contains stable UpgradeCode GUID)
   - `cargo-wix` and WiX Toolset v3.14.1 required for MSI builds
   - Output: `target/wix/mdmdview-<version>-x86_64.msi`

### Verification

- Read CLAUDE.md, verify instructions are clear and correct

### Commit

Commit `CLAUDE.md`: `"docs: add MSI installer build instructions"`

---

## Summary

| Stage | What | Files Touched | Can Be Committed Independently |
|-------|------|---------------|-------------------------------|
| 1 | License + metadata | `LICENSE`, `Cargo.toml` | Yes |
| 2 | WiX scaffolding | `wix/main.wxs`, `wix/License.rtf`, `Cargo.toml` | Yes |
| 3 | Customize WXS | `wix/main.wxs` | Yes |
| 4 | Manual testing | (none -- test only) | N/A |
| 5 | CI/CD | `.github/workflows/release.yml` | Yes |
| 6 | Documentation | `CLAUDE.md` | Yes |

Stages 1-3 are the core work. Stage 4 is manual verification. Stages 5-6 are polish.

Total new files: 3 (`LICENSE`, `wix/main.wxs`, `wix/License.rtf`).
Modified files: 3 (`Cargo.toml`, `.github/workflows/release.yml`, `CLAUDE.md`).
