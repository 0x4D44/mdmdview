# egui Link Click Event Research

**Date:** 2026-02-05
**Issue:** Links in mdmdview show hover state (pointing hand cursor) but clicks do not trigger navigation

## 1. Current Implementation

### Link Rendering (markdown_renderer.rs:2892-2951)

Two paths exist for rendering links:

**Simple text links (no emoji):**
```rust
let r = ui.add(egui::Link::new(rich));
if render_action_triggered(r.clicked(), "link_click") {
    self.trigger_link(url);
}
```

**Links with emoji:**
```rust
let group = ui.scope(|ui| {
    self.render_text_with_emojis(ui, &fixed_text, size, style);
});
let r = ui.interact(group.response.rect, id, egui::Sense::click());
if render_action_triggered(r.clicked(), "link_click") {
    self.trigger_link(url);
}
```

### Layout Hierarchy

```
ScrollArea (app.rs:2518)
  └── CentralPanel
        └── render_to_ui()
              └── Frame (for element rect tracking)
                    └── render_inline_spans()
                          └── horizontal_wrapped (line 2747)
                                └── render_inline_span()
                                      └── egui::Link or ui.interact()
```

## 2. How egui Click Detection Should Work

### egui::Link Widget
- Built-in widget specifically for clickable text
- Automatically configures `Sense::click()`
- Returns `Response` with `.clicked()` method
- `.clicked()` returns `true` for exactly ONE frame when clicked

### ScrollArea Event Handling
- Transforms mouse coordinates relative to scroll offset
- Should pass click events through to child widgets
- Only consumes events on scrollbar area

### Response Timing
- `.clicked()` MUST be called in the same frame as rendering
- The response is only valid for the current frame
- Click state is cleared after frame completes

## 3. What We've Tried

| Approach | Result |
|----------|--------|
| `ui.horizontal_wrapped` + `ui.interact()` | Hover works, click fails |
| `ui.scope` + `ui.interact()` | Hover works, click fails |
| `egui::Label::sense(Sense::click())` | Hover works, click fails |
| `egui::Link` widget | Hover works, click fails |

## 4. Evidence That Click Detection IS Failing

Debug output added:
```rust
if r.clicked() {
    eprintln!("[DEBUG] Link clicked: {}", url);
}
```
**Result:** No debug output appears when clicking links.

This confirms `r.clicked()` returns `false` even when:
- Hover state works (cursor changes to pointing hand)
- The widget is visually responding to mouse presence

## 5. Potential Root Causes

### A. ScrollArea Consuming Clicks
- The ScrollArea might be consuming primary click for scroll/selection
- egui 0.27 ScrollArea has sophisticated event handling
- Need to check if `scroll_area.show()` has any flags affecting this

### B. Nested Layout Interference
- `horizontal_wrapped` creates a sub-UI context
- Events might not propagate correctly through nested contexts
- egui's immediate mode means each frame rebuilds the widget tree

### C. Event Order/Timing
- Click events processed before widget rendering completes
- Response captured too late in the frame
- Widget ID conflicts causing event misrouting

### D. Platform-Specific Issues
- Windows-specific event handling
- GPU backend (glow) event processing
- Window focus/activation state

## 6. Comparison: What DOES Work

### Menu Buttons (app.rs)
```rust
let clicked = ui.add(egui::Button::new(...)).clicked();
if clicked {
    self.open_file_dialog();
}
```
- These work because menus render in overlay/popup context
- Not inside ScrollArea

### Welcome Screen Button (app.rs:2544)
```rust
if ui.button("Open File").clicked() {
    self.open_file_dialog();
}
```
- This IS inside ScrollArea
- Simple `ui.button()` works
- No nested `horizontal_wrapped` container

### Code Block Context Menus
- Use `.context_menu()` pattern
- Context menus trigger on right-click (different event path)
- Work correctly

## 7. Key Insight from Test Infrastructure

The test code uses `ForcedRenderActions`:
```rust
let _guard = ForcedRenderActions::new(&["link_hover", "link_click"]);
```

This exists specifically to FORCE click detection in tests, suggesting:
1. The developers knew clicks might not naturally propagate
2. Tests bypass normal click detection
3. The production click path may have always been broken or fragile

## 8. Areas Requiring Further Investigation

1. **ScrollArea Configuration**
   - Check `scroll_area.auto_shrink()`, `.drag_to_scroll()` settings
   - These might affect click passthrough

2. **Frame/Rect Tracking**
   - The `element_rects` tracking wraps elements in Frame
   - Frame might interfere with event propagation

3. **horizontal_wrapped Behavior**
   - Compare with direct `ui.add()` without wrapping
   - Test if removing horizontal_wrapped fixes clicks

4. **egui Version**
   - Current: egui 0.27
   - Check egui changelog for click handling changes
   - Look for known issues in 0.27

5. **Response Chaining**
   - Check if `.context_menu()` affects click detection
   - Verify response is used correctly

## 9. References

- ScrollArea setup: `src/app.rs:2518-2528`
- Link rendering: `src/markdown_renderer.rs:2892-2951`
- Inline span layout: `src/markdown_renderer.rs:2747-2753`
- Test infrastructure: `src/markdown_renderer.rs:56-76`
- egui version: `Cargo.toml` (egui = "0.27")
