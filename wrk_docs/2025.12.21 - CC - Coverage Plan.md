# Coverage Improvement Plan - 2025.12.21

## Stage 1 - Low-Effort Unit Coverage (utilities)
Goal: lift foundational modules to full coverage and remove 0% files.
- Add unit tests for `src/emoji_assets.rs` to exercise each emoji path and verify non-transparent pixels.
- Add unit tests for `src/emoji_catalog.rs` to validate shortcode mappings and embedded bytes.
- Add unit tests for `src/window_state.rs` covering sanitize behavior and file-based save/load (use temp dirs + env overrides; avoid registry in tests).
- Add a test for `configure_egui_style` in `src/main.rs` to validate spacing + dark-mode overrides.
- Expand `src/table_support/metrics.rs` tests for additional branch coverage (resize behavior, threshold handling).

## Stage 2 - MarkdownRenderer Coverage Expansion
Goal: exercise parsing and rendering paths with rich markdown inputs.
- Create a test harness that builds an `egui::Context`, runs a frame, and calls `MarkdownRenderer::render_to_ui`.
- Add a comprehensive markdown sample that triggers headers, lists, code blocks, tables, blockquotes, inline formatting, emojis/shortcodes, images, links, footnotes, and horizontal rules.
- Add tests for cache behavior (`table_layout_cache_stats`, `clear_table_layout_cache`), highlight rendering, emoji fallback generation, and image placeholder handling.
- Add targeted tests for error/edge branches (empty text, missing images, invalid URLs, excessive table widths).

## Stage 3 - MarkdownViewerApp UI/State Coverage
Goal: exercise update paths and UI-related helpers without needing a real `eframe::Frame`.
- Refactor `update` to call a new `update_inner(&Context)` method; use this in tests.
- Extract menu/context-menu bodies into helper functions so tests can call them directly.
- Add tests for rendered vs raw view paths, search dialog interaction (query change, next/prev), drag/drop queue handling, and navigation requests.
- Add test-only stubs for OS/UI integrations that cannot run headless (file dialog, registry persistence, external browser) to keep tests deterministic.

## Stage 4 - Gap Closure and 98% Target
Goal: reach >=98% overall line coverage.
- Re-run `cargo llvm-cov --workspace --all-targets --summary-only --json` after each stage.
- Use `--show-missing-lines` to identify remaining uncovered lines and add targeted tests.
- Ensure no large untested blocks remain in `src/app.rs` or `src/markdown_renderer.rs`.

## Validation
- Coverage command to standardize on after updates:
  `cargo llvm-cov --workspace --all-targets --summary-only --json --output-path wrk_docs/coverage-latest.json --ignore-filename-regex "target/llvm-cov-target"`
