# HLD - Mermaid Renderer Completion

Date: 2025.12.29
Status: Draft

## Summary
The core embedded Mermaid renderer is implemented (QuickJS execution, DOM shim, worker pool, rasterization, caching, and config merge). Completion now focuses on build defaults, explicit capability handling, optional Kroki gating, and stronger validation so embedded rendering is the standard, offline path.

## Progress Review (Current State)
- Renderer module exists and owns UI integration, worker pools, caching, and error handling: `src/mermaid_renderer.rs`.
- Markdown integration delegates Mermaid blocks to the renderer: `src/markdown_renderer.rs`.
- Embedded Mermaid JS is vendored and embedded at build time: `assets/vendor/mermaid.min.js`, `build.rs`.
- Embedded QuickJS path is implemented behind `mermaid-quickjs` feature, with DOM shim and strict defaults.
- Kroki path is still compiled in and is opt-in via `MDMDVIEW_ENABLE_KROKI`.
- README documents embedded rendering and env vars.
- Prior plan stages 0-4 appear complete; stage 5 docs are partially updated; stage 6 validation coverage remains incomplete.

## Completion Goals
- Embedded renderer is the default build and runtime choice (offline by default).
- Kroki remains an optional, explicit feature and runtime opt-in.
- Renderer selection behavior is deterministic and correctly reports capability gaps.
- Validation covers QuickJS path and regression artifacts for Mermaid diagrams.
- Documentation and samples reflect the new defaults and licensing requirements.

## Remaining Gaps
1. Build defaults still exclude `mermaid-quickjs`, so embedded is not the default.
2. Kroki is not feature-gated; `ureq` is always compiled in.
3. Renderer selection does not explicitly handle "embedded requested but not compiled".
4. QuickJS rendering has limited test coverage (no end-to-end render assertion).
5. Regression harness does not explicitly validate Mermaid output against known references.
6. Mermaid asset license is not clearly documented or included alongside the vendor file.
7. Sample file text still describes Mermaid as feature-gated.

## Proposed Design Changes

### 1) Build Defaults and Feature Model
- Add a new feature alias `mermaid-embedded` -> `mermaid-quickjs`.
- Set `[features] default = ["mermaid-embedded"]` so embedded is the standard build.
- Introduce `mermaid-kroki` feature that enables Kroki support and the `ureq` dependency.
- Make `ureq` optional and only compile Kroki code when `mermaid-kroki` is enabled.

Rationale:
- Matches the original goal of offline rendering by default.
- Keeps network code and dependencies out of default builds.
- Preserves a debugging fallback when explicitly requested.

### 2) Renderer Selection Semantics
- Add a capability check in renderer selection:
  - If `MDMDVIEW_MERMAID_RENDERER=embedded` but QuickJS is not compiled or the embedded JS is missing, show a clear message and fall back to source rendering (not Kroki) unless Kroki is explicitly selected.
  - If `MDMDVIEW_MERMAID_RENDERER=kroki` but `mermaid-kroki` is not compiled, show a message and fall back to source.
- Update the renderer preference function to incorporate compile-time support (embedded, kroki).

### 3) Licensing and Asset Hygiene
- Add a Mermaid license file under `assets/vendor/` (or a top-level THIRD_PARTY_NOTICES.md) and reference it in README.
- Keep the build script assertion soft (asset missing yields empty bytes), but add a warning in README and a test that asserts non-empty bytes when the embedded feature is enabled.

### 4) Validation and Regression Coverage
- Add QuickJS integration tests (feature-gated) that render:
  - flowchart
  - sequence diagram
  - class diagram
  Each test should assert non-empty SVG and successful rasterization.
- Add a regression harness step that renders `tests/regression/cases/008-mermaid.md` with embedded renderer and stores baseline images and JSON metadata.
- Ensure the harness runs with `MDMDVIEW_MERMAID_RENDERER=embedded` and `MDMDVIEW_ENABLE_KROKI=0`.

### 5) Documentation and Samples
- Update README to reflect embedded renderer as the default, and Kroki as optional.
- Update `src/sample_files.rs` to remove "feature-gated" language.
- Document the new features and env var behavior in README.

## Risks and Mitigations
- Binary size increase due to QuickJS and Mermaid JS: mitigate by keeping Kroki optional and documenting size impact.
- QuickJS rendering drift across Mermaid versions: pin the vendored version and record it in docs.
- Additional CI time for QuickJS tests: gate tests behind feature and run in a separate job.

## Out of Scope
- Upgrading text measurement to a full Rust-backed font pipeline.
- Interactive Mermaid diagrams (links, hover behaviors).
- Fetching external icon packs at runtime.

## Open Questions
- Should we enforce a build-time error (instead of a warning) if `mermaid-quickjs` is enabled but the JS asset is missing?
- Should the default build include Kroki as well, or keep it off to minimize network exposure?
- Do we want a UI toggle for renderer selection, or keep env vars only?
