# HLD - Mermaid Renderer Completion

Date: 2025.12.29
Status: Draft

## Summary

## Progress Review (Current State)
- Renderer module exists and owns UI integration, worker pools, caching, and error handling: `src/mermaid_renderer.rs`.
- Markdown integration delegates Mermaid blocks to the renderer: `src/markdown_renderer.rs`.
- Embedded Mermaid JS is vendored and embedded at build time: `assets/vendor/mermaid.min.js`, `build.rs`.
- Embedded QuickJS path is implemented behind `mermaid-quickjs` feature, with DOM shim and strict defaults.
- README documents embedded rendering and env vars.
- Prior plan stages 0-4 appear complete; stage 5 docs are partially updated; stage 6 validation coverage remains incomplete.

## Completion Goals
- Embedded renderer is the default build and runtime choice (offline by default).
- Renderer selection behavior is deterministic and correctly reports capability gaps.
- Validation covers QuickJS path and regression artifacts for Mermaid diagrams.
- Documentation and samples reflect the new defaults and licensing requirements.

## Remaining Gaps
1. Build defaults still exclude `mermaid-quickjs`, so embedded is not the default.
3. Renderer selection does not explicitly handle "embedded requested but not compiled".
4. QuickJS rendering has limited test coverage (no end-to-end render assertion).
5. Regression harness does not explicitly validate Mermaid output against known references.
6. Mermaid asset license is not clearly documented or included alongside the vendor file.
7. Sample file text still describes Mermaid as feature-gated.

## Proposed Design Changes

### 1) Build Defaults and Feature Model
- Add a new feature alias `mermaid-embedded` -> `mermaid-quickjs`.
- Set `[features] default = ["mermaid-embedded"]` so embedded is the standard build.

Rationale:
- Matches the original goal of offline rendering by default.
- Keeps network code and dependencies out of default builds.
- Preserves a debugging fallback when explicitly requested.

### 2) Renderer Selection Semantics
- Add a capability check in renderer selection:

### 3) Licensing and Asset Hygiene
- Add a Mermaid license file under `assets/vendor/` (or a top-level THIRD_PARTY_NOTICES.md) and reference it in README.
- Keep the build script assertion soft (asset missing yields empty bytes), but add a warning in README and a test that asserts non-empty bytes when the embedded feature is enabled.

### 4) Validation and Regression Coverage
- Add QuickJS integration tests (feature-gated) that render:
  - flowchart
  - sequence diagram
  - class diagram
  Each test should assert non-empty SVG and successful rasterization.
- Add a regression harness step that renders `tests/regression/cases/008-mermaid.md` with embedded renderer and stores baseline images and JSON metadata.

### 5) Documentation and Samples
- Update `src/sample_files.rs` to remove "feature-gated" language.
- Document the new features and env var behavior in README.

## Risks and Mitigations
- QuickJS rendering drift across Mermaid versions: pin the vendored version and record it in docs.
- Additional CI time for QuickJS tests: gate tests behind feature and run in a separate job.

## Out of Scope
- Upgrading text measurement to a full Rust-backed font pipeline.
- Interactive Mermaid diagrams (links, hover behaviors).
- Fetching external icon packs at runtime.

## Open Questions
- Should we enforce a build-time error (instead of a warning) if `mermaid-quickjs` is enabled but the JS asset is missing?
- Do we want a UI toggle for renderer selection, or keep env vars only?
