# HLD: Light/Dark Mode Toggle — V2

**Date:** 2026-02-09
**Status:** Draft
**Author:** Arthur + Claude
**Previous:** V1 — initial design
**Changes in V2:** Fixed 5 issues found during critical review (see Section 12)

## 1. Problem Statement

mdmdview is dark-mode only. Lawyers need light mode. The app has ~30 theme-critical hardcoded color sites across 4 files. We need a runtime toggle with persistence.

## 2. Requirements

1. **Toggle**: Status bar button + `Ctrl+Shift+T` shortcut
2. **Persistence**: Theme preference survives restart
3. **Complete**: All elements correct in both modes
4. **Default**: New installs default to dark mode
5. **Minimal disruption**: Don't change `MarkdownRenderer::new()` signature (222 test call sites)

## 3. Scope Analysis

### 3.1 Color Audit Summary

**Theme-critical** (~30 sites needing light/dark variants):

| Category | File | Lines | Dark Colors |
|----------|------|-------|-------------|
| External links | markdown_renderer.rs | 743, 2905 | `(120, 190, 255)` |
| Internal links | markdown_renderer.rs | 745, 2907 | `LIGHT_BLUE` |
| Inline code | markdown_renderer.rs | 872, 2844 | bg `(30,30,30)` / fg `(180,255,180)` |
| Blockquote | markdown_renderer.rs | 2643-2669 | bg `(24,24,24)`, border `(40,40,40)`, text WHITE, bar `(255,103,25)` |
| Code blocks | markdown_renderer.rs | 2964-2973, 3902-3972 | bg `(25-30,25-30,25-30)`, border `(60,60,60)`, label `(140-150,140-150,140-150)`, fallback `(220,220,220)` |
| Syntect theme | markdown_renderer.rs | 5778 | `"base16-ocean.dark"` |
| Mermaid boxes | mermaid_renderer.rs | 769-1009 (×6) | bg `(25,25,25)`, border `(60,60,60)`, title `(200,160,80)`, body `(180,180,180)` |
| Status accents | app.rs | 2131-2145 | loading `(120,200,255)`, queue `(100,150,255)`, hint GRAY |

**Already theme-aware** (no changes): search highlighting, table dividers, list markers, menu text, `configure_egui_style()`.

**Theme-independent** (no changes): emoji fallback colors, `Color32::RED` error labels, drag overlay, `Color32::WHITE` in `layout_no_wrap()` width-measurement calls (color parameter irrelevant for measurement).

### 3.2 Syntax Highlighting: Parse-Time Baking

Syntect highlighting happens at **parse time** — colors are baked into `MarkdownElement::CodeBlock.highlighted`. Theme toggle requires re-parsing. This is fast (in-memory, no I/O) but `parse()` returns `Result<Vec<MarkdownElement>, anyhow::Error>` — error must be handled.

### 3.3 Code Block Color Unification

V1's ThemeColors uses a single `code_bg` value `(30,30,30)` but the current code has TWO:
- Non-highlighted code blocks: `(30, 30, 30)` (line 2972)
- Highlighted code blocks: `(25, 25, 25)` (line 3902)

Similarly, code labels: `(140,140,140)` (line 2964) vs `(150,150,150)` (line 3911).

**Decision:** Unify to single values: bg `(30,30,30)`, label `(140,140,140)`. The 5-10 unit differences were likely accidental, not intentional. This is a minor normalization, not a regression.

## 4. Design

### 4.1 Architecture

```
ThemeColors::current(dark_mode) ──→ Returns &'static palette
      Used by: markdown_renderer, mermaid_renderer, app (status bar)

AppSettings.dark_mode ──→ Persisted in settings.txt + Windows registry
      Loaded at startup, saved on toggle

Toggle flow:
  1. Flip settings.dark_mode
  2. ctx.set_visuals(dark/light)
  3. Re-apply true-black overrides if dark (via shared helper)
  4. renderer.set_dark_mode()
  5. Re-parse content (handles Result)
  6. Save settings
```

### 4.2 ThemeColors (`src/theme.rs` — NEW)

```rust
use egui::Color32;

pub struct ThemeColors {
    pub link: Color32,
    pub link_internal: Color32,
    pub code_bg: Color32,
    pub code_border: Color32,
    pub code_label: Color32,
    pub code_fallback_text: Color32,
    pub inline_code_bg: Color32,
    pub inline_code_fg: Color32,
    pub blockquote_bg: Color32,
    pub blockquote_border: Color32,
    pub blockquote_text: Color32,
    pub blockquote_bar: Color32,
    pub box_bg: Color32,
    pub box_border: Color32,
    pub box_title: Color32,
    pub box_body: Color32,
    pub status_loading: Color32,
    pub status_queue: Color32,
    pub status_hint: Color32,
}

impl ThemeColors {
    pub const DARK: Self = Self { /* current hardcoded values */ };
    pub const LIGHT: Self = Self { /* new light values */ };

    pub fn current(dark_mode: bool) -> &'static Self {
        if dark_mode { &Self::DARK } else { &Self::LIGHT }
    }

    pub fn syntect_theme(dark_mode: bool) -> &'static str {
        if dark_mode { "base16-ocean.dark" } else { "InspiredGitHub" }
    }
}
```

See Section 5 for full color table.

### 4.3 AppSettings Persistence (`src/window_state.rs`)

- Add `dark_mode: bool` to `AppSettings`
- Manual `Default` impl: `dark_mode: true` (derive gives `false`)
- File: parse/write `dark_mode=0|1`
- Registry: `DarkMode` DWORD, default `1`
- Backward compatible: missing key → default true

### 4.4 MarkdownRenderer Changes (`src/markdown_renderer.rs`)

- Add `dark_mode: bool` field (default `true` in `new()`, signature unchanged)
- Add `pub fn set_dark_mode(&mut self, dark: bool)` setter
- Replace ~12 hardcoded color sites with `ThemeColors::current(ui.visuals().dark_mode)`
- Syntect theme: `&self.theme_set.themes[ThemeColors::syntect_theme(self.dark_mode)]`

### 4.5 Mermaid Renderer Changes (`src/mermaid_renderer.rs`)

Replace ~6 error/info box color sites with `ThemeColors::current(ui.visuals().dark_mode)`.

Note: Actual rendered mermaid diagram images (from QuickJS) are theme-independent — they use mermaid.js's own theme, controlled by `MDMDVIEW_MERMAID_BG` env var. No cache invalidation needed on app theme toggle.

### 4.6 App Toggle (`src/app.rs`)

**Signature change:** `render_status_bar(&self, ctx)` → `render_status_bar(&mut self, ctx)`

The current `&self` signature prevents setting `theme_toggle_requested`. Since `render_menu_bar` already takes `&mut self` and both are called from `update(&mut self)`, this is a safe one-word change. All test call sites already use `let mut app`.

**Struct changes:**
- Replace `allow_remote_images: bool` with `settings: AppSettings`
- Add `theme_toggle_requested: bool`

**Status bar toggle** (rightmost in right-to-left layout):
```rust
let label = if self.settings.dark_mode { "Dark" } else { "Light" };
if ui.small_button(label).clicked() {
    self.theme_toggle_requested = true;
}
```

**Keyboard shortcut** (in `handle_shortcuts()`): `Ctrl+Shift+T`

**toggle_theme():**
```rust
fn toggle_theme(&mut self, ctx: &egui::Context) {
    self.settings.dark_mode = !self.settings.dark_mode;
    apply_dark_mode_visuals(ctx, self.settings.dark_mode);
    self.renderer.set_dark_mode(self.settings.dark_mode);
    if !self.current_content.is_empty() {
        match self.renderer.parse(&self.current_content) {
            Ok(elements) => self.parsed_elements = elements,
            Err(e) => self.error_message = Some(format!("Re-parse failed: {e}")),
        }
    }
    let _ = save_app_settings(&self.settings);
}
```

### 4.7 Shared Visuals Helper — DRY Fix

The true-black overrides currently live in `configure_egui_style()` (main.rs:451-456). The toggle needs the same logic. Instead of duplicating, extract a shared helper:

```rust
/// Apply dark or light visuals. Dark mode gets true-black overrides.
pub fn apply_dark_mode_visuals(ctx: &egui::Context, dark: bool) {
    let mut style = (*ctx.style()).clone();
    style.visuals = if dark {
        egui::Visuals::dark()
    } else {
        egui::Visuals::light()
    };
    if dark {
        style.visuals.window_fill = Color32::BLACK;
        style.visuals.panel_fill = Color32::BLACK;
        style.visuals.faint_bg_color = Color32::from_gray(20);
        style.visuals.extreme_bg_color = Color32::BLACK;
    }
    ctx.set_style(style);
}
```

This clones the CURRENT style (preserving spacing/rounding) and only replaces the visuals. Used by both:
- `configure_egui_style()` in main.rs → replaced with call to this helper
- `toggle_theme()` in app.rs → calls this helper

Location: `src/theme.rs` (alongside ThemeColors), or as a public function on `MarkdownViewerApp`.

### 4.8 Startup Theme (`src/main.rs`)

```rust
let mut app = MarkdownViewerApp::new();

// Apply saved theme ONLY when no explicit --theme flag was passed
if resolved_theme.is_none() {
    app.apply_saved_theme(&cc.egui_ctx);
}
```

This prevents the saved preference from overriding explicit CLI `--theme` flags (used for screenshots). When `resolved_theme` is `Some(...)`, the theme was already set at lines 318-331 and should not be overridden.

### 4.9 Module Registration (`src/lib.rs`)

```rust
pub mod theme;
pub use theme::ThemeColors;
```

## 5. Light Mode Color Palette

| Name | Dark | Light | Rationale |
|------|------|-------|-----------|
| link | `(120, 190, 255)` | `(0, 102, 204)` | Standard web blue |
| link_internal | `(135, 206, 250)` | `(0, 80, 180)` | Slightly darker than external |
| code_bg | `(30, 30, 30)` | `(245, 245, 245)` | GitHub-style |
| code_border | `(60, 60, 60)` | `(210, 210, 210)` | Subtle |
| code_label | `(140, 140, 140)` | `(120, 120, 120)` | Muted |
| code_fallback_text | `(220, 220, 220)` | `(50, 50, 50)` | High contrast |
| inline_code_bg | `(30, 30, 30)` | `WHITE` | Clean |
| inline_code_fg | `(180, 255, 180)` | `(60, 80, 150)` | Already existed |
| blockquote_bg | `(24, 24, 24)` | `(245, 245, 248)` | Subtle warm gray |
| blockquote_border | `(40, 40, 40)` | `(215, 215, 220)` | Subtle |
| blockquote_text | `WHITE` | `(40, 40, 40)` | Near-black |
| blockquote_bar | `(255, 103, 25)` | `(255, 103, 25)` | Same orange both |
| box_bg | `(25, 25, 25)` | `(245, 245, 245)` | Match code blocks |
| box_border | `(60, 60, 60)` | `(200, 200, 200)` | Match code blocks |
| box_title | `(200, 160, 80)` | `(160, 100, 20)` | Darker amber |
| box_body | `(180, 180, 180)` | `(80, 80, 80)` | Medium gray |
| status_loading | `(120, 200, 255)` | `(30, 120, 200)` | Darker blue |
| status_queue | `(100, 150, 255)` | `(30, 100, 200)` | Darker blue |
| status_hint | `GRAY` | `(130, 130, 130)` | Slightly darker |

Syntect: dark = `"base16-ocean.dark"`, light = `"InspiredGitHub"`.

## 6. Edge Cases

1. **New install**: `AppSettings::default().dark_mode == true` → dark mode
2. **Upgrade (missing key)**: No `dark_mode` line → retains default (true)
3. **Registry missing key**: `unwrap_or(1)` → dark mode
4. **Screenshot mode**: `--theme` overrides saved preference (apply_saved_theme skipped)
5. **CLI `--theme` without screenshot**: Same — explicit flag takes precedence
6. **Re-parse failure**: Caught by `match`, error shown to user, old elements preserved
7. **Mermaid textures**: Diagram images are theme-independent; only error boxes use ThemeColors at render time

## 7. Files Modified

| File | Type | Summary |
|------|------|---------|
| `src/theme.rs` | NEW | ThemeColors + apply_dark_mode_visuals helper |
| `src/lib.rs` | Edit | Add `pub mod theme` + re-export |
| `src/window_state.rs` | Edit | dark_mode in AppSettings, file + registry |
| `src/app.rs` | Edit | settings field, status bar toggle + Ctrl+Shift+T, toggle_theme() |
| `src/markdown_renderer.rs` | Edit | dark_mode field, ThemeColors at ~12 sites, syntect switch |
| `src/mermaid_renderer.rs` | Edit | ThemeColors at ~6 box sites |
| `src/main.rs` | Edit | Apply saved theme at startup (skip if --theme explicit) |

## 8. Testing

**Existing:** 222 `MarkdownRenderer::new()` calls unchanged. `AppSettings` test constructors get `dark_mode: true`.

**New tests:**
- ThemeColors: `current(true) == DARK`, `current(false) == LIGHT`, valid syntect theme names
- AppSettings: `default().dark_mode == true`, round-trip with dark_mode, missing key defaults
- Renderer: syntax highlighting with dark and light themes

**Manual:** Toggle via button + Ctrl+Shift+T, verify all elements, restart for persistence, `mdscreensnap` comparison.

## 9. Version

Minor bump (new feature).

## 10. Resolved Decisions

1. `Ctrl+Shift+T` keyboard shortcut (in addition to button)
2. Status bar accent colors included in ThemeColors
3. Code block bg/label unified to single values (was inconsistent: 25 vs 30, 140 vs 150)
4. Mermaid diagram textures don't need cache invalidation (theme-independent)

## 11. Changelog from V1

| # | Issue | Severity | Fix in V2 |
|---|-------|----------|-----------|
| 1 | `render_status_bar(&self)` can't set `theme_toggle_requested` | Critical | Change to `&mut self` (safe: menu_bar already `&mut self`, all call sites compatible) |
| 2 | `apply_saved_theme()` would override CLI `--theme` flag | Critical | Guard: `if resolved_theme.is_none() { app.apply_saved_theme(...) }` |
| 3 | `parse()` returns `Result`, but `toggle_theme()` ignored error | Critical | Added `match` with error handling, old elements preserved on failure |
| 4 | True-black overrides duplicated in `configure_egui_style()` and `apply_visuals()` | Moderate | Extracted shared `apply_dark_mode_visuals()` helper in theme.rs |
| 5 | Code block bg `(25)` vs `(30)` and label `(140)` vs `(150)` inconsistencies | Low | Documented as intentional unification (Section 3.3) |
