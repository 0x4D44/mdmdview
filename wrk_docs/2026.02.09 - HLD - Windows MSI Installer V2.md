# HLD: Windows MSI Installer via cargo-wix (V2)

**Date:** 2026-02-09
**Status:** Draft
**Author:** Claude (with Arthur)
**Changes from V1:** Simplified per quality philosophy review. Cut PATH feature, cut dead extensions, cut future-prediction section, flattened install directory, fixed file-association inconsistency, removed duplicate sections.

---

## 1. Summary

Add a Windows installer (.msi) for mdmdview using **cargo-wix**. The installer handles: install to Program Files, Start Menu shortcut, `.md` file association, Add/Remove Programs entry, upgrade, and clean uninstall.

## 2. Why

mdmdview is currently distributed as a bare ZIP. Users must manually place the EXE, manually set up file associations, and have no upgrade or uninstall path. An MSI gives them a standard Windows install experience.

**Tool choice:** `cargo-wix` v0.3.9 -- Rust-native, produces standard MSI packages, de facto standard for Rust on Windows. Requires WiX Toolset v3 (v3.14.1).

## 3. Scope

### What the Installer Does

| Action | Details |
|--------|---------|
| **Install binary** | `mdmdview.exe` to `C:\Program Files\mdmdview\` |
| **Install license** | `LICENSE` (MIT) to same directory |
| **Start Menu shortcut** | `Start Menu\Programs\mdmdview\mdmdview.lnk` |
| **File associations** | `.md` and `.markdown` registered |
| **Add/Remove Programs** | Entry with icon, version, publisher, GitHub link |
| **Upgrade** | New version auto-removes old via `MajorUpgrade` |

### What It Does NOT Do

- **Desktop shortcut** -- user can pin from Start Menu if desired
- **PATH modification** -- this is a GUI app, not a CLI tool
- **`.txt` association** -- too aggressive; `.txt` belongs to Notepad
- **`.mdown` / `.mkd` association** -- effectively extinct extensions
- **Delete user settings on uninstall** -- `HKCU\Software\MarkdownView` (window position, preferences) is preserved

### File Association Strategy

The installer registers a `ProgId` with `<Extension>` elements for `.md` and `.markdown`. On Windows 10+, this makes mdmdview available as a handler but does **not** forcibly override the user's current default -- Windows protects user choice. On a fresh system with no existing handler, mdmdview becomes the default.

The `Verb` argument is `"%1"`, matching the app's existing CLI behavior (`src/main.rs` parses the first positional arg as a file path).

## 4. Installed Layout

```
C:\Program Files\mdmdview\
    mdmdview.exe    (~5 MB)
    LICENSE
```

No `bin\` subdirectory -- single-binary app, flat is simpler.

## 5. WiX Source Design (`wix/main.wxs`)

### 5.1 Product Identity

```xml
<Product
    Id='*'
    Name='mdmdview'
    UpgradeCode='<STABLE-GUID>'
    Manufacturer='Martin Davidson'
    Language='1033'
    Codepage='1252'
    Version='$(var.Version)'>
```

**Critical:** `UpgradeCode` is generated once by `cargo wix init` and must **never change**. It's how Windows identifies all versions as the same product. Commit `wix/main.wxs` immediately after generation.

### 5.2 Package

```xml
<Package Id='*'
    Description='Markdown viewer for Windows'
    Manufacturer='Martin Davidson'
    InstallerVersion='450'
    Languages='1033'
    Compressed='yes'
    InstallScope='perMachine'
    SummaryCodepage='1252' />
```

`perMachine` installs to Program Files and triggers a UAC prompt. Cabinet is embedded for single-file distribution.

### 5.3 Upgrade Handling

```xml
<MajorUpgrade
    Schedule='afterInstallInitialize'
    DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>
```

New version auto-removes old. Downgrade is blocked. Same-version reinstall works (repair).

**Known limitation:** If mdmdview is running during upgrade, MSI cannot replace the locked EXE. The installer will prompt the user to close the application. This is standard MSI behavior and requires no special handling.

### 5.4 Directory Structure

```xml
<Directory Id='TARGETDIR' Name='SourceDir'>
    <Directory Id='ProgramFiles64Folder' Name='PFiles'>
        <Directory Id='APPLICATIONFOLDER' Name='mdmdview'>
            <!-- All components here (flat) -->
        </Directory>
    </Directory>
    <Directory Id='ProgramMenuFolder' Name='Programs'>
        <Directory Id='ApplicationProgramsFolder' Name='mdmdview'/>
    </Directory>
</Directory>
```

### 5.5 Binary + File Association Component

```xml
<Component Id='binary0' Guid='*'>
    <File Id='exe0'
        Name='mdmdview.exe'
        DiskId='1'
        Source='$(var.CargoTargetBinDir)\mdmdview.exe'
        KeyPath='yes'/>

    <ProgId Id='mdmdview.MarkdownFile'
        Description='Markdown Document'
        Icon='exe0' IconIndex='0'>

        <Extension Id='md' ContentType='text/markdown'>
            <Verb Id='open_md' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>

        <Extension Id='markdown' ContentType='text/markdown'>
            <Verb Id='open_markdown' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>
    </ProgId>
</Component>
```

`ContentType='text/markdown'` is the official IANA MIME type (RFC 7763). `Icon='exe0'` uses the app's embedded icon for `.md` files in Explorer.

### 5.6 License Component

```xml
<Component Id='License' Guid='*'>
    <File Id='LicenseFile'
        Name='LICENSE'
        DiskId='1'
        Source='LICENSE'
        KeyPath='yes'/>
</Component>
```

### 5.7 Start Menu Shortcut Component

```xml
<Component Id='ApplicationShortcut' Guid='<GUID>'
    Directory='ApplicationProgramsFolder'>
    <Shortcut Id='ApplicationStartMenuShortcut'
        Name='mdmdview'
        Description='Markdown Viewer'
        Target='[#exe0]'
        WorkingDirectory='APPLICATIONFOLDER'
        Icon='ProductICO' />
    <RemoveFolder Id='CleanUpShortcutFolder'
        Directory='ApplicationProgramsFolder'
        On='uninstall'/>
    <RegistryValue Root='HKCU'
        Key='Software\mdmdview\Installer'
        Name='StartMenuShortcut'
        Type='integer' Value='1' KeyPath='yes'/>
</Component>
```

WiX requires a registry value as KeyPath for shortcut components. `RemoveFolder` cleans up the Start Menu folder on uninstall. Registry key is `Software\mdmdview\Installer` (separate from the app's `Software\MarkdownView`).

### 5.8 Feature (Single)

```xml
<Feature Id='Complete'
    Title='mdmdview'
    Description='Markdown viewer application'
    Level='1'
    ConfigurableDirectory='APPLICATIONFOLDER'
    AllowAdvertise='no'
    Absent='disallow'>

    <ComponentRef Id='binary0'/>
    <ComponentRef Id='License'/>
    <ComponentRef Id='ApplicationShortcut'/>
</Feature>
```

Single, required feature. No sub-features, no feature tree UI needed.

### 5.9 Add/Remove Programs

```xml
<SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>
<Icon Id='ProductICO' SourceFile='icon.ico'/>
<Property Id='ARPPRODUCTICON' Value='ProductICO' />
<Property Id='ARPHELPLINK' Value='https://github.com/0x4D44/mdmdview'/>
```

### 5.10 Installer UI

```xml
<UI>
    <UIRef Id='WixUI_Minimal'/>
</UI>
```

`WixUI_Minimal` provides: Welcome → Install → Finish. No license dialog, no feature selection. Simple and fast. The LICENSE file is installed to the program directory for anyone who wants to read it.

## 6. Uninstall Behavior

**Removed:**
- `C:\Program Files\mdmdview\` directory and all contents
- Start Menu shortcut and folder
- File association registry entries
- Installer registry key (`HKCU\Software\mdmdview\Installer`)

**Preserved:**
- `HKCU\Software\MarkdownView` -- user settings (window position, preferences). Removing these on uninstall would be hostile; users expect preferences to survive reinstall.

## 7. Implementation Steps

1. Create `LICENSE` file at repo root (MIT, copyright Martin Davidson)
2. Update `Cargo.toml`: description, authors, license field, `[package.metadata.wix]` section
3. Install prerequisites: WiX Toolset v3.14.1, `cargo install cargo-wix`
4. Run `cargo wix init` to generate `wix/main.wxs` with stable GUIDs
5. Customize `wix/main.wxs` per section 5 (file associations, Start Menu shortcut, flat directory)
6. Build and test: `cargo wix`, then manual test (install, verify files, Start Menu, file association, uninstall)
7. Update `release.yml` to produce MSI alongside ZIP
8. Add MSI build instructions to `CLAUDE.md`

### Build Commands

```bash
# Full build (compiles release + creates MSI):
cargo wix

# Separate steps (if you need custom feature flags):
cargo build --release
cargo wix --no-build
```

Output: `target\wix\mdmdview-<version>-x86_64.msi`

### Cargo.toml Changes

```toml
# Update existing fields:
[package]
description = "A markdown viewer for Windows"
authors = ["Martin Davidson <martingdavidson@gmail.com>"]
license = "MIT"

# Add new section:
[package.metadata.wix]
upgrade-guid = "<generated-by-cargo-wix-init>"
path-guid = "<generated-by-cargo-wix-init>"
product-icon = "icon.ico"
eula = false
```

## 8. Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **UpgradeCode GUID lost** (regenerated accidentally) | Breaks upgrade chain for all existing installs | Commit `wix/main.wxs` immediately; add warning comment in file |
| **File association conflicts** with VS Code, Typora, etc. | User's default handler changes unexpectedly | Windows 10+ protects user choice; ProgId registration is non-forceful |
| **App running during upgrade** | MSI can't replace locked EXE | Standard MSI behavior: prompts user to close. No special handling needed |
| **cargo-wix / WiX v3 deprecation** | Can't build MSI in future | Low urgency; WiX v3 works today, cargo-wix tracks community demand for v4 |

## 9. Resolved Questions

1. **License** -- MIT. Standard MIT text, copyright Martin Davidson.
2. **Manufacturer** -- "Martin Davidson" in all installer metadata.
3. **Help URL** -- `https://github.com/0x4D44/mdmdview`.
4. **PATH** -- Cut entirely. GUI app; no terminal use case.
5. **File extensions** -- `.md` and `.markdown` only. `.mdown`/`.mkd` are dead.
6. **EULA dialog** -- None. Use `WixUI_Minimal`. LICENSE file installed for reference.
7. **Install directory** -- Flat `C:\Program Files\mdmdview\`. No `bin\` subdirectory.
