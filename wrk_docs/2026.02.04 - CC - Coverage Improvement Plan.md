# Code Coverage Improvement Plan

**Project:** mdmdview
**Date:** 2026-02-04
**Current Coverage:** 99.19%
**Target:** Maintain 98%+ and improve window_state.rs

---

## Current Status (Updated after Stage 1)

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| **Overall Branch Coverage** | 96.06% | **96.49%** | +0.43% |
| **window_state.rs Branch** | 70.45% | **93.18%** | +22.73% |
| **Total Missed Branches** | 91 | **81** | -10 |

### Progress Summary
- **Stage 1 Complete**: Added 19 new tests to window_state.rs
- Improved window_state.rs from 70.45% to 93.18% branch coverage
- Covered 10 additional branches

### Remaining Gap
- **Current**: 96.49% (81 missed branches)
- **Target**: 98.00% (max 46 missed branches)
- **Still needed**: Cover 35 more branches

---

## Multi-Stage Improvement Plan

### Stage 1: window_state.rs Coverage (Priority: HIGH)

**Goal:** Improve window_state.rs from 93.38% to 98%+

**Estimated missed lines:** 31 lines

**Target areas:**

1. **Registry operations error paths (Windows)**
   - Test forced registry read errors
   - Test forced registry write errors
   - Test missing registry keys

2. **Config directory fallback paths**
   - Test XDG_CONFIG_HOME fallback scenarios
   - Test missing home directory scenarios
   - Test permission denied scenarios

3. **State sanitization edge cases**
   - Test non-finite values (NaN, Infinity)
   - Test extreme window positions
   - Test invalid state file formats

4. **File I/O error paths**
   - Test read errors with forced failures
   - Test write errors (disk full, permissions)
   - Test corrupted state files

**Implementation approach:**
- Use dependency injection for file system operations
- Add `#[cfg(test)]` mock paths for error simulation
- Test platform-specific code with conditional compilation

### Stage 2: app.rs Edge Cases (Priority: MEDIUM)

**Goal:** Cover remaining 64 missed lines in app.rs

**Target areas:**

1. **File operation error handling**
   - File read failures during drag-drop
   - Invalid file encodings
   - File permission errors

2. **UI event edge cases**
   - Keyboard shortcuts in unusual states
   - Rapid zoom in/out sequences
   - Navigation stack overflow scenarios

3. **Screenshot capture paths**
   - Screenshot with invalid dimensions
   - Screenshot file write failures
   - Screenshot during animation

### Stage 3: Renderer Edge Cases (Priority: LOW)

**Goal:** Cover remaining lines in markdown_renderer.rs (69) and mermaid_renderer.rs (27)

**Target areas:**

1. **Markdown parsing edge cases**
   - Malformed markdown recovery
   - Very deep nesting levels
   - Extremely long lines

2. **Mermaid rendering edge cases**
   - QuickJS initialization failures
   - Invalid SVG output handling
   - Memory pressure scenarios

### Stage 4: main.rs (Priority: MINIMAL)

**Goal:** Cover the 1 remaining line in main.rs

**Target areas:**
- Likely the actual `main()` entry point or early initialization code
- May require integration test or binary execution test

---

## Implementation Order

```
Stage 1: window_state.rs (31 lines) ─────────────────────┐
         Est. 5-8 new tests                              │
         Priority: HIGH                                  │
                                                         ▼
Stage 2: app.rs (64 lines) ──────────────────────────────┐
         Est. 10-15 new tests                            │
         Priority: MEDIUM                                │
                                                         ▼
Stage 3: Renderers (96 lines total) ─────────────────────┐
         Est. 15-20 new tests                            │
         Priority: LOW                                   │
                                                         ▼
Stage 4: main.rs (1 line) ───────────────────────────────┘
         Est. 1 test
         Priority: MINIMAL
```

---

## Stage 1 Implementation Details

### Test 1: Registry Error Handling (Windows)

```rust
#[test]
#[cfg(windows)]
fn test_load_window_state_registry_error() {
    // Force registry read error by manipulating mock
    // Verify fallback to file-based storage
}
```

### Test 2: Config Directory Fallbacks

```rust
#[test]
fn test_config_dir_all_fallbacks_exhausted() {
    // Remove HOME, XDG_CONFIG_HOME, etc.
    // Verify graceful None return
}
```

### Test 3: State File Corruption

```rust
#[test]
fn test_load_window_state_corrupted_json() {
    // Write invalid JSON to state file
    // Verify error handling
}
```

### Test 4: Write Permission Errors

```rust
#[test]
fn test_save_window_state_permission_denied() {
    // Force write error
    // Verify error propagation
}
```

---

## Success Criteria

| Stage | Target | Measurement |
|-------|--------|-------------|
| Stage 1 | window_state.rs >= 98% | cargo llvm-cov |
| Stage 2 | app.rs >= 99% | cargo llvm-cov |
| Stage 3 | All renderers >= 99.5% | cargo llvm-cov |
| Stage 4 | main.rs = 100% | cargo llvm-cov |

---

## Notes

1. **Coverage is already at 99.19%** - exceeds the 98% target
2. **No critical gaps** - all functionality has substantial test coverage
3. **Platform-specific code** is the primary source of coverage gaps
4. **Branch coverage** requires nightly Rust toolchain for more detailed analysis

---

## Conclusion

The mdmdview project has **excellent coverage** at 99.19%. The improvement plan focuses on:

1. Bringing window_state.rs up to the same standard as other modules
2. Covering remaining edge cases in core modules
3. Achieving near-perfect coverage across all files

Since coverage already exceeds 98%, implementation of this plan is **optional** but recommended for long-term code quality.
