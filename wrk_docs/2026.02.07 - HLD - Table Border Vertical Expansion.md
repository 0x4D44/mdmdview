# HLD: Table Border Vertical Expansion

**Date**: 2026-02-07
**Status**: DRAFT
**Predecessor**: `wrk_docs/2026.02.06 - HLD - Table Border Alignment Fix.md`
**Affects**: `src/markdown_renderer.rs` — `paint_table_dividers`, `render_table_tablebuilder`

## 1. Problem Statement

The horizontal border alignment fix (v1.3.1) expanded the border rect by
`column_spacing/2` on left and right to match egui's stripe extent. However
the **vertical** dimension was not addressed. The bottom border line of
tables does not match the shaded cell extent — the last row's stripe
background extends below the border, creating a visible gap.

The same issue exists at the top of the header row, though it is less
noticeable because the header background blends differently.

### Visual Evidence

Screenshot from Arthur (2026-02-07) shows a 5-column "Performance Metrics"
table where the bottom row ("Total") has a striped background that extends
below the bottom border line.

## 2. Root Cause

Identical to the horizontal fix. egui's stripe expansion is:

```
// egui_extras layout.rs:122
let gapless_rect = max_rect.expand2(0.5 * item_spacing);
```

This expands by `item_spacing / 2` in **all four directions** (left, right,
top, bottom). The v1.3.1 fix only addressed the horizontal (x) component.

The vertical gap is `item_spacing.y / 2`. egui's default `item_spacing.y`
is typically 3.0–4.0px, so the gap is ~1.5–2.0px — subtle but visible,
especially on the last striped row.

### Where `rect.top()` and `rect.bottom()` come from

In `resolve_table_rects`:
- `top` = `header_rect.top()` — the top edge of the first header cell's
  `ui.min_rect()`. The stripe extends `item_spacing.y / 2` above this.
- `bottom` = `body_rect.bottom()` — the bottom edge of the last body cell's
  `ui.min_rect()`. The stripe extends `item_spacing.y / 2` below this.

The border is drawn at these positions. The stripe extends beyond.

## 3. Design

### 3.1 Add `row_spacing` Parameter to `paint_table_dividers`

The function currently accepts `column_spacing: f32` (= `item_spacing.x`).
Add `row_spacing: f32` (= `item_spacing.y`) as a new parameter:

```rust
fn paint_table_dividers(
    &self,
    painter: &Painter,
    visuals: &Visuals,
    rect: egui::Rect,
    clip_rect: egui::Rect,
    widths: &[f32],
    header_height: f32,
    column_spacing: f32,
    row_spacing: f32,          // NEW
    draw_dividers: bool,
) {
```

This follows the existing pattern of passing spacing as individual `f32`
values rather than a `Vec2`, keeping the API consistent.

### 3.2 Expand `border_rect` Vertically

Update the existing `border_rect` computation to include vertical expansion:

```rust
let half_col_spacing = column_spacing * 0.5;
let half_row_spacing = row_spacing * 0.5;
let border_rect = egui::Rect::from_min_max(
    egui::pos2(rect.left() - half_col_spacing, rect.top() - half_row_spacing),
    egui::pos2(rect.right() + half_col_spacing, rect.bottom() + half_row_spacing),
);
```

This also renames `half_spacing` → `half_col_spacing` for clarity now
that there are two spacing dimensions.

### 3.3 Extend Vertical Dividers to `border_rect.y_range()`

The inter-column dividers currently use `rect.y_range()`. With the
vertical expansion, they should extend to the full border height:

```rust
// Was: painter.vline(x_pos, rect.y_range(), separator_stroke);
painter.vline(x_pos, border_rect.y_range(), separator_stroke);
```

This ensures divider lines extend from the top border to the bottom
border, rather than stopping short.

### 3.4 Pass `row_spacing` at the Call Site

In `render_table_tablebuilder`, `prev_spacing` (captured at line 4297)
holds the original `ui.spacing().item_spacing` before any modifications.
Pass `prev_spacing.y` as `row_spacing`:

```rust
self.paint_table_dividers(
    &outer_painter,
    &outer_visuals,
    rect,
    clip_rect,
    &widths,
    header_height,
    column_spacing,
    prev_spacing.y,        // NEW
    !content_fits,
);
```

Note: `prev_spacing` is captured inside the `render_table` closure at
line 4297. The call site at line 4519 is also inside this closure, so
`prev_spacing` is in scope.

### 3.5 Summary of Changes

| # | Change | Location | Lines |
|---|--------|----------|-------|
| 1 | Add `row_spacing: f32` parameter | `paint_table_dividers` signature | 1 |
| 2 | Rename `half_spacing` → `half_col_spacing`, add `half_row_spacing` | `paint_table_dividers` body | 2 |
| 3 | Expand `border_rect` vertically by `half_row_spacing` | `paint_table_dividers` body | 2 |
| 4 | Change `vline` to use `border_rect.y_range()` | `paint_table_dividers` body | 1 |
| 5 | Pass `prev_spacing.y` at call site | `render_table_tablebuilder` | 1 |
| 6 | Update 6 test call sites with new parameter | test functions | 6 |

Total: ~13 lines changed.

## 4. Worked Example

### 5-Column Table (Performance Metrics), Last Row Striped

Before fix (v1.3.1):
```
    ┌─────────┬──────────┬────────────┬────────┬────────┐
    │Operation│Time (ms) │Memory (MB) │CPU (%) │Status  │  ← border_rect top
    ├─────────┼──────────┼────────────┼────────┼────────┤
    │File Load│12.5      │45.2        │15      │✓ Pass  │
    │...      │...       │...         │...     │...     │
    │Total    │251.0     │435.8       │-       │⚠ Review│  ← rect.bottom()
    └─────────┴──────────┴────────────┴────────┴────────┘
    ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓  ← stripe extends ~2px below
```

After fix:
```
    ┌─────────┬──────────┬────────────┬────────┬────────┐  ← border_rect.top() (shifted up ~2px)
    │Operation│Time (ms) │Memory (MB) │CPU (%) │Status  │
    ├─────────┼──────────┼────────────┼────────┼────────┤
    │File Load│12.5      │45.2        │15      │✓ Pass  │
    │...      │...       │...         │...     │...     │
    │Total    │251.0     │435.8       │-       │⚠ Review│
    └─────────┴──────────┴────────────┴────────┴────────┘  ← border_rect.bottom() (shifted down ~2px)
```

Border aligns with stripe extent on all four sides.

## 5. Impact Analysis

### 5.1 Visual Impact

| Edge | Before | After |
|------|--------|-------|
| Top | Border at cell top; stripe extends ~2px above | Border matches stripe top |
| Bottom | Border at cell bottom; stripe extends ~2px below | Border matches stripe bottom |
| Left | Already fixed in v1.3.1 | No change |
| Right | Already fixed in v1.3.1 | No change |

### 5.2 Test Impact

The 6 existing test call sites of `paint_table_dividers` need a new
`row_spacing` argument. All tests pass a concrete `f32` value (e.g., `4.0`).
No new test logic is needed beyond the parameter addition — the vertical
expansion is a cosmetic paint change with no testable layout side effects.

### 5.3 Risk Assessment

| Risk | Severity | Mitigation |
|------|----------|------------|
| Top border shifts up ~2px | Negligible | Matches stripe extent; consistent with horizontal fix |
| Bottom border shifts down ~2px | Negligible | Same |
| Dividers extend to border edges | None | Visual improvement; consistent with border rect |
| Additional parameter bloat | Low | `paint_table_dividers` already has `#[allow(clippy::too_many_arguments)]` |

## 6. Files to Modify

| File | Change |
|------|--------|
| `src/markdown_renderer.rs` | `paint_table_dividers`: add `row_spacing` param, expand vertically, extend dividers |
| `src/markdown_renderer.rs` | `render_table_tablebuilder`: pass `prev_spacing.y` at call site |

## 7. Alternatives Considered

### 7.1 Pass `Vec2` Instead of Two Separate `f32` Values

Replace `column_spacing: f32` with `spacing: Vec2`. Cleaner signature
but changes the existing parameter, requiring more churn in test call sites
and breaking the naming convention used by the rest of the function body
(`column_spacing` is referenced in the divider loop). Rejected — the
incremental `row_spacing` addition is less invasive.

### 7.2 Hardcode Vertical Expansion

Use a fixed constant (e.g., `2.0px`) instead of the actual `row_spacing`.
Fragile — breaks if the user changes font sizes or egui's default spacing
changes. Rejected.

### 7.3 Compute `row_spacing` Inside `paint_table_dividers`

Could infer vertical spacing from `rect` height and row count, but this
is unreliable and introduces coupling. The caller already has the exact
value. Rejected.
