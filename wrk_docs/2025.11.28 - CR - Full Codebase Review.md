# Code Review: mdmdview Full Codebase

**Date:** 2025-11-28
**Reviewer:** Claude
**Branch:** feat/table-dividers
**Version:** 0.3.3

---

## Executive Summary

**mdmdview** is a well-structured, single-binary Markdown viewer for Windows built with Rust and egui. The codebase demonstrates good software engineering practices with comprehensive test coverage (90 tests, all passing), clean architecture, and thoughtful feature implementation.

### Overall Assessment: **GOOD** with minor improvements recommended

| Category | Rating | Notes |
|----------|--------|-------|
| Code Quality | Good | Clean, readable, follows Rust idioms |
| Architecture | Good | Clear separation of concerns |
| Test Coverage | Excellent | 90 tests, comprehensive scenarios |
| Documentation | Good | Well-documented CLAUDE.md, inline comments |
| Security | Good | No obvious vulnerabilities |
| Performance | Good | Caching, lazy loading, worker pools |

---

## Source File Inventory

| File | Lines (approx) | Purpose |
|------|----------------|---------|
| `src/main.rs` | ~229 | Entry point, window setup, CLI parsing |
| `src/lib.rs` | ~17 | Public module exports |
| `src/app.rs` | ~1900+ | Application logic, UI, keyboard handling |
| `src/markdown_renderer.rs` | ~2000+ | Markdown parsing, rendering, Mermaid/Kroki |
| `src/sample_files.rs` | ~539 | Embedded sample markdown files |
| `src/window_state.rs` | ~172 | Cross-platform window persistence |
| `src/emoji_catalog.rs` | ~109 | Emoji shortcode mapping |
| `src/emoji_assets.rs` | ~173 | Vector fallback emoji renderer |
| `src/table_support/mod.rs` | ~9 | Module re-exports |
| `src/table_support/metrics.rs` | ~165 | Table rendering metrics tracking |
| `src/table_support/column_spec.rs` | ~675 | Column policy and layout computation |
| `build.rs` | ~214 | Windows resources, Mermaid embedding |

**Total:** ~6,200+ lines of Rust code

---

## Static Analysis Results

### Cargo Clippy (3 warnings)

1. **Empty line after doc comment** (`src/sample_files.rs:172`, `:338`)
   - Severity: Low
   - Impact: Style consistency
   - Fix: Remove empty lines between doc comments and items

2. **Unused enumerate index** (`src/markdown_renderer.rs:925`)
   - Severity: Low
   - Impact: Minor inefficiency
   - Fix: `for element in elements.iter()` instead of enumerate

### Test Results

```
running 87 tests (lib) - all passed
running 3 tests (main) - all passed
Total: 90 tests, 0 failed
```

---

## Detailed File Reviews

### 1. `src/main.rs` - Entry Point

**Strengths:**
- Clean CLI argument parsing for `--table-wrap` / `--no-table-wrap`
- Environment variable fallback (`MDMDVIEW_TABLE_WRAP_OVERHAUL`)
- Proper window state restoration with sanitization
- Custom programmatic icon generation (no external dependencies)
- Proper console hiding in release mode (`windows_subsystem = "windows"`)
- Unit tests for icon creation and flag parsing

**Observations:**
- The `create_app_icon()` function is ~60 lines of hardcoded pixel logic. This works but could be extracted to a separate module if icon complexity grows.

**Rating:** Excellent

---

### 2. `src/app.rs` - Application Logic

**Strengths:**
- Clear separation between state management and UI rendering
- Comprehensive keyboard shortcut handling with proper deferred execution
- Browser-like navigation history with back/forward support
- Robust drag-and-drop with validation (50 file limit, extension checking)
- Line ending normalization (`\r\n`, `\r`, `\n` all handled)
- Lossy UTF-8 reading for legacy file support
- Window state persistence with throttling (1 second debounce)

**Architecture:**
```
MarkdownViewerApp
├── MarkdownRenderer (parsing/display)
├── Navigation History (files/samples)
├── Search State (query, highlights)
├── View Mode (Rendered/Raw/Write)
├── Window State (position/size persistence)
└── Drag-Drop Queue (pending files)
```

**Potential Improvements:**
1. The `handle_shortcuts()` method is ~200 lines. Consider grouping shortcuts into categories (file ops, navigation, view, zoom).
2. The `render_menu_bar()` method is very long (~350 lines). Consider breaking into `render_file_menu()`, `render_view_menu()`, etc.

**Rating:** Good

---

### 3. `src/markdown_renderer.rs` - Core Rendering

**Strengths:**
- Proper inline span handling with `InlineSpan` enum
- Syntax highlighting via `syntect` with proper theme support
- Unicode-aware search with accent folding (NFKC normalization)
- Grapheme-aware text highlighting
- Image caching with modification time tracking for live refresh
- Mermaid rendering via Kroki service OR QuickJS (feature-gated)
- Table layout with column statistics and smart policy assignment
- Worker pool for Kroki requests (4 concurrent, bounded queue)

**Architecture:**
```
MarkdownRenderer
├── Parsing (pulldown-cmark)
├── Rendering (egui widgets)
├── Caching
│   ├── Image textures (with mtime tracking)
│   ├── Emoji textures
│   ├── Table layouts (LRU, 512 capacity)
│   └── Mermaid/Kroki SVG cache
├── Highlighting (syntect)
└── External Services (Kroki worker pool)
```

**Observations:**
- The file is very large (~2000+ lines). Consider splitting into sub-modules:
  - `markdown_renderer/parser.rs` - Parsing logic
  - `markdown_renderer/render.rs` - UI rendering
  - `markdown_renderer/image.rs` - Image handling
  - `markdown_renderer/mermaid.rs` - Mermaid/Kroki integration

**Rating:** Good (could benefit from modularization)

---

### 4. `src/table_support/` - Table Rendering

**Strengths:**
- Smart column policy classification based on header names
- Statistics-based width calculation (graphemes, longest word, content type)
- Support for resizable, fixed, remainder, and auto columns
- Proper CJK width handling via `unicode-width`
- Cache with LRU eviction and hit/miss tracking
- Hash-based column identification for persistence

**`column_spec.rs` Column Classification:**
| Header Pattern | Policy |
|---------------|--------|
| version, rev, #, id | Fixed (80-160px, clipped) |
| date, time, timestamp | Fixed (110-200px) |
| author, owner, user | Resizable (min 105px) |
| status, state | Fixed (90-180px, clipped) |
| notes, description | Resizable (min 147px) |
| example, examples | Remainder |

**Observations:**
- Good separation of metrics from column specification
- The `MAX_REMAINDER_COLUMNS = 2` limit prevents layout issues

**Rating:** Excellent

---

### 5. `src/window_state.rs` - Persistence

**Strengths:**
- Cross-platform support (Windows registry + file, macOS/Linux XDG)
- Proper sanitization of restored state (finite check, clamping)
- Graceful fallback if registry fails on Windows

**Platform Paths:**
| Platform | Storage |
|----------|---------|
| Windows | Registry: `HKCU\Software\MarkdownView` + `%APPDATA%\MarkdownView\window_state.txt` |
| macOS | `~/Library/Application Support/MarkdownView/window_state.txt` |
| Linux | `$XDG_CONFIG_HOME/mdmdview/window_state.txt` or `~/.config/mdmdview/` |

**Rating:** Excellent

---

### 6. `src/emoji_catalog.rs` & `src/emoji_assets.rs`

**Strengths:**
- Embedded PNG assets for common emoji
- Vector fallback renderer for key emoji (check, rocket, heart, star, fire)
- Lazy-loaded `OnceLock` for shortcode mapping
- 18 shortcodes supported

**Supported Shortcodes:**
`:tada:`, `:rocket:`, `:star:`, `:fire:`, `:thumbsup:`, `:thumbsdown:`, `:bulb:`, `:question:`, `:exclamation:`, `:memo:`, `:brain:`, `:test_tube:`, `:package:`, `:wrench:`, `:white_check_mark:`, `:check_mark:`, `:grinning:`, `:wink:`, `:slightly_smiling_face:`

**Observations:**
- Consider using a build script to generate the shortcode map from a data file to ease maintenance
- Vector fallback drawings are simplistic but functional

**Rating:** Good

---

### 7. `src/sample_files.rs` - Embedded Samples

**Strengths:**
- 6 comprehensive sample files covering all features
- Unicode/accent test cases in search guide
- Proper markdown structure with table of contents

**Sample Files:**
1. `welcome.md` - Introduction
2. `formatting.md` - Text formatting examples
3. `code.md` - Syntax highlighting examples
4. `usage.md` - Keyboard shortcuts and usage
5. `search.md` - Search tips with Unicode examples
6. `images.md` - Image and Mermaid examples

**Clippy Issues:** 2 empty lines after doc comments (lines 172, 338)

**Rating:** Good

---

### 8. `build.rs` - Build Script

**Strengths:**
- Windows resource embedding (icon, version info)
- Mermaid.js embedding for offline rendering
- ISO timestamp generation via PowerShell
- Version parsing from Cargo.toml
- Graceful fallback if resources fail to compile

**Rating:** Excellent

---

## Security Analysis

### Areas Reviewed:

1. **File Operations**
   - Uses `std::fs` directly (no path traversal vulnerabilities observed)
   - Extension validation for markdown files
   - 50-file limit on drag-drop prevents resource exhaustion

2. **External URLs**
   - Links open via `webbrowser::open()` which delegates to system handler
   - Kroki URLs are environment-configurable, default to public instance

3. **Input Validation**
   - UTF-8 validation with lossy fallback
   - Window state sanitization prevents invalid coordinates
   - Markdown parsing via `pulldown-cmark` (well-tested library)

4. **Network**
   - Kroki requests use `ureq` with timeouts (5s connect, 10s read/write)
   - Bounded worker queue prevents unbounded request spawning

**No critical security issues identified.**

---

## Performance Analysis

### Caching Layers:
1. **Table Layout Cache** - LRU, 512 entries, hash-keyed
2. **Image Texture Cache** - mtime-tracked for invalidation
3. **Emoji Texture Cache** - Persistent per session
4. **Mermaid/Kroki SVG Cache** - Hash-keyed by source code

### Worker Pools:
- **Kroki Workers**: 4 threads, bounded queue (16 slots)
- Request coalescing via `HashSet<u64>` for pending requests

### Observed Optimizations:
- Window state persistence throttled to 1 Hz
- Column stats sample limited to 128 rows
- Release build uses LTO, strip, single codegen unit

---

## Recommendations

### High Priority

1. **Fix Clippy Warnings** (Low effort)
   - Remove empty lines in `sample_files.rs`
   - Fix unused enumerate in `markdown_renderer.rs`

### Medium Priority

2. **Modularize `markdown_renderer.rs`**
   - Split into parser, renderer, image, and mermaid sub-modules
   - Improves maintainability and compile times

3. **Break Up Long Methods in `app.rs`**
   - `handle_shortcuts()` - Split by category
   - `render_menu_bar()` - One method per menu

### Low Priority

4. **Add Integration Tests**
   - Current tests are mostly unit tests
   - Add end-to-end tests for file loading → rendering → display

5. **Consider Accessibility**
   - No keyboard focus indicators visible
   - Screen reader support could be improved

6. **Documentation**
   - Add `rustdoc` comments to public APIs
   - Consider generating API documentation

---

## Test Coverage Summary

| Module | Tests | Coverage Areas |
|--------|-------|----------------|
| `app` | 30 | State, navigation, file ops, view modes |
| `markdown_renderer` | 27 | Parsing, highlighting, images, tables |
| `sample_files` | 9 | Content validation, structure |
| `table_support` | 10 | Column classification, stats |
| `main` | 3 | Icon, flags |
| `build` | 4 | Version parsing, author extraction |
| **Total** | **90** | |

---

## Conclusion

The mdmdview codebase is well-engineered with thoughtful architecture, comprehensive test coverage, and good adherence to Rust best practices. The main areas for improvement are:

1. Minor Clippy warnings (trivial fixes)
2. Large file modularization (medium effort, high value)
3. Long method extraction (medium effort, medium value)

The application is production-ready for its intended use case as a lightweight, portable Markdown viewer.

---

## Appendix: Dependency Analysis

### Production Dependencies (Cargo.toml)
| Crate | Version | Purpose |
|-------|---------|---------|
| eframe | 0.27 | Native window framework |
| egui | 0.27 | Immediate-mode GUI |
| egui_extras | 0.27 | Table builder, extra widgets |
| pulldown-cmark | 0.9 | Markdown parsing |
| syntect | 5.2 | Syntax highlighting |
| webbrowser | 0.8 | Open URLs in browser |
| rfd | 0.14 | Native file dialogs |
| anyhow | 1.0 | Error handling |
| crossbeam-channel | 0.5 | Multi-producer channels |
| image | 0.24 | Image decoding |
| unicode-* | Various | Unicode handling |
| usvg/resvg/tiny-skia | 0.43/0.43/0.11 | SVG rendering |
| ureq | 2 | HTTP client |
| winreg (Windows) | 0.52 | Registry access |

### Optional Dependencies
| Crate | Feature | Purpose |
|-------|---------|---------|
| rquickjs | mermaid-quickjs | Offline Mermaid rendering |

### Build Dependencies
| Crate | Purpose |
|-------|---------|
| winres | Windows resource embedding |
| tempfile (dev) | Test file operations |
