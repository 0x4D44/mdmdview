# Implementation Plan: Table Border Alignment Fix

**Date**: 2026-02-06
**Design**: `wrk_docs/2026.02.06 - HLD - Table Border Alignment Fix.md`
**Approach**: TDD — write/update tests first, then implement

## Overview

Two stages, each independently compilable and committable:

| Stage | What | Tests | Lines | Risk |
|-------|------|-------|-------|------|
| 1 | Expand border rect + suppress dividers | Update 4 existing tests, add 2 new | ~15 | Low — cosmetic only |
| 2 | Visual verification + version bump | Manual | ~2 | Low |

---

## Stage 1: Border Rect Expansion + Divider Suppression (TDD)

**Goal**: Fix the double right border and tight left border by expanding
the painted border rect by `column_spacing/2` horizontally, and suppress
custom inter-column dividers when columns are resizable (content-fit mode).

### 1a. Update existing tests (RED)

File: `src/markdown_renderer.rs`, in `#[cfg(test)]` block.

All 4 existing call sites of `paint_table_dividers` must be updated to
include the new `draw_dividers: bool` parameter. These tests currently
pass `true` (preserving existing behavior):

**Test 1** — line ~12516 (inside `test_estimate_table_row_height_*`):
```rust
renderer.paint_table_dividers(ui.painter(), ui.visuals(), rect, rect, &[], 0.0, 0.0, true);
```

**Test 2** — line ~12619 (`test_paint_table_dividers_draws_header_separator`):
```rust
renderer.paint_table_dividers(
    ui.painter(), ui.visuals(), rect, rect,
    &[40.0, 60.0], 8.0, 12.0, true,
);
```

**Test 3** — line ~12636 (`test_paint_table_dividers_no_header_height`):
```rust
renderer.paint_table_dividers(
    ui.painter(), ui.visuals(), rect, rect,
    &[40.0, 60.0], 0.0, 8.0, true,
);
```

**Test 4** — line ~12653 (`test_paint_table_dividers_skips_header_separator_out_of_bounds`):
```rust
renderer.paint_table_dividers(
    ui.painter(), ui.visuals(), rect, rect,
    &[40.0, 60.0], 60.0, 8.0, true,
);
```

### 1b. Write new tests (RED)

Add two new tests to verify the fix:

```rust
// Test: dividers suppressed when draw_dividers=false
#[test]
fn test_paint_table_dividers_suppresses_dividers_when_false() {
    let renderer = MarkdownRenderer::new();
    with_test_ui(|_, ui| {
        let rect = egui::Rect::from_min_size(egui::pos2(0.0, 0.0), egui::vec2(120.0, 40.0));
        // Should not panic with draw_dividers=false; only outer border + header drawn
        renderer.paint_table_dividers(
            ui.painter(), ui.visuals(), rect, rect,
            &[40.0, 60.0], 8.0, 12.0, false,
        );
    });
}

// Test: single-column table with draw_dividers=false still draws border
#[test]
fn test_paint_table_dividers_single_column_no_dividers() {
    let renderer = MarkdownRenderer::new();
    with_test_ui(|_, ui| {
        let rect = egui::Rect::from_min_size(egui::pos2(0.0, 0.0), egui::vec2(80.0, 30.0));
        renderer.paint_table_dividers(
            ui.painter(), ui.visuals(), rect, rect,
            &[80.0], 8.0, 6.0, false,
        );
    });
}
```

### 1c. Implement changes (GREEN)

**Change 1 — Add `draw_dividers` parameter to `paint_table_dividers`**

File: `src/markdown_renderer.rs`, line ~5005.

Add `draw_dividers: bool` as the last parameter:

```rust
fn paint_table_dividers(
    &self,
    painter: &Painter,
    visuals: &Visuals,
    rect: egui::Rect,
    clip_rect: egui::Rect,
    widths: &[f32],
    header_height: f32,
    column_spacing: f32,
    draw_dividers: bool,       // NEW
) {
```

**Change 2 — Compute expanded border rect**

After the existing `border_stroke` line (~5025), before the `expanded_clip`
line (~5026), add:

```rust
// Expand border rect horizontally by half the column spacing to match
// the visual extent of egui's striped row backgrounds (which expand by
// item_spacing/2 on each side). This eliminates the double-line effect
// at table edges and provides padding between the border and cell text.
let half_spacing = column_spacing * 0.5;
let border_rect = egui::Rect::from_min_max(
    egui::pos2(rect.left() - half_spacing, rect.top()),
    egui::pos2(rect.right() + half_spacing, rect.bottom()),
);
```

**Change 3 — Use `border_rect` for clip, header, and outer border**

Update 3 lines:

```rust
// Was: let expanded_clip = clip_rect.union(rect);
let expanded_clip = clip_rect.union(border_rect);

// ...

// Was: painter.hline(rect.x_range(), header_y.round() + 0.5, separator_stroke);
painter.hline(border_rect.x_range(), header_y.round() + 0.5, separator_stroke);

// ...

// Was: painter.rect_stroke(rect, 0.0, border_stroke);
painter.rect_stroke(border_rect, 0.0, border_stroke);
```

Keep the divider loop using `rect.left()` unchanged — dividers must align
with actual column positions, not the expanded border.

**Change 4 — Gate divider loop on `draw_dividers`**

```rust
// Was: if widths.len() > 1 {
if draw_dividers && widths.len() > 1 {
```

**Change 5 — Pass `draw_dividers` at call site**

File: `src/markdown_renderer.rs`, line ~4519 (inside `render_table` closure):

```rust
self.paint_table_dividers(
    &outer_painter,
    &outer_visuals,
    rect,
    clip_rect,
    &widths,
    header_height,
    column_spacing,
    !content_fits,    // NEW: suppress custom dividers in content-fit mode
);
```

The `content_fits` bool is already captured by the closure (Copy type).

### 1d. Verify — run full test suite

```bash
cargo test
cargo clippy
```

All tests must pass. Zero clippy warnings.

### 1e. Fix any failing tests

The only tests that should need updating are the 4 existing
`paint_table_dividers` call sites (adding the `true` parameter).
No other tests should be affected since the border expansion is
purely cosmetic and doesn't change column widths or layout.

**Commit**: `fix: align table borders with stripe backgrounds`

---

## Stage 2: Visual Verification + Version Bump

**Goal**: Build, verify visually, bump version.

### 2a. Build debug

```bash
cargo build
```

### 2b. Visual verification

Open the app with `test_stress.md` and verify:
- 2-column tables have clean single borders on all sides
- Left border has visible padding from first column text
- No double lines on right side
- Inter-column boundaries show single clean lines (no overlap)
- Wide tables (many columns, viewport-fill) look unchanged
- Hscroll tables look unchanged
- Column resize still works in content-fit tables
- Single-column tables render correctly

### 2c. Version bump

File: `Cargo.toml`
- `1.3.0` → `1.3.1` (patch: bug fix — border alignment)

### 2d. Release build + final verification

```bash
cargo build --release
cargo test
cargo clippy
```

Zero warnings required.

**Commit**: `chore: version bump 1.3.0 → 1.3.1`

---

## Dependency Graph

```
Stage 1 ──► Stage 2
  (fix)      (verify + release)
```

## Key Files

| File | Stages | Changes |
|------|--------|---------|
| `src/markdown_renderer.rs` | 1 | `paint_table_dividers` (border rect expansion, divider suppression, signature change), call site update, 4 test updates + 2 new tests |
| `Cargo.toml` | 2 | Version bump |

## Rollback Plan

If the border expansion causes unexpected issues:
1. Remove the `border_rect` computation — revert to using `rect` directly
2. Change `draw_dividers` to always `true` at the call site
3. Both changes are trivially reversible single-line edits
