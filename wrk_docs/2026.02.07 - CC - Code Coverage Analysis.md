# Code Coverage Analysis Report

**Date:** 2026-02-07
**Tool:** `cargo llvm-cov --lib`
**Codebase:** mdmdview v1.3.4

## Executive Summary

### Baseline (Pre-Improvement) — 902 tests

| Metric | Covered | Total | Percentage |
|--------|---------|-------|------------|
| Lines | 23,900 | 24,118 | **99.10%** |
| Functions | 2,052 | 2,058 | **99.71%** |
| Regions | 38,991 | 39,614 | **98.43%** |

### Final (Post-Improvement) — 918 tests (+16 new)

| Metric | Covered | Total | Percentage | Delta |
|--------|---------|-------|------------|-------|
| Lines | 24,225 | 24,344 | **99.51%** | +0.41% |
| Functions | 2,086 | 2,089 | **99.86%** | +0.15% |
| Regions | 39,528 | 39,991 | **98.84%** | +0.41% |

## Per-File Comparison

| File | Regions Before | Regions After | Lines Before | Lines After |
|------|---------------|--------------|-------------|------------|
| app.rs | 97.36% (miss=235) | **98.30%** (miss=156) | 98.89% | **99.95%** |
| emoji_assets.rs | 100.00% | 100.00% | 100.00% | 100.00% |
| emoji_catalog.rs | 97.78% (miss=9) | 97.78% (miss=9) | 99.18% | 99.18% |
| image_decode.rs | 100.00% | 100.00% | 100.00% | 100.00% |
| markdown_renderer.rs | 98.30% (miss=297) | **98.77%** (miss=217) | 98.90% | **99.24%** |
| mermaid_renderer.rs | 99.45% (miss=47) | 99.45% (miss=47) | 99.42% | 99.42% |
| sample_files.rs | 100.00% | 100.00% | 100.00% | 100.00% |
| column_spec.rs | 98.56% (miss=23) | 98.56% (miss=23) | 100.00% | 100.00% |
| metrics.rs | 98.84% (miss=4) | 98.84% (miss=4) | 100.00% | 100.00% |
| window_state.rs | 99.37% (miss=8) | **99.45%** (miss=7) | 99.40% | **99.55%** |

## Files at 100% Coverage

- `emoji_assets.rs` — 100% lines, 100% regions
- `image_decode.rs` — 100% lines, 100% regions
- `sample_files.rs` — 100% lines, 100% regions

## Tests Added

### app.rs (+10 tests)

1. **test_poll_readability_discards_stale_result** — Verifies stale readability results (mismatched IDs) are discarded
2. **test_spawn_readability_worker_error_path** — Exercises thread spawn failure path using `FORCE_THREAD_SPAWN_ERROR`
3. **test_render_status_bar_with_readability_stats** — Tests status bar with populated Flesch readability scores
4. **test_render_status_tooltip_all_reading_levels** — Tests all 7 Flesch score interpretation brackets (Very Easy through Very Difficult)
5. **test_render_status_bar_no_readability_with_content** — Tests "Flesch: ..." pending state
6. **test_menu_allow_remote_images_toggle** — Tests the Allow Remote Images menu toggle and settings persistence
7. **test_render_status_bar_empty_content_no_readability** — Tests empty readability string branch
8. **test_render_status_bar_readability_pending_with_content** — Tests readability pending format string
9. **test_debug_repaint_logging_path** — Exercises debug repaint logging with idle and active frames
10. **test_debug_scroll_logging_path** — Exercises debug scroll trace logging

### markdown_renderer.rs (+7 tests)

1. **test_allow_remote_images_getter** — Tests the allow_remote_images() getter toggle
2. **test_render_link_with_emoji_characters** — Tests emoji-aware link rendering path
3. **test_render_link_with_mixed_emoji_and_text** — Tests mixed text/emoji link rendering
4. **test_render_text_with_search_highlighting_active** — Tests search highlighting during rendering
5. **test_render_strong_link_with_emoji** — Tests bold links containing emoji
6. **test_render_text_with_emojis_and_styles** — Tests emoji rendering with various inline styles
7. **test_render_link_context_menu_in_test_mode** — Tests link context menu in test cfg

## Production Code Changes

1. **Debug logging testability** (app.rs): Added `#[cfg(test)]` alternatives for `OnceLock`-based debug flags (`FORCE_DEBUG_REPAINT`, `FORCE_DEBUG_SCROLL` AtomicBool) so debug logging paths can be exercised in tests without process-level OnceLock limitations.
2. **Debug scroll log path** (app.rs): Used `#[cfg(test)]` to write scroll trace to temp dir instead of hardcoded `c:\tmp`.
3. **Unused variable fix** (markdown_renderer.rs): Fixed `r` → `_r` in test-cfg'd context_menu code.

## Remaining Uncovered Regions (463 total)

| Category | Est. Regions | Improvable? |
|----------|-------------|-------------|
| Test assertion macro failure paths | ~200 | No — inherent to llvm-cov region counting |
| Remote image HTTP error paths | ~10 | Would need HTTP mock server |
| Platform-specific registry code | ~8 | Conditional compilation limitation |
| Mermaid feature-gated tests | ~47 | Run with `--features mermaid-quickjs` |
| UI rendering micro-branches | ~150 | Would need deeper egui simulation |
| Save error paths | ~5 | Would need filesystem mocking |
| Cache defensive breaks | ~3 | Unreachable by design (safety checks) |

## Conclusion

Coverage improved from **98.43% to 98.84%** regions and **99.10% to 99.51%** lines with 16 new targeted tests. All files are at or above 98% region coverage except `emoji_catalog.rs` (97.78%), whose 9 missed regions are entirely within test assertion macro failure paths — impossible to cover in passing tests.

The remaining uncovered regions are primarily:
1. **Assertion macro artifacts** (~200 regions) — false positives in coverage counting
2. **UI micro-branches** (~150 regions) — would require deeper egui widget simulation
3. **Feature-gated/platform-specific code** (~55 regions) — conditional compilation boundaries
