# Code Coverage Improvement Plan

**Date:** 2026-02-07
**Goal:** Achieve 98%+ region coverage overall and maintain 99%+ line coverage
**Baseline:** 98.43% region, 99.10% line coverage overall
**Final Result:** 98.84% region, 99.51% line coverage overall

## Status: COMPLETED

All stages executed. Overall 98%+ target achieved.

## Execution Summary

### Stage 1: Low-Hanging Fruit — COMPLETED (no gains possible)

**emoji_catalog.rs, metrics.rs, column_spec.rs** — All missed regions are assertion macro failure paths. Cannot be improved. These are inherent to how llvm-cov counts regions within `assert!()` macros.

### Stage 2: App.rs Coverage Improvements — COMPLETED

**Result:** 97.36% → **98.30%** regions (+0.94%), 98.89% → **99.95%** lines (+1.06%)

Implemented:
1. `test_poll_readability_discards_stale_result` — Stale result ID check ✓
2. `test_spawn_readability_worker_error_path` — Thread spawn error ✓
3. `test_render_status_bar_with_readability_stats` — Status bar with stats ✓
4. `test_render_status_tooltip_all_reading_levels` — All 7 Flesch brackets ✓
5. `test_render_status_bar_no_readability_with_content` — Pending state ✓
6. `test_menu_allow_remote_images_toggle` — Settings toggle ✓
7. `test_render_status_bar_empty_content_no_readability` — Empty path ✓
8. `test_render_status_bar_readability_pending_with_content` — Format path ✓
9. `test_debug_repaint_logging_path` — Debug repaint (via `FORCE_DEBUG_REPAINT`) ✓
10. `test_debug_scroll_logging_path` — Debug scroll (via `FORCE_DEBUG_SCROLL`) ✓

Production code change: Added `#[cfg(test)]` AtomicBool alternatives for `OnceLock`-based debug flags to make debug logging testable.

### Stage 3: Markdown Renderer Coverage — COMPLETED

**Result:** 98.30% → **98.77%** regions (+0.47%), 98.90% → **99.24%** lines (+0.34%)

Implemented:
1. `test_allow_remote_images_getter` — Getter coverage ✓
2. `test_render_link_with_emoji_characters` — Emoji link path ✓
3. `test_render_link_with_mixed_emoji_and_text` — Mixed content ✓
4. `test_render_text_with_search_highlighting_active` — Search highlighting ✓
5. `test_render_strong_link_with_emoji` — Bold emoji links ✓
6. `test_render_text_with_emojis_and_styles` — Styled emoji text ✓
7. `test_render_link_context_menu_in_test_mode` — Context menu ✓

Also fixed: unused variable warning (`r` → `_r`).

### Stage 4: Mermaid Renderer — SKIPPED (already at 99.45%)

Already well above 98%. No action needed.

### Stage 5: Validation — COMPLETED

Final coverage verified:
- **Regions: 98.84%** (target: 98%) ✓
- **Lines: 99.51%** (target: 99%) ✓
- **Functions: 99.86%** ✓
- All tests pass: 918 passed, 0 failed, 1 ignored ✓
- Release build: clean, no warnings ✓

## Remaining Gaps (Cannot Be Improved)

| File | Regions% | Gap Reason |
|------|---------|------------|
| emoji_catalog.rs | 97.78% | 9 regions in test assertion macros |
| column_spec.rs | 98.56% | 23 regions in test assertion macros |
| metrics.rs | 98.84% | 4 regions in test assertion macros |

These files have 100% line coverage. The missed "regions" are all failure branches within `assert!()`, `assert_eq!()`, and `unwrap_or_else()` macros in test code. They only execute when assertions FAIL, which never happens in passing tests. This is a fundamental limitation of llvm-cov's region-based instrumentation.
