# Code Review Report — mdmdview (2025-11-21)

## Scope & Method
- Reviewed core sources: `src/app.rs`, `src/main.rs`, `src/lib.rs`, `src/window_state.rs`, `src/markdown_renderer.rs`, `src/table_support/*`, `src/emoji_*`, `src/sample_files.rs`, `build.rs`, ancillary Rust files (`analyze_text.rs`, `navigation_tests_backup.rs`, `examples/gen_webp.rs`).
- Quick doc scan: `README.md`, embedded samples.
- Tests run locally: `cargo test --locked` (all 87 unit tests passed on 2025-11-21).

## Findings

### Critical
1) **Widespread mojibake/user-copy corruption**  
   - Menu labels, status strings, and keyboard hints in `render_menu_bar` and status bar are filled with unreadable sequences (e.g., `A�A�A.A...`) instead of English text (`src/app.rs:1068-1200`).  
   - Sample prose shipped to users (welcome/usage/formatting/search docs) includes corrupted glyphs (`src/sample_files.rs` constants) and the same appears in `README.md`. Users will see broken text, mnemonics will not match, and search examples become invalid.  
   - Root cause is file-encoding/character substitution; none of these strings are valid UTF-8 user-facing copy. Must be re-sourced and re-encoded.

2) **Emoji/shortcode pipeline broken**  
   - Emoji keys are stored as garbled byte-like sequences (e.g., `dYs?`, `�o.`) in `src/emoji_catalog.rs` and mirrored in `src/emoji_assets.rs`. Shortcode expansion (`expand_shortcodes`) now emits those garbled tokens, so `:rocket:`/`:tada:` no longer map to real emoji or usable PNGs. Feature is effectively non-functional and produces nonsense text in rendered output and tables.

### High
3) **Navigation history duplications on drag/drop**  
   - `handle_file_drop` pushes history before opening the first file, and `load_file` pushes history again (`src/app.rs:415` and `src/app.rs:512`). Dropping a file (or folder) records the current document twice, bloating history and making Alt+←/→ step through duplicates. Reload also pushes a new history entry for the same file. Suggest passing a flag to `load_file` or deferring the initial `push_history` to avoid double-enqueue; reload should skip history.

4) **Mermaid blocks trigger outbound HTTP by default**  

5) **Unvalidated link opening**  
   - `trigger_link` calls `webbrowser::open` on any URL string (`src/markdown_renderer.rs:3785-3796`). A malicious markdown file can open `file://`, `javascript:`, or custom schemes. Implement a scheme allowlist (`http/https/mailto`) and ignore or warn on others before invoking the browser.

### Medium / Low
6) Blocking I/O inside input handling: file dialogs and saves are executed inside `handle_shortcuts` input context (`src/app.rs:844-999`). This can stall a frame; consider deferring like other actions (view/write toggles).  
7) Unused/legacy files (`analyze_text.rs`, `navigation_tests_backup.rs`) sit outside the crate; prune or move to docs to reduce confusion.  
8) Persisted window state paths use `MarkdownView` in `%APPDATA%`/registry while the app brand is `mdmdview` (`src/window_state.rs`); confirm nomenclature is intentional.

## Recommendations (priority)
1. Restore all user-facing strings from clean UTF-8 sources; add a narrow smoke test asserting menu labels/status strings are ASCII/UTF-8 and that samples contain expected words.  
2. Replace emoji keys with real Unicode or stable shortcode→asset mapping; add a unit test that `:rocket:` expands to the correct PNG-backed glyph and renders in tables.  
3. Refactor history handling to avoid double-push on drag/drop and skip history insertion on reload; add regression tests around Alt+←/→ after multi-file drops.  
5. Add URL scheme allowlist before calling `webbrowser::open`; surface a toast/error for blocked schemes.  
6. Optionally defer blocking file I/O out of input handlers and remove unused helper files to tighten the repo.

## Notes
- All unit tests currently pass (`cargo test --locked`), so fixes above will need targeted tests to stay aligned with CI.
