# 2026.01.11 - Branch Coverage Improvement Plan

## Goal
Raise overall branch coverage to >90% as reported by `cargo +nightly llvm-cov --branch` while keeping tests reliable and fast.

## Baseline (from 2026.01.11 run)
- Total branch coverage: 85.95% (2341 branches, 329 missed)
- Branch gap to 90%: ~95 branches
- Lowest branch coverage hotspots:
  - `src/mermaid_renderer.rs`: 80.71% (92/477 missed)
  - `src/markdown_renderer.rs`: 86.79% (131/992 missed)
  - `src/emoji_assets.rs`: 73.53% (9/34 missed)
  - `src/image_decode.rs`: 90.62% (3/32 missed)
- Generated bindings under `target/llvm-cov-target` show 0% coverage (expected for generated code).

## Strategy Overview
1. Focus first on `src/mermaid_renderer.rs`, which still holds the highest missed-branch count.
2. Add targeted branch tests for `src/markdown_renderer.rs` to close table/inline rendering branches.
3. Clean up small-module gaps (`emoji_assets`, `image_decode`) to reduce low-hanging missed branches.
4. Consider excluding generated bindings via `--ignore-filename-regex` to keep totals focused on project code.

## Plan by Area

### 1) Mermaid Renderer (largest gap)
Goal: reduce missed branches in `src/mermaid_renderer.rs` by ~45-50.

Targeted test additions:
- Rasterization branches:
  - Hit `rasterize_svg` oversize guards, bbox resize, and target size clamp paths using crafted SVGs.
  - Cover log flag branches (`MDMDVIEW_MERMAID_LOG_RASTER`) and translate pre-scale branch.
- SVG post-processing branches:
  - Ensure each `fix_*` helper hits both modify/no-op paths with minimal SVG snippets.
- Env configuration branches:
  - Expand tests for renderer preference fallbacks and security level mapping.
- Caching branches:
  - Drive LRU insert/evict edges and error cache branches with synthetic keys.

Test mechanics:
- Use small inline mermaid snippets and fixture SVGs under `tests/` or embedded strings.
- Gate QuickJS-only tests with `#[cfg(feature = "mermaid-quickjs")]` and add non-QuickJS fallbacks.

### 2) Markdown Renderer (large but tractable)
Goal: reduce missed branches in `src/markdown_renderer.rs` by ~35-40.

Targeted test additions:
- Table layout branches:
  - Exercise `resolve_table_column_widths`, `estimate_table_total_width`, and divider paths for empty specs.
  - Force `paint_table_text_job` hover path via narrow widths and multi-line galleys.
- Inline rendering branches:
  - Hit empty segment guards and override text color paths.
- Link/image handling:
  - Cover remote-image placeholder, data URI resolution, and backoff/pending branches.

### 3) Emoji Assets and Image Decode
Goal: close remaining branch gaps in smaller modules.

Targeted test additions:
- `src/emoji_assets.rs`:
  - Add tests for invalid font sizes and unknown emoji codepoints.
- `src/image_decode.rs`:
  - Add tests that force decode failure branches not yet covered.

### 4) Window State
Goal: cover remaining branch cases in `src/window_state.rs`.

Targeted test additions:
- Exercise invalid registry values and path normalization branches.
- Ensure clamp paths for offscreen bounds and NaN inputs are hit in more combinations.

## Coverage Hygiene
- Add a standard coverage command for Windows that includes the `patch.exe` PATH entry.
- Exclude generated bindings from coverage totals:
  - Example: `cargo +nightly llvm-cov --branch --ignore-filename-regex "target/llvm-cov-target/.*/(egl_bindings|wgl_extra_bindings)\\.rs"`
- Document the coverage command in a short note under `README.md` or `docs/` (optional).

## Proposed Execution Phases
1. Mermaid renderer test expansion (highest impact).
2. Markdown renderer branch tests.
3. Small module cleanup (emoji_assets, image_decode).
4. Optional coverage command standardization and documentation.

## Success Criteria
- `cargo +nightly llvm-cov --branch` reports >90% branch coverage for project code.
- Generated bindings do not materially affect totals.
- All new tests run locally in under 10 minutes.

## Status Update (2026.01.11)
- Achieved 92.46% branch coverage (2241 branches, 169 missed).
- See `wrk_docs/2026.01.11 - Branch Coverage Report.md` for the latest run details.

## Risks and Mitigations
- QuickJS tests can be fragile on Windows. Mitigate with clear feature gates and deterministic inputs.
- Visual differences or font-dependent measurements may change outputs. Prefer fixed fixtures and explicit tolerances.

## Estimated Effort
- Mermaid renderer expansion: 1-2 days
- Markdown renderer branches: 0.5-1 day
- Smaller modules and coverage hygiene: 0.5 day
