# 2026.01.11 - Branch Coverage Improvement Plan

## Goal
Raise overall branch coverage to >90% as reported by `cargo +nightly llvm-cov --branch` while keeping tests reliable and fast.

## Baseline (from 2026.01.11 run)
- Total branch coverage: 74.28% (2337 branches, 601 missed)
- Lowest branch coverage hotspots:
  - `src/mermaid_renderer.rs`: 43.61% (269/477 missed)
  - `src/emoji_assets.rs`: 73.53% (9/34 missed)
  - `src/markdown_renderer.rs`: 80.28% (194/984 missed)
  - `src/window_state.rs`: 85.71% (4/28 missed)
  - `src/image_decode.rs`: 87.50% (4/32 missed)
- Generated bindings under `target/llvm-cov-target` show 0% coverage (expected for generated code).

## Strategy Overview
1. Focus first on `src/mermaid_renderer.rs`, which dominates missed branches and will move the needle fastest.
2. Add targeted branch tests for `src/markdown_renderer.rs` and smaller modules to close common conditionals.
3. Separate generated bindings from coverage totals via `--ignore-filename-regex` to prevent coverage dilution.
4. Use small, deterministic tests (no network) with `tempfile` and fixture data to hit error and fallback paths.

## Plan by Area

### 1) Mermaid Renderer (largest gap)
Goal: +35-40% branch coverage in `src/mermaid_renderer.rs`.

Targeted test additions:
- Error and fallback paths:
  - Force QuickJS initialization errors and ensure fallback renderer is chosen.
  - Simulate missing embedded mermaid asset and assert error messaging.
- Env configuration branches:
  - Add tests for `MDMDVIEW_MERMAID_RENDERER` selection, invalid values, and reset behavior.
  - Verify `MDMDVIEW_MERMAID_SECURITY_LEVEL` branches (strict/loose) and default fallback.
- SVG post-processing branches:
  - Add tests covering each `fix_*` helper branch (null elements, missing attrs, unsupported tags).
- Caching branches:
  - Exercise LRU eviction + refresh branches with varying cache keys and sizes.
- Rendering scale branches:
  - Verify scale adjustment path for specific diagram types (ER, mindmap) and non-adjusting branches.

Test mechanics:
- Use small inline mermaid snippets and fixture SVGs under `tests/` or embedded strings.
- Gate QuickJS-only tests with `#[cfg(feature = "mermaid-quickjs")]` and add non-QuickJS fallbacks.

### 2) Markdown Renderer (large but tractable)
Goal: +10-15% branch coverage in `src/markdown_renderer.rs`.

Targeted test additions:
- Inline parsing branches:
  - Add tests for branches involving unmatched delimiters, mixed emphasis, and edge-case backticks.
- Table layout branches:
  - Force table wrapping strategies (fit, truncate, horizontal scroll) via narrow width and verify branches hit.
- Link/image handling:
  - Add tests for invalid schemes, relative links with base dirs, and missing files.
- Search highlight branches:
  - Test empty search, no matches, and multi-match overlap cases.

### 3) Emoji Assets and Image Decode
Goal: close remaining branch gaps in smaller modules.

Targeted test additions:
- `src/emoji_assets.rs`:
  - Test image creation for invalid font sizes and error branches for unsupported emoji entries.
- `src/image_decode.rs`:
  - Force decode error branches with malformed bytes and oversized dimensions.

### 4) Window State
Goal: cover remaining branch cases in `src/window_state.rs`.

Targeted test additions:
- Exercise invalid registry values and path normalization branches.
- Ensure clamp paths for offscreen bounds and NaN inputs are hit in more combinations.

## Coverage Hygiene
- Add a standard coverage command for Windows that includes the `patch.exe` PATH entry.
- Exclude generated bindings from coverage totals:
  - Example: `cargo +nightly llvm-cov --branch --ignore-filename-regex "target/llvm-cov-target/.*/(egl_bindings|wgl_extra_bindings)\\.rs"`
- Document the coverage command in a short note under `README.md` or `docs/` (optional).

## Proposed Execution Phases
1. Mermaid renderer test expansion (highest impact).
2. Markdown renderer branch tests.
3. Small module cleanup (emoji_assets, image_decode, window_state).
4. Coverage command standardization and documentation.

## Success Criteria
- `cargo +nightly llvm-cov --branch` reports >90% branch coverage for project code.
- Generated bindings do not materially affect totals.
- All new tests run locally in under 10 minutes.

## Risks and Mitigations
- QuickJS tests can be fragile on Windows. Mitigate with clear feature gates and deterministic inputs.
- Visual differences or font-dependent measurements may change outputs. Prefer fixed fixtures and explicit tolerances.

## Estimated Effort
- Mermaid renderer expansion: 1-2 days
- Markdown renderer branches: 0.5-1 day
- Smaller modules and coverage hygiene: 0.5 day
