# HLD: Windows MSI Installer via cargo-wix (V4)

**Date:** 2026-02-09
**Status:** Final
**Author:** Claude (with Arthur)
**Changes from V3:** Fixed implementation step ordering (Cargo.toml before init). Removed manual License.rtf step (cargo-wix auto-generates from `license = "MIT"`). Removed misleading `eula = false`. Added architecture note.

---

## 1. Summary

Add a Windows installer (.msi) for mdmdview using **cargo-wix**. The installer handles: install to Program Files, Start Menu shortcut, `.md` file association, Add/Remove Programs entry, upgrade, and clean uninstall.

## 2. Why

mdmdview is currently distributed as a bare ZIP. Users must manually place the EXE, manually set up file associations, and have no upgrade or uninstall path. An MSI gives them a standard Windows install experience.

**Tool choice:** `cargo-wix` v0.3.9 -- Rust-native, produces standard MSI packages, de facto standard for Rust on Windows. Requires WiX Toolset v3 (v3.14.1).

## 3. Scope

### What the Installer Does

| Action | Details |
|--------|---------|
| **Install binary** | `mdmdview.exe` to `C:\Program Files\mdmdview\` |
| **Install license** | `LICENSE` (MIT) to same directory |
| **Start Menu shortcut** | `Start Menu\Programs\mdmdview\mdmdview.lnk` |
| **File associations** | `.md` and `.markdown` registered |
| **Add/Remove Programs** | Entry with icon, version, publisher, GitHub link |
| **Upgrade** | New version auto-removes old via `MajorUpgrade` |

### What It Does NOT Do

- **Desktop shortcut** -- user can pin from Start Menu if desired
- **PATH modification** -- this is a GUI app, not a CLI tool
- **`.txt` association** -- too aggressive; `.txt` belongs to Notepad
- **`.mdown` / `.mkd` association** -- effectively extinct extensions
- **Delete user settings on uninstall** -- `HKCU\Software\MarkdownView` (window position, preferences) is preserved

### File Association Strategy

The installer registers a `ProgId` with `<Extension>` elements for `.md` and `.markdown`. On Windows 10+, this makes mdmdview available as a handler but does **not** forcibly override the user's current default -- Windows protects user choice. On a fresh system with no existing handler, mdmdview becomes the default.

The `Verb` argument is `"%1"`, matching the app's existing CLI behavior (`src/main.rs` parses the first positional arg as a file path).

## 4. Repository File Layout

New files added to the repo:

```
mdmdview/
├── wix/
│   ├── main.wxs         # WiX source XML (generated by cargo wix init, then customized)
│   └── License.rtf      # MIT license in RTF (auto-generated by cargo wix init)
├── LICENSE              # MIT license plain text (installed to Program Files)
└── ... (existing files)
```

Both `wix/` files are generated by `cargo wix init` when `license = "MIT"` is set in Cargo.toml. `main.wxs` is then customized; `License.rtf` is used as-is.

## 5. Installed Layout

```
C:\Program Files\mdmdview\
    mdmdview.exe    (~5 MB)
    LICENSE
```

No `bin\` subdirectory -- single-binary app, flat is simpler.

## 6. WiX Source Design (`wix/main.wxs`)

The `cargo wix init` command generates a starter template. We customize it as described below. The XML fragments show the key elements; the generated template provides the complete structure (root `<Wix>` element, preprocessor directives, closing tags).

### 6.1 Product Identity

```xml
<Product
    Id='*'
    Name='mdmdview'
    UpgradeCode='<STABLE-GUID>'
    Manufacturer='Martin Davidson'
    Language='1033'
    Codepage='1252'
    Version='$(var.Version)'>
```

**Critical:** `UpgradeCode` is generated once by `cargo wix init` and must **never change**. It's how Windows identifies all versions as the same product. Commit `wix/main.wxs` immediately after generation.

### 6.2 Package + Media

```xml
<Package Id='*'
    Description='Markdown viewer for Windows'
    Manufacturer='Martin Davidson'
    InstallerVersion='450'
    Languages='1033'
    Compressed='yes'
    InstallScope='perMachine'
    SummaryCodepage='1252' />

<MajorUpgrade
    Schedule='afterInstallInitialize'
    DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>

<Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1'/>
```

- `perMachine` installs to Program Files, triggers UAC prompt
- Cabinet embedded for single-file distribution
- `MajorUpgrade`: new version auto-removes old; downgrade blocked; same-version reinstall works (repair)
- **Known limitation:** If mdmdview is running during upgrade, MSI cannot replace the locked EXE and will prompt the user to close the application. Standard MSI behavior; no special handling needed.

### 6.3 Directory Structure

```xml
<Directory Id='TARGETDIR' Name='SourceDir'>
    <Directory Id='$(var.PlatformProgramFilesFolder)' Name='PFiles'>
        <Directory Id='APPLICATIONFOLDER' Name='mdmdview'>
            <!-- binary0, License components here (flat) -->
        </Directory>
    </Directory>
    <Directory Id='ProgramMenuFolder' Name='Programs'>
        <Directory Id='ApplicationProgramsFolder' Name='mdmdview'/>
    </Directory>
</Directory>
```

The default template includes a preprocessor conditional that sets `PlatformProgramFilesFolder` to `ProgramFiles64Folder` on x64/ARM64 and `ProgramFilesFolder` on x86. Keep this as generated -- it's the right pattern even though mdmdview currently targets x64 only.

**Key customization:** Remove the `bin` subdirectory from the default template. Place the EXE component directly in `APPLICATIONFOLDER`.

### 6.4 Binary + File Association Component

```xml
<Component Id='binary0' Guid='*'>
    <File Id='exe0'
        Name='mdmdview.exe'
        DiskId='1'
        Source='$(var.CargoTargetBinDir)\mdmdview.exe'
        KeyPath='yes'/>

    <ProgId Id='mdmdview.MarkdownFile'
        Description='Markdown Document'
        Icon='exe0' IconIndex='0'>

        <Extension Id='md' ContentType='text/markdown'>
            <Verb Id='open_md' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>

        <Extension Id='markdown' ContentType='text/markdown'>
            <Verb Id='open_markdown' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>
    </ProgId>
</Component>
```

- `ContentType='text/markdown'` is the official IANA MIME type (RFC 7763)
- `Icon='exe0'` uses the app's embedded icon for `.md` files in Explorer
- `Argument='"%1"'` passes the file path in quotes (handles spaces)
- This entire ProgId/Extension block is **added** to the template (not in the default)

### 6.5 License Component

```xml
<Component Id='License' Guid='*'>
    <File Id='LicenseFile'
        Name='LICENSE'
        DiskId='1'
        Source='LICENSE'
        KeyPath='yes'/>
</Component>
```

### 6.6 Start Menu Shortcut Component

```xml
<Component Id='ApplicationShortcut' Guid='*'
    Directory='ApplicationProgramsFolder'>
    <Shortcut Id='ApplicationStartMenuShortcut'
        Name='mdmdview'
        Description='Markdown Viewer'
        Target='[#exe0]'
        WorkingDirectory='APPLICATIONFOLDER'
        Icon='ProductICO' />
    <RemoveFolder Id='CleanUpShortcutFolder'
        Directory='ApplicationProgramsFolder'
        On='uninstall'/>
    <RegistryValue Root='HKCU'
        Key='Software\mdmdview\Installer'
        Name='StartMenuShortcut'
        Type='integer' Value='1' KeyPath='yes'/>
</Component>
```

- WiX requires a registry value as KeyPath for shortcut components (shortcuts can't be KeyPaths)
- `RemoveFolder` cleans up the Start Menu folder on uninstall
- Registry key is `Software\mdmdview\Installer` (separate from the app's `Software\MarkdownView`)
- This entire component is **added** to the template (not in the default)

### 6.7 Feature (Single)

```xml
<Feature Id='Complete'
    Title='mdmdview'
    Description='Markdown viewer application'
    Level='1'
    ConfigurableDirectory='APPLICATIONFOLDER'
    AllowAdvertise='no'
    Absent='disallow'>

    <ComponentRef Id='binary0'/>
    <ComponentRef Id='License'/>
    <ComponentRef Id='ApplicationShortcut'/>
</Feature>
```

Single, required feature. No sub-features. `ConfigurableDirectory` has no visible effect with `WixUI_Minimal` (no directory picker), but allows custom paths via silent install: `msiexec /i mdmdview.msi APPLICATIONFOLDER="D:\Tools\mdmdview" /qn`.

### 6.8 Add/Remove Programs

```xml
<SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>
<Icon Id='ProductICO' SourceFile='icon.ico'/>
<Property Id='ARPPRODUCTICON' Value='ProductICO' />
<Property Id='ARPHELPLINK' Value='https://github.com/0x4D44/mdmdview'/>
```

### 6.9 Installer UI

```xml
<UI>
    <UIRef Id='WixUI_Minimal'/>
</UI>

<WixVariable Id='WixUILicenseRtf' Value='wix\License.rtf'/>
```

`WixUI_Minimal` provides: **Welcome (with inline MIT license text) -> Install -> Finish**. No feature selection, no directory picker. The `WixUILicenseRtf` is **required** -- `WixUI_Minimal` shows the license inline on the welcome page and the WiX build fails (LGHT0094) without it.

The `wix/License.rtf` file is auto-generated by `cargo wix init` from the built-in MIT template (because `license = "MIT"` is in Cargo.toml).

## 7. Uninstall Behavior

**Removed:**
- `C:\Program Files\mdmdview\` directory and all contents
- Start Menu shortcut and folder
- File association registry entries (ProgId, extensions)
- Installer registry key (`HKCU\Software\mdmdview\Installer`)

**Preserved:**
- `HKCU\Software\MarkdownView` -- user settings (window position, preferences). Users expect preferences to survive reinstall.

## 8. Implementation Steps

1. Create `LICENSE` at repo root (MIT, copyright Martin Davidson)
2. Update `Cargo.toml`: set `description`, `authors`, `license = "MIT"`, add `[package.metadata.wix]`
3. Install prerequisites: WiX Toolset v3.14.1, `cargo install cargo-wix`
4. Run `cargo wix init` -- generates `wix/main.wxs` (with stable GUIDs) and `wix/License.rtf` (from MIT template)
5. Customize `wix/main.wxs` per section 6: remove `bin/` subdirectory, add file associations, add Start Menu shortcut, switch to `WixUI_Minimal`
6. Build: `cargo wix`
7. Test: run through checklist (section 9)
8. Update `release.yml` to produce MSI alongside ZIP
9. Add MSI build instructions to `CLAUDE.md`

### Build Commands

```bash
# Full build (compiles release + creates MSI):
cargo wix

# Separate steps (useful with custom feature flags):
cargo build --release
cargo wix --no-build

# Silent install:
msiexec /i target\wix\mdmdview-1.3.4-x86_64.msi /qn
```

Output: `target\wix\mdmdview-<version>-x86_64.msi`

### Cargo.toml Changes

```toml
# Update existing fields:
[package]
description = "A markdown viewer for Windows"
authors = ["Martin Davidson <martingdavidson@gmail.com>"]
license = "MIT"

# Add new section:
[package.metadata.wix]
upgrade-guid = "<generated-by-cargo-wix-init>"
product-icon = "icon.ico"
```

## 9. Test Checklist

| Test | Expected Result |
|------|----------------|
| Double-click `.msi` | UAC prompt, then: Welcome (MIT license) -> Install -> Finish |
| Check `C:\Program Files\mdmdview\` | `mdmdview.exe` and `LICENSE` present |
| Start Menu search "mdmdview" | Shortcut present; launches app correctly |
| Right-click `.md` file -> Open With | "mdmdview" appears as an option |
| Double-click `.md` file | Opens in mdmdview (if set as default) |
| Settings -> Apps -> "mdmdview" | Entry with correct icon, version, Uninstall button |
| `msiexec /i mdmdview.msi /qn` | Silent install succeeds |
| Install newer version over old | Old version removed, new installed, settings preserved |
| Uninstall via Add/Remove Programs | Files, shortcuts, registry cleaned; `HKCU\Software\MarkdownView` preserved |

## 10. Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **UpgradeCode GUID lost** | Breaks upgrade chain for existing installs | Commit `wix/main.wxs` immediately; add warning comment in file |
| **File association conflict** | User's default `.md` handler changes | Windows 10+ protects user choice; ProgId registration doesn't override |
| **App running during upgrade** | MSI can't replace locked EXE | Standard MSI: prompts user to close |
| **cargo-wix / WiX v3 end-of-life** | Can't build MSI in future | Low urgency; works today, community tracking v4 support |

## 11. Resolved Questions

1. **License** -- MIT. Copyright Martin Davidson.
2. **Manufacturer** -- "Martin Davidson".
3. **Help URL** -- `https://github.com/0x4D44/mdmdview`.
4. **PATH** -- Cut. GUI app; no terminal use case.
5. **File extensions** -- `.md` and `.markdown` only.
6. **EULA** -- `WixUI_Minimal` shows MIT inline on welcome. `License.rtf` auto-generated by init.
7. **Install directory** -- Flat `C:\Program Files\mdmdview\`. No `bin\`.
