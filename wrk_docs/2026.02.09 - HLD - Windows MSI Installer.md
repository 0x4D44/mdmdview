# HLD: Windows MSI Installer via cargo-wix

**Date:** 2026-02-09
**Status:** Draft
**Author:** Claude (with Arthur)

---

## 1. Summary

Add a proper Windows installer (.msi) for mdmdview using **cargo-wix** (WiX Toolset v3). The installer will handle program installation, Start Menu shortcuts, `.md` file associations, Add/Remove Programs integration, and clean uninstallation -- replacing the current bare-ZIP distribution.

## 2. Background

### Current Distribution Model

mdmdview is currently distributed as a ZIP archive containing a single `mdmdview.exe`. Users must:

1. Download and extract the ZIP
2. Manually place the EXE somewhere on their system
3. Manually configure file associations (right-click `.md` > Open With > Browse)
4. No Start Menu entry, no Add/Remove Programs listing
5. No upgrade path -- just overwrite the EXE

### Problems This Solves

| Problem | MSI Solution |
|---------|-------------|
| No standard install location | Installs to `C:\Program Files\mdmdview\` |
| No file associations | Registers `.md`, `.markdown`, `.mdown`, `.mkd` |
| No Start Menu entry | Creates Start Menu shortcut with icon |
| No Add/Remove Programs | Full ARP entry with version, icon, publisher |
| No upgrade story | MajorUpgrade: new version auto-removes old |
| No uninstall | Clean removal of files, shortcuts, registry |
| No silent/enterprise deploy | Standard `msiexec /qn` support |

## 3. Technology Choice: cargo-wix

**Selected tool:** `cargo-wix` v0.3.9 (latest as of 2025-03)

**Why cargo-wix / MSI:**
- Rust-native toolchain (`cargo install cargo-wix`)
- Produces standard Windows Installer `.msi` packages
- MSI supports silent install (`msiexec /qn`), Group Policy deployment, repair
- Built-in upgrade/downgrade handling via `MajorUpgrade`
- Auto-builds release binary before packaging (or `--no-build` for custom builds)
- De facto standard for Rust projects on Windows

**Prerequisites:**
- WiX Toolset **v3** installed (v3.14.1 recommended) -- download from [wixtoolset/wix3 releases](https://github.com/wixtoolset/wix3/releases)
- `WIX` environment variable pointing to WiX install directory (set automatically by WiX installer)
- cargo-wix does **NOT** support WiX v4/v5/v6 (different CLI tool and XML namespace)

## 4. Installer Scope

### 4.1 What the Installer Does

| Action | Details |
|--------|---------|
| **Install binary** | `mdmdview.exe` to `C:\Program Files\mdmdview\bin\` |
| **Install license** | `LICENSE` to `C:\Program Files\mdmdview\` |
| **Start Menu shortcut** | `Start Menu\Programs\mdmdview\mdmdview.lnk` |
| **File associations** | `.md`, `.markdown`, `.mdown`, `.mkd` registered with "Open with mdmdview" |
| **Add/Remove Programs** | Entry with icon, version, publisher, help URL |
| **PATH (optional)** | User-selectable feature to add `bin\` to system PATH |
| **Upgrade handling** | Auto-removes previous version on upgrade |

### 4.2 What the Installer Does NOT Do

- **Desktop shortcut** -- not created (avoids clutter; user can pin from Start Menu)
- **Auto-start** -- no Run key or startup entry
- **Mermaid assets** -- not needed (embedded in binary at build time)
- **Registry cleanup of app settings** -- `HKCU\Software\MarkdownView` is **preserved** on uninstall (user preference data; removing it would be hostile)
- **`.txt` association** -- intentionally excluded (too aggressive; Notepad owns `.txt`)

### 4.3 File Association Strategy

The installer uses **non-aggressive** file association. Rather than forcibly claiming `.md` files, it registers mdmdview as an available handler via `OpenWithProgIds`. This means:

- On **fresh installs** (no existing `.md` handler): mdmdview becomes the default
- On **systems with existing handlers** (VS Code, Typora, etc.): mdmdview appears in the "Open With" list; the user's current default is preserved
- The `Verb` element registers `open` with `"%1"` argument, matching the app's existing CLI file-opening behavior (`src/main.rs` parses `args[1]` as the file path)

## 5. File Layout

### 5.1 New Files in Repository

```
mdmdview/
├── wix/
│   └── main.wxs              # WiX source XML (generated once, then maintained)
├── LICENSE                    # License file (required for installer; currently missing)
└── ... (existing files)
```

### 5.2 Installed File Layout

```
C:\Program Files\mdmdview\
├── bin\
│   └── mdmdview.exe           # Application binary (~5 MB)
└── LICENSE                    # License file
```

### 5.3 Build Output

```
target\wix\
├── build\
│   └── main.wixobj            # Compiled WiX object (intermediate)
└── mdmdview-1.3.4-x86_64.msi # Final installer (~5 MB)
```

## 6. WiX Source Design (`wix/main.wxs`)

### 6.1 Product Identity

```xml
<Product
    Id='*'
    Name='mdmdview'
    UpgradeCode='<STABLE-GUID>'
    Manufacturer='Martin Davidson'
    Language='1033'
    Codepage='1252'
    Version='$(var.Version)'>
```

**Critical:** The `UpgradeCode` GUID is generated once by `cargo wix init` and must **never change**. It's how Windows identifies all versions as the same product. The `Id='*'` auto-generates per build, which is correct.

### 6.2 Package Settings

```xml
<Package Id='*'
    Description='Markdown viewer for Windows'
    Manufacturer='Martin Davidson'
    InstallerVersion='450'
    Languages='1033'
    Compressed='yes'
    InstallScope='perMachine'
    SummaryCodepage='1252' />
```

- `InstallerVersion='450'` requires Windows Installer 4.5+ (Windows Vista SP2+, all supported Windows)
- `InstallScope='perMachine'` installs to Program Files, requires elevation (UAC prompt)
- Cabinet is embedded (`Compressed='yes'`) for single-file distribution

### 6.3 Upgrade Handling

```xml
<MajorUpgrade
    Schedule='afterInstallInitialize'
    DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>
```

This ensures:
- Installing v1.4.0 over v1.3.4 automatically removes the old version first
- Downgrade attempts are blocked with a clear message
- Same-version reinstall works (repair scenario)

### 6.4 Directory Structure

```xml
<Directory Id='TARGETDIR' Name='SourceDir'>
    <Directory Id='ProgramFiles64Folder' Name='PFiles'>
        <Directory Id='APPLICATIONFOLDER' Name='mdmdview'>
            <!-- LICENSE component here -->
            <Directory Id='Bin' Name='bin'>
                <!-- EXE component here -->
                <!-- PATH component here -->
            </Directory>
        </Directory>
    </Directory>
    <Directory Id='ProgramMenuFolder' Name='Programs'>
        <Directory Id='ApplicationProgramsFolder' Name='mdmdview'/>
    </Directory>
</Directory>
```

### 6.5 Application Binary Component

```xml
<Component Id='binary0' Guid='*'>
    <File Id='exe0'
        Name='mdmdview.exe'
        DiskId='1'
        Source='$(var.CargoTargetBinDir)\mdmdview.exe'
        KeyPath='yes'/>

    <!-- File type: Markdown Document -->
    <ProgId Id='mdmdview.MarkdownFile'
        Description='Markdown Document'
        Icon='exe0' IconIndex='0'>

        <Extension Id='md' ContentType='text/markdown'>
            <Verb Id='open_md' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>

        <Extension Id='markdown' ContentType='text/markdown'>
            <Verb Id='open_markdown' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>

        <Extension Id='mdown' ContentType='text/markdown'>
            <Verb Id='open_mdown' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>

        <Extension Id='mkd' ContentType='text/markdown'>
            <Verb Id='open_mkd' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>
    </ProgId>
</Component>
```

**Notes:**
- `Argument='"%1"'` passes the file path in quotes (handles spaces) -- matches existing CLI behavior in `src/main.rs`
- `Icon='exe0' IconIndex='0'` uses the app's embedded icon for `.md` files in Explorer
- `ContentType='text/markdown'` is the official IANA MIME type (RFC 7763)

### 6.6 Start Menu Shortcut Component

```xml
<Component Id='ApplicationShortcut' Guid='<GUID>'
    Directory='ApplicationProgramsFolder'>
    <Shortcut Id='ApplicationStartMenuShortcut'
        Name='mdmdview'
        Description='Markdown Viewer'
        Target='[#exe0]'
        WorkingDirectory='APPLICATIONFOLDER'
        Icon='ProductICO' />
    <RemoveFolder Id='CleanUpShortcutFolder'
        Directory='ApplicationProgramsFolder'
        On='uninstall'/>
    <RegistryValue Root='HKCU'
        Key='Software\mdmdview\Installer'
        Name='StartMenuShortcut'
        Type='integer' Value='1' KeyPath='yes'/>
</Component>
```

**Notes:**
- Shortcuts can't be KeyPath, so a registry value is used (WiX requirement)
- `RemoveFolder` cleans up the Start Menu folder on uninstall
- `[#exe0]` resolves to the full installed path of the EXE
- Registry key is under `Software\mdmdview\Installer` (separate from the app's `Software\MarkdownView` key)

### 6.7 PATH Component (Optional Feature)

```xml
<Component Id='Path' Guid='<GUID>' KeyPath='yes'>
    <Environment
        Id='PATH'
        Name='PATH'
        Value='[Bin]'
        Permanent='no'
        Part='last'
        Action='set'
        System='yes'/>
</Component>
```

- `Permanent='no'` removes the PATH entry on uninstall
- `Part='last'` appends to PATH (doesn't overwrite)
- Wrapped in a sub-Feature so the user can opt in/out via the installer UI

### 6.8 Feature Tree

```xml
<Feature Id='Binaries'
    Title='mdmdview'
    Description='Markdown viewer application'
    Level='1'
    ConfigurableDirectory='APPLICATIONFOLDER'
    AllowAdvertise='no'
    Display='expand'
    Absent='disallow'>

    <ComponentRef Id='License'/>
    <ComponentRef Id='binary0'/>
    <ComponentRef Id='ApplicationShortcut'/>

    <Feature Id='Environment'
        Title='PATH Environment Variable'
        Description='Add mdmdview to the system PATH (allows running from any terminal)'
        Level='2'
        Absent='allow'>
        <ComponentRef Id='Path'/>
    </Feature>
</Feature>
```

- Main feature (binary + shortcuts + file associations) is **required** (`Absent='disallow'`)
- PATH modification is **optional** (`Absent='allow'`), enabled by default (`Level='1'`)

### 6.9 Add/Remove Programs

```xml
<SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>
<Icon Id='ProductICO' SourceFile='icon.ico'/>
<Property Id='ARPPRODUCTICON' Value='ProductICO' />
<Property Id='ARPHELPLINK' Value='https://github.com/0x4D44/mdmdview'/>
<Property Id='ARPURLINFOABOUT' Value='https://github.com/0x4D44/mdmdview'/>
```

This gives the user a proper Add/Remove Programs entry showing:
- Product name: `mdmdview`
- Version: `1.3.4` (from Cargo.toml)
- Publisher: `Martin Davidson`
- Product icon: the app's `icon.ico`
- Help link: GitHub repository

### 6.10 Installer UI

```xml
<UI>
    <UIRef Id='WixUI_FeatureTree'/>
</UI>

<WixVariable Id='WixUILicenseRtf' Value='wix\License.rtf'/>
```

The `WixUI_FeatureTree` dialog set provides this wizard flow:

```
Welcome → License Agreement → Feature Selection → Install → Finish
```

The Feature Selection step lets users toggle the PATH option. If we don't want a license screen, we can switch to `WixUI_Minimal` or suppress the EULA (see section 7.3).

## 7. Implementation Plan

### 7.1 Prerequisites

1. **Install WiX Toolset v3.14.1** on the dev machine
   - Download `wix314.exe` from [github.com/wixtoolset/wix3/releases](https://github.com/wixtoolset/wix3/releases)
   - Run installer; it sets `WIX` env var automatically
   - Verify: `where candle.exe` should resolve

2. **Install cargo-wix**
   ```bash
   cargo install cargo-wix
   ```

3. **Create LICENSE file** at repo root (currently missing)
   - Content: the project's actual license terms
   - Needed both for the installer payload and for the EULA dialog

### 7.2 Initialization

```bash
cargo wix init
```

This generates `wix/main.wxs` with fresh GUIDs and a template structure. We then **heavily customize** it per sections 6.1-6.10 above (Start Menu, file associations, etc. are not in the default template).

**Critical:** After `cargo wix init`, commit `wix/main.wxs` immediately. The `UpgradeCode` GUID in this file must never change -- re-running `init` generates new GUIDs, which would break upgrade detection.

### 7.3 License File

WiX requires an **RTF** file for the EULA dialog. Options:

- **Option A:** Create `wix/License.rtf` from the LICENSE file (use WordPad, not Word -- cleaner RTF)
- **Option B:** Disable the EULA screen entirely by adding skip-publish elements in the UI and removing the `WixUILicenseRtf` variable. This is appropriate if the license is simple or "as-is."

**Recommendation:** Option B (skip EULA). mdmdview's license is simple and doesn't require agreement. The LICENSE file is still installed to the program directory for reference.

To skip the EULA, replace the UI section with:

```xml
<UI>
    <UIRef Id='WixUI_FeatureTree'/>
    <!-- Skip license dialog -->
    <Publish Dialog='WelcomeDlg' Control='Next'
        Event='NewDialog' Value='CustomizeDlg' Order='2'>1</Publish>
    <Publish Dialog='CustomizeDlg' Control='Back'
        Event='NewDialog' Value='WelcomeDlg' Order='2'>1</Publish>
</UI>
```

### 7.4 Cargo.toml Metadata

Add a `[package.metadata.wix]` section to `Cargo.toml`:

```toml
[package.metadata.wix]
upgrade-guid = "<from cargo wix init>"
path-guid = "<from cargo wix init>"
product-icon = "icon.ico"
eula = false
```

Also update the author/description fields which are currently placeholders:

```toml
[package]
description = "A markdown viewer for Windows"
authors = ["Martin Davidson <martingdavidson@gmail.com>"]
```

### 7.5 Build Command

```bash
# Full build: compile release + create MSI
cargo wix

# Or, separate steps (useful when feature flags matter):
cargo build --release
cargo wix --no-build
```

Output: `target/wix/mdmdview-1.3.4-x86_64.msi`

### 7.6 Testing the Installer

| Test | Command / Action | Expected Result |
|------|-----------------|-----------------|
| **GUI install** | Double-click the `.msi` | Wizard: Welcome → Features → Install → Finish |
| **Verify files** | Check `C:\Program Files\mdmdview\bin\` | `mdmdview.exe` present |
| **Start Menu** | Open Start Menu, search "mdmdview" | Shortcut present, launches app |
| **File association** | Right-click a `.md` file | "Open with mdmdview" appears |
| **Double-click .md** | Double-click any `.md` file | Opens in mdmdview |
| **Add/Remove Programs** | Settings → Apps → search "mdmdview" | Entry with icon, version, Uninstall button |
| **PATH (if enabled)** | Open new terminal, type `mdmdview` | App launches |
| **Silent install** | `msiexec /i mdmdview.msi /qn` | Installs without UI |
| **Upgrade** | Install v1.4.0 over v1.3.4 | Old version removed, new version installed |
| **Uninstall** | Uninstall via Add/Remove Programs | Files removed, shortcuts removed, PATH cleaned, Start Menu folder removed |
| **App settings preserved** | After uninstall, check registry | `HKCU\Software\MarkdownView` still exists |

## 8. CI/CD Integration

### 8.1 GitHub Actions (release.yml)

Extend the existing release workflow to produce both ZIP and MSI artifacts:

```yaml
- name: Install WiX Toolset
  shell: pwsh
  run: |
    $url = "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314.exe"
    Invoke-WebRequest -Uri $url -OutFile wix314.exe
    Start-Process -Wait -FilePath .\wix314.exe -ArgumentList '/install','/quiet','/norestart'

- name: Install cargo-wix
  run: cargo install cargo-wix

- name: Build MSI installer
  run: cargo wix --no-build  # release binary already built in prior step

- name: Package artifacts
  shell: pwsh
  run: |
    # ZIP (existing)
    New-Item -ItemType Directory -Force -Path dist | Out-Null
    Copy-Item target/release/mdmdview.exe dist/mdmdview.exe
    Compress-Archive -Path dist/mdmdview.exe -DestinationPath "mdmdview-${{ github.ref_name }}-windows-x86_64.zip"
    # MSI (new)
    Copy-Item target/wix/*.msi "mdmdview-${{ github.ref_name }}-windows-x86_64.msi"

- name: Upload artifacts
  uses: actions/upload-artifact@v4
  with:
    name: mdmdview-Windows
    path: |
      mdmdview-${{ github.ref_name }}-windows-x86_64.zip
      mdmdview-${{ github.ref_name }}-windows-x86_64.msi
```

The release job's `files: artifacts/*` glob already picks up both `.zip` and `.msi`.

### 8.2 Local Pipeline (ci-local.ps1)

Add an optional `-Installer` flag:

```powershell
if ($Installer) {
    Write-Host "Building MSI installer..."
    cargo wix --no-build
    Write-Host "MSI: target\wix\mdmdview-*.msi"
}
```

## 9. Cargo.toml Changes Summary

```toml
# Before:
[package]
description = "mdmdview"
authors = ["Your Name <your.email@example.com>"]

# After:
[package]
description = "A markdown viewer for Windows"
authors = ["Martin Davidson <martingdavidson@gmail.com>"]
license = "MIT"

[package.metadata.wix]
upgrade-guid = "<generated-by-cargo-wix-init>"
path-guid = "<generated-by-cargo-wix-init>"
product-icon = "icon.ico"
eula = false
```

## 10. Uninstall Behavior

### What Gets Removed

- `C:\Program Files\mdmdview\` directory and all contents
- Start Menu shortcut and program folder
- File associations (`.md`, `.markdown`, `.mdown`, `.mkd` ProgId entries)
- PATH entry (if installed)
- Installer registry key (`HKCU\Software\mdmdview\Installer`)

### What Gets Preserved

- **User settings**: `HKCU\Software\MarkdownView` (window position, size, preferences)
- This is deliberate -- users expect their preferences to survive reinstallation

### Upgrade Behavior

- `MajorUpgrade` removes the old version before installing the new one
- User settings are preserved across upgrades (they live in a different registry hive)
- File associations are updated to point to the new binary location (same path, but WiX handles the Component update)

## 11. Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| **UpgradeCode GUID lost** (regenerated by accident) | Low | High -- breaks upgrade chain | Commit `wix/main.wxs` immediately; document in CLAUDE.md |
| **WiX v3 deprecation** | Medium (long-term) | Medium -- cargo-wix needs update | WiX v3 still works on all Windows; cross that bridge when cargo-wix adds v4 support |
| **File association conflicts** | Medium | Low -- non-destructive | Using ProgId + OpenWithProgIds pattern; doesn't steal associations from other apps |
| **Elevated install fails** | Low | Medium -- user can't install | perMachine is standard for Program Files; could add perUser variant later |
| **WiX not installed in CI** | Low | Low -- build fails clearly | Explicit install step in workflow; WiX install is fast and reliable |
| **Large MSI size** | Low | Low | MSI ≈ binary size (~5 MB) due to embedded cab; acceptable |

## 12. Future Enhancements (Out of Scope)

These are not part of the initial implementation but noted for future consideration:

- **Code signing** -- `cargo wix sign` supports signing via `signtool.exe`; requires a code signing certificate
- **Per-user install variant** -- `InstallScope='perUser'` for non-admin scenarios
- **Auto-update** -- MSI doesn't support auto-update; would need a separate updater component
- **"Open in mdmdview" context menu** -- Shell extension via registry; more complex, could be a follow-up
- **Chocolatey package** -- Community package manager; wraps the MSI
- **WinGet manifest** -- Microsoft's package manager; submit to winget-pkgs repo

## 13. Implementation Steps (Ordered)

1. **Create LICENSE file** at repo root
2. **Update Cargo.toml** metadata (description, authors, license)
3. **Install prerequisites** (WiX v3.14.1, cargo-wix)
4. **Run `cargo wix init`** to generate `wix/main.wxs` with GUIDs
5. **Customize `wix/main.wxs`** per section 6 (file associations, Start Menu, features)
6. **Optionally create `wix/License.rtf`** or configure EULA skip
7. **Build and test locally** (`cargo wix`, then run through test matrix in section 7.6)
8. **Update CI** (`release.yml` and `ci-local.ps1`)
9. **Update CLAUDE.md** with MSI build instructions
10. **Commit** all new files (`wix/main.wxs`, `LICENSE`, Cargo.toml changes)

## 14. Resolved Questions

1. **License text** -- MIT license. Create `LICENSE` at repo root with standard MIT text, copyright Martin Davidson.

2. **Author metadata** -- Manufacturer: "Martin Davidson". Update `Cargo.toml` authors accordingly.

3. **Help URL** -- `https://github.com/0x4D44/mdmdview` confirmed.

4. **PATH default** -- Opt-in (unchecked by default, `Level='2'`). mdmdview is a GUI app; most users launch via Start Menu or file association, not terminal. Power users can check the box during install.
