# 2025.11.07 - HLD - Right Click Context Menu

## Executive Summary

This document outlines the design for implementing a right-click context menu in the mdmdview application. The primary goal is to enable easy copying of selected text while providing additional context-sensitive actions that enhance user productivity. The implementation will leverage egui's built-in context menu capabilities while maintaining the application's clean, minimalist interface.

## Current State Analysis

### Existing Text Interaction
- **Rendered Mode**: Text is displayed using `egui::Label` widgets with `.selectable(false)` for most elements
- **Raw Mode**: Uses `egui::TextEdit::multiline` when write mode is enabled, allowing text selection
- **Write Mode**: Available only in Raw view, enables text editing via `Ctrl+E`
- **No clipboard operations**: Currently no explicit copy/paste functionality except in Raw/Write mode

### Current Mouse Interactions
- **Scrolling**: Mouse wheel/trackpad for vertical scroll
- **Zoom**: Ctrl + Mouse Wheel for font size adjustment
- **Links**: Left-click to follow markdown links
- **No right-click handling**: Currently no context menu implementation

### UI Framework Capabilities
- **egui context menus**: Built-in support via `response.context_menu(|ui| {...})`
- **Clipboard access**: egui provides clipboard integration via `ui.ctx().copy_text(String)`
- **Text selection**: Can be enabled on Label widgets by removing `.selectable(false)`

## Requirements

### Functional Requirements

#### Core Features (P0 - Must Have)
1. **Copy Selected Text**
   - Enable text selection in Rendered mode
   - Copy selected text to clipboard
   - Support for plain text content
   - Preserve formatting for code blocks

2. **Context Menu Activation**
   - Right-click on any text element
   - Right-click on selected text region
   - Keyboard shortcut (Shift+F10 or Menu key)

3. **Visual Feedback**
   - Highlight selected text
   - Show context menu at cursor position
   - Indicate disabled menu items appropriately

#### Extended Features (P1 - Should Have)
4. **Copy with Formatting**
   - Copy as Markdown option
   - Copy as HTML option (for pasting into rich text editors)

5. **Navigation Actions**
   - Go to top/bottom of document
   - Back/Forward navigation (if in history)

6. **Search Integration**
   - Search for selected text
   - Find next/previous occurrence

#### Advanced Features (P2 - Nice to Have)
7. **Link Operations**
   - Copy link URL (when right-clicking links)
   - Open link in browser
   - Copy link text

8. **Image Operations**
   - Copy image (when right-clicking images)
   - Save image as...
   - Copy image path

9. **Table Operations**
   - Copy table as CSV
   - Copy table as Markdown
   - Copy selected cells

### Non-Functional Requirements

1. **Performance**
   - Menu should appear within 50ms of right-click
   - Text selection should not impact rendering performance
   - Large documents (1000+ lines) should remain responsive

2. **Accessibility**
   - Keyboard navigation within menu
   - Screen reader compatible
   - High contrast mode support

3. **Consistency**
   - Follow Windows context menu conventions
   - Maintain visual consistency with existing UI
   - Respect dark/light theme

## Design Decisions

### Architecture Approach

#### Component Structure
```
MarkdownViewerApp
├── ContextMenuState (new)
│   ├── menu_position: Option<Pos2>
│   ├── selected_text: String
│   ├── selection_range: Option<(usize, usize)>
│   ├── context_type: ContextType
│   └── available_actions: Vec<MenuAction>
│
├── SelectionState (new)
│   ├── start_pos: Option<usize>
│   ├── end_pos: Option<usize>
│   ├── selecting: bool
│   └── selected_elements: Vec<ElementId>
│
└── MarkdownRenderer (modified)
    ├── enable_text_selection: bool
    └── selection_highlights: HashMap<ElementId, SelectionRange>
```

#### Context Types
```rust
enum ContextType {
    Text,           // Regular text
    Code,           // Code block
    Link(String),   // Link with URL
    Image(String),  // Image with path
    Table,          // Table element
    Empty,          // No specific context
}
```

#### Menu Actions
```rust
enum MenuAction {
    Copy,
    CopyAsMarkdown,
    CopyAsHtml,
    SelectAll,
    Search,
    CopyLink,
    OpenLink,
    SaveImageAs,
    CopyImagePath,
    CopyTable,
    // Navigation
    GoToTop,
    GoToBottom,
    Back,
    Forward,
}
```

### Implementation Strategy

#### Phase 1: Basic Context Menu with Copy
1. Enable text selection on all Label widgets in Rendered mode
2. Implement basic right-click detection
3. Create context menu with Copy action
4. Integrate with system clipboard

#### Phase 2: Context-Sensitive Actions
1. Detect element type under cursor
2. Build appropriate menu items based on context
3. Implement specialized copy formats
4. Add link and image operations

#### Phase 3: Extended Features
1. Implement search integration
2. Add navigation shortcuts
3. Table operations
4. Keyboard shortcuts for menu

### UI/UX Design

#### Menu Layout
```
┌─────────────────────────┐
│ Copy            Ctrl+C  │
│ Copy as Markdown        │
│ ─────────────────────   │
│ Select All     Ctrl+A   │
│ Search...      Ctrl+F   │
│ ─────────────────────   │
│ Go to Top      Home     │
│ Go to Bottom   End      │
└─────────────────────────┘
```

#### Selection Visualization
- **Text selection**: Light blue background (respecting theme)
- **Hover state**: Subtle underline or highlight
- **Selected state**: Consistent with OS selection color

#### Context-Specific Menus

**For Links:**
```
┌─────────────────────────┐
│ Open Link               │
│ Copy Link Text          │
│ Copy Link URL           │
│ ─────────────────────   │
│ Select All     Ctrl+A   │
└─────────────────────────┘
```

**For Images:**
```
┌─────────────────────────┐
│ Copy Image              │
│ Save Image As...        │
│ Copy Image Path         │
│ ─────────────────────   │
│ View Full Size          │
└─────────────────────────┘
```

**For Code Blocks:**
```
┌─────────────────────────┐
│ Copy Code               │
│ Copy with Syntax        │
│ ─────────────────────   │
│ Select All in Block     │
└─────────────────────────┘
```

## Technical Implementation

### Key Code Changes

#### 1. Enable Text Selection (`markdown_renderer.rs`)
```rust
// Remove .selectable(false) from labels
// Add selection tracking
impl MarkdownRenderer {
    fn render_text_with_selection(
        &self,
        ui: &mut egui::Ui,
        text: &str,
        element_id: usize,
    ) -> egui::Response {
        let response = ui.label(text);

        if response.clicked() {
            self.handle_text_click(element_id);
        }

        if response.secondary_clicked() {
            self.show_context_menu(ui, element_id);
        }

        response
    }
}
```

#### 2. Context Menu Implementation (`app.rs`)
```rust
impl MarkdownViewerApp {
    fn show_context_menu(&mut self, ui: &mut egui::Ui) {
        if let Some(selected_text) = &self.get_selected_text() {
            ui.menu_button("Copy", |ui| {
                if ui.button("Copy").clicked() {
                    ui.ctx().copy_text(selected_text.clone());
                    ui.close_menu();
                }

                if ui.button("Copy as Markdown").clicked() {
                    let markdown = self.selection_to_markdown();
                    ui.ctx().copy_text(markdown);
                    ui.close_menu();
                }
            });
        }
    }
}
```

#### 3. Selection Management (`app.rs`)
```rust
impl SelectionState {
    fn update(&mut self, response: &egui::Response, element_id: usize) {
        if response.dragged() {
            // Handle drag selection
            if !self.selecting {
                self.start_pos = Some(element_id);
                self.selecting = true;
            }
            self.end_pos = Some(element_id);
        }

        if response.drag_released() {
            self.selecting = false;
        }
    }

    fn get_selected_text(&self, elements: &[MarkdownElement]) -> String {
        // Extract text from selected elements
        let mut text = String::new();
        for id in &self.selected_elements {
            if let Some(element) = elements.get(*id) {
                text.push_str(&element.to_plain_text());
                text.push('\n');
            }
        }
        text
    }
}
```

### Integration Points

1. **Clipboard Integration**
   - Use `egui::Context::copy_text()` for copying
   - Handle platform-specific clipboard formats

2. **Keyboard Shortcuts**
   - Ctrl+C for copy
   - Ctrl+A for select all
   - Shift+F10 for context menu

3. **Theme Integration**
   - Use `ui.visuals().selection` for colors
   - Respect dark/light mode

## Testing Strategy

### Unit Tests
```rust
#[cfg(test)]
mod tests {
    #[test]
    fn test_text_selection() {
        // Test selection range calculation
    }

    #[test]
    fn test_context_menu_items() {
        // Test menu item generation based on context
    }

    #[test]
    fn test_clipboard_formatting() {
        // Test various copy format conversions
    }
}
```

### Integration Tests
1. **Selection Tests**
   - Click and drag selection
   - Shift+click selection
   - Double-click word selection
   - Triple-click line selection

2. **Context Menu Tests**
   - Right-click on different element types
   - Keyboard navigation in menu
   - Disabled state for unavailable actions

3. **Clipboard Tests**
   - Copy plain text
   - Copy formatted text
   - Copy across different element types

### Manual Testing Scenarios
1. Select text across multiple paragraphs
2. Right-click on links, images, tables
3. Test with large documents (performance)
4. Test keyboard-only navigation
5. Test with different themes
6. Test on different Windows versions

## Migration Path

### Phase 1 (Week 1)
- Implement basic text selection
- Add simple context menu with Copy
- Basic clipboard integration

### Phase 2 (Week 2)
- Context detection
- Specialized copy formats
- Link operations

### Phase 3 (Week 3)
- Image operations
- Table operations
- Search integration
- Polish and optimization

## Performance Considerations

1. **Selection Rendering**
   - Cache selection ranges
   - Only re-render affected elements
   - Use `ui.ctx().request_repaint_of()` for partial updates

2. **Large Documents**
   - Virtual scrolling for selection
   - Lazy element selection calculation
   - Debounce selection updates

3. **Clipboard Operations**
   - Async clipboard operations for large content
   - Progress indicator for slow operations
   - Cancel mechanism for long-running copies

## Security Considerations

1. **Clipboard Security**
   - Sanitize HTML output to prevent XSS
   - Validate URLs before opening
   - Limit clipboard size to prevent memory issues

2. **File System Access**
   - Validate paths for Save Image As
   - Prevent directory traversal
   - Use safe file dialogs

## Accessibility

1. **Keyboard Navigation**
   - Full keyboard support for all operations
   - Clear focus indicators
   - Logical tab order

2. **Screen Reader Support**
   - ARIA labels for menu items
   - Announce selection changes
   - Context descriptions

## Future Enhancements

1. **Multi-format Clipboard**
   - Support multiple clipboard formats simultaneously
   - Rich text formatting preservation
   - Custom clipboard formats

2. **Advanced Selection**
   - Column selection in tables
   - Smart selection (expand to word/sentence/paragraph)
   - Regex-based selection

3. **Extended Operations**
   - Translate selected text
   - Define word (dictionary lookup)
   - Share selected text
   - Print selection

4. **Customization**
   - User-configurable context menu
   - Custom keyboard shortcuts
   - Plugin system for menu extensions

## Dependencies and Risks

### Dependencies
- egui 0.29+ (for context menu support)
- clipboard crate (if egui clipboard insufficient)
- No additional dependencies expected

### Risks
1. **Performance Impact**: Text selection might slow down rendering
   - Mitigation: Optimize selection rendering, use partial updates

2. **Platform Differences**: Clipboard behavior varies by OS
   - Mitigation: Test on multiple Windows versions, handle edge cases

3. **Complexity Growth**: Feature creep in context menu
   - Mitigation: Stick to phases, prioritize core features

## Appendix A: egui Context Menu Examples

```rust
// Basic context menu
response.context_menu(|ui| {
    if ui.button("Copy").clicked() {
        // Handle copy
        ui.close_menu();
    }
});

// Nested menu
response.context_menu(|ui| {
    ui.menu_button("Copy as...", |ui| {
        if ui.button("Plain Text").clicked() {
            // Handle plain text copy
            ui.close_menu();
        }
        if ui.button("Markdown").clicked() {
            // Handle markdown copy
            ui.close_menu();
        }
    });
});

// Conditional menu items
response.context_menu(|ui| {
    ui.add_enabled_ui(has_selection, |ui| {
        if ui.button("Copy").clicked() {
            // Handle copy
            ui.close_menu();
        }
    });
});
```

## Appendix B: Selection State Machine

```
States:
- IDLE: No selection
- SELECTING: Mouse down, dragging
- SELECTED: Mouse up, text selected

Transitions:
IDLE -> SELECTING: Mouse down on text
SELECTING -> SELECTED: Mouse up
SELECTED -> IDLE: Click elsewhere or ESC
SELECTED -> SELECTING: Shift+Click for extend
```

## Conclusion

This design provides a comprehensive approach to implementing a right-click context menu in mdmdview. The phased implementation allows for iterative development and testing while maintaining application stability. The core copy functionality addresses the immediate user need, while the extended features provide a roadmap for enhanced usability.

The design prioritizes:
1. User experience consistency with Windows standards
2. Performance for large documents
3. Extensibility for future enhancements
4. Accessibility for all users

Implementation should begin with Phase 1 to deliver immediate value, then progressively add features based on user feedback and priorities.