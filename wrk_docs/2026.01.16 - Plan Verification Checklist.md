# Plan Verification Checklist

Cross-referencing ALL agent investigation findings against the implementation plan.

## Mermaid Investigation Agent Findings

| Finding | Severity | In Plan? | Stage/Issue # |
|---------|----------|----------|---------------|
| egui TextureHandle retains memory when evicted from cache | CRITICAL | ✅ | Stage 7 (research) |
| RGBA data accumulation in channel results queue | MODERATE | ✅ | Issue #21 (bounded by channel capacity) |
| SVG string cache has no SIZE-based eviction (64 entries × 10MB = 640MB) | MODERATE | ⚠️ | Issue #13 notes "can be large" but no action |
| `mermaid_pending` unbounded HashSet | LOW | ✅ | Issue #8 (self-limiting) |
| `mermaid_errors` unbounded maps | LOW | ✅ | Issue #14 (LRU bounded) |
| QuickJS 2GB per worker memory limit | MODERATE | ✅ | Stage 4 |
| JS `__mdmdview_text_cache` unbounded | MODERATE | ✅ | Stage 5 |
| Font database never explicitly cleaned | LOW | ❌ | NOT IN PLAN |

## Texture Cache Investigation Agent Findings

| Finding | Severity | In Plan? | Stage/Issue # |
|---------|----------|----------|---------------|
| `emoji_textures` unbounded HashMap | CRITICAL | ✅ | Stage 2 |
| `image_textures` bounded (256) | OK | ✅ | Issue #11 |
| `image_failures` unbounded HashMap | HIGH | ✅ | Stage 3 |
| Mermaid texture cache bounded (128) | OK | ✅ | Issue #12 |
| Single renderer instance across files (caches accumulate) | INFO | ✅ | Addressed by Stages 2, 3, 6 |

## Collections Investigation Agent Findings

| Finding | Severity | In Plan? | Stage/Issue # |
|---------|----------|----------|---------------|
| `emoji_textures` unbounded | CRITICAL | ✅ | Stage 2 |
| `image_failures` unbounded | HIGH | ✅ | Stage 3 |
| `column_stats_cache` unbounded within file | MEDIUM | ✅ | Issue #10 (cleared between files) |
| `header_rects` cleared per frame | OK | ✅ | Issue #17 |
| `element_rects` cleared per frame | OK | ✅ | Issue #18 |
| Navigation history bounded (50) | OK | ✅ | Issue #19 |
| `pending_files` bounded (50) | OK | ✅ | Issue #20 |
| `image_textures` bounded (256) | OK | ✅ | Issue #11 |
| `table_layout_cache` bounded (512) | OK | ✅ | Issue #16 |
| `mermaid_*` caches bounded | OK | ✅ | Issues #12-15 |
| `image_pending` HashSet unbounded | LOW | ✅ | Issue #9 (bounded by IMAGE_MAX_PENDING) |

## QuickJS Investigation Agent Findings

| Finding | Severity | In Plan? | Stage/Issue # |
|---------|----------|----------|---------------|
| Runtime per-worker creation (correct) | OK | ✅ | Documented |
| Runtime not recreated per-render (correct) | OK | ✅ | Documented |
| Thread cleanup on exit (correct) | OK | ✅ | Documented |
| JS value lifetime context-scoped (correct) | OK | ✅ | Documented |
| Global JS state (`__mdmdview_text_cache`) not cleaned | MEDIUM | ✅ | Stage 5 |
| No explicit QuickJS GC triggers | LOW | ⚠️ | NOT explicitly addressed |
| 2GB memory limit per worker excessive | MODERATE | ✅ | Stage 4 |

---

## GAPS IDENTIFIED

### Gap 1: Font Database Cleanup (LOW priority)

**Agent Finding**: "Font database is shared via Arc across all workers. When last worker exits, it's dropped."

**Current Status**: Not addressed in plan.

**Assessment**: The font database is loaded once at startup and shared. It's not a leak - it's a fixed overhead (~10-50MB). Only freed on application exit, which is correct behavior.

**Recommendation**: No action needed. This is expected behavior.

### Gap 2: SVG Cache Size-Based Eviction (MODERATE priority)

**Agent Finding**: "SVG string cache (64 entries) could hold 640MB+ of SVG strings."

**Current Status**: Plan Issue #13 notes "individual SVGs can be large but count capped" but takes no action.

**Assessment**: While entry-count bounded, total memory could be 640MB. This is a potential concern.

**Recommendation**: Consider adding size-based eviction OR document as acceptable.

### Gap 3: QuickJS GC Triggers (LOW priority)

**Agent Finding**: "No explicit calls to QuickJS GC triggers between renders."

**Current Status**: Not addressed in plan.

**Assessment**: GC happens implicitly when Context is dropped. Stage 5's text cache clearing provides some relief. Additional explicit GC could help but is low priority.

**Recommendation**: Consider adding `ctx.gc()` call after heavy rendering, OR document as acceptable.

---

## SUMMARY

| Category | Total | Covered | Coverage |
|----------|-------|---------|----------|
| Critical issues | 2 | 2 | 100% |
| High issues | 1 | 1 | 100% |
| Moderate issues | 5 | 5 | 100% |
| Low/OK items | 17 | 15 | 88% |
| **Overall** | **25** | **23** | **92%** |

### Uncovered Items (Low Priority)

1. Font database cleanup - Not a leak, expected behavior
2. SVG cache size-based eviction - Bounded by count, could be large
3. Explicit QuickJS GC - Implicit GC exists, explicit could help

---

## DECISION NEEDED

Are these 3 low-priority gaps acceptable, or should they be added to the plan?

1. **Font database**: No action recommended (not a leak)
2. **SVG cache size**: Could add size-based eviction (P6?)
3. **QuickJS GC**: Could add explicit GC call (P7?)

