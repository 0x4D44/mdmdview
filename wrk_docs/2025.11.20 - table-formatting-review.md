# Table Formatting Code Review (2025-11-20)

## Scope
- Reviewed: src/markdown_renderer.rs, src/table_support/column_spec.rs, src/table_support/metrics.rs.
- Considered both renderers: legacy egui::Grid and default TableBuilder "wrap overhaul".

## Findings
1) Table cell parser drops content: `collect_cell_spans` handles only text/code/basic styling and ignores soft/hard breaks and images, so newlines collapse and images inside cells disappear (`src/markdown_renderer.rs:1412-1460`). Link bodies are flattened to plain text, losing nested formatting.
2) Table IDs collide between identical tables: `compute_table_id` hashes base_dir + content hash (first 128 rows) but not element position, so two identical tables share cached widths/heights and user resizes bleed across (`src/markdown_renderer.rs:2942-2964`).
3) Header height fixed to 28px: TableBuilder uses a constant height (`HEADER_HEIGHT`, `src/markdown_renderer.rs:3337,3379`), clipping wrapped headers or zoomed text.
4) Row heights settle a frame late: `heterogeneous_rows` is fed hints from the prior frame (`row_height_hint` at `src/markdown_renderer.rs:3366-3449`); `update_row_height` runs after rendering without requesting repaint, so taller content can be clipped for a frame after edits/zoom.
5) Extra columns ignore stats: when rows have more cells than headers, added specs default to `Remainder` without using computed stats, so wide trailing columns are mis-sized (`src/markdown_renderer.rs:3331-3348`).
6) Column policy heuristics are rigid: only one column can become `Remainder` and the first column is always `Fixed`, even if it holds the longest text (`src/table_support/column_spec.rs:190-274`), leading to clipped multi-text tables.
7) Unicode width is underestimated: column stats use grapheme counts, not display width, so CJK/fullwidth columns get overly small preferred widths (`src/table_support/column_spec.rs:394-437`).
8) Legacy renderer overestimates images: `measure_inline_spans` assigns `ui.available_width()` to any image span, inflating desired widths to the viewport when images are used in tables (`src/markdown_renderer.rs:2073-2109`).

## Improvement Suggestions
- Reuse the general inline parser for table cells (with breaks, images, nested spans) and add tests covering soft/hard breaks, links with styling, and images inside cells.
- Make table IDs include the parse-order index (or another stable per-element key) so cached widths/heights do not bleed between distinct tables; clear caches when the element count changes.
- Dynamically size headers: measure header cell height via `render_overhauled_cell`/galley before calling `TableBuilder::header`, or derive height from font metrics instead of the 28px constant.
- Avoid one-frame clipping: precompute row heights (second pass or galley measurement) or call `ctx.request_repaint()` when a measured height exceeds the hint.
- Derive column specs for the full column count (including extra cells), allow multiple remainder/weighted remainder columns, and relax the “first column is fixed” rule when stats show long text.
- Use width estimations that account for CJK/fullwidth glyphs (e.g., `unicode_width` or egui measurements) and add regression tests for CJK-heavy tables.
- For the legacy renderer, use cached image dimensions (or a conservative thumbnail width) instead of `available_width()` to keep width solving stable when images appear in cells.
