# PLN - Regression Visual Test Suite Implementation Plan

Date: 2025.12.25

## Goals
- Build a deterministic, repeatable visual regression suite for mdmdview.
- Compare mdmdview screenshots to a pinned reference renderer.
- Provide clear artifacts (diffs, reports) locally and in CI.

## Stage 0 - Foundation Decisions (Design Lock)
**Outcome:** Finalize tooling and baseline choices.
- Choose the reference renderer toolchain (recommend cmark-gfm + Playwright).
- Decide whether mdscreensnap is local-only or CI-capable.
- Select a canonical CSS and font bundle to approximate mdmdview.
- Define minimum OS/runner for CI (Windows, fixed runner type).
- Finalize manifest schema and case list for v1.

**Exit criteria:**
- Decision log recorded in the plan or README.
- Manifest schema draft complete.

## Stage 1 - Test Corpus + Manifest
**Outcome:** A curated, structured markdown corpus and manifest.
- Create `/tests/regression/cases` markdown docs and `/tests/regression/assets`.
- Add 10-15 initial cases covering key features (tables, images, emoji, mermaid, unicode, large doc).
- Write `manifest.toml` with viewport/theme/zoom/table wrap settings and per-case tolerances.
- Add README in `/tests/regression/` describing corpus conventions and how to add new cases.

**Exit criteria:**
- Corpus folder structure exists.
- Manifest parses and includes all cases.
- Cases render in the app manually without errors.

## Stage 2 - mdmdview Screenshot Mode
**Outcome:** Deterministic, scriptable screenshot capture.
- Add CLI flags for screenshot mode:
  - `--screenshot`, `--output`, `--width`, `--height`, `--theme`, `--zoom`, `--content-only`, `--scroll`, `--wait-ms`, `--settle-frames`, `--test-fonts`.
- Implement content-only capture (hide chrome, crop to document area).
- Add deterministic render settle logic:
  - Wait for images to load and Mermaid renders to finish.
  - Require N stable frames or timeout.
- Emit metadata JSON alongside PNG output.

**Exit criteria:**
- Single markdown file can be captured deterministically from CLI.
- Metadata JSON includes version, flags, viewport, theme, and timing.

## Stage 3 - Reference Renderer Adapter
**Outcome:** Canonical outputs for each case.
- Implement `tools/regression/reference_runner` using chosen toolchain.
- Pin renderer version and Playwright/Chromium version.
- Load canonical CSS and font bundle, render HTML, capture PNG.
- Emit `reference.html`, `reference.png`, `reference.json`.

**Exit criteria:**
- Reference outputs generated for at least 3 cases.
- Metadata includes renderer version, CSS hash, viewport, DPR.

## Stage 4 - Regression Runner + Diffing
**Outcome:** Single-command comparison workflow.
- Implement runner (Python or xtask) that:
  - Reads manifest, runs reference adapter if needed.
  - Runs mdmdview screenshot capture per case/snapshot.
  - Computes image diffs (pixel diff + optional SSIM).
  - Outputs diff images and summary report.
- Add thresholds and ignore masks per case.

**Exit criteria:**
- `regress run` produces diffs and a summary report.
- At least one case passes/fails correctly based on diff threshold.

## Stage 5 - CI Integration + Artifacts
**Outcome:** Automated regression checks.
- Add CI job on Windows to run a smoke subset.
- Upload diff images and reports as artifacts.
- Cache Playwright browsers and reference outputs to reduce time.

**Exit criteria:**
- CI runs on PRs and produces artifacts.
- Failures reported when diffs exceed thresholds.

## Stage 6 - Documentation + Developer UX
**Outcome:** Clear instructions and maintenance practices.
- Document how to add/update cases and baselines.
- Add guidelines for tolerances and masks.
- Add troubleshooting steps for flaky diffs.

**Exit criteria:**
- `/tests/regression/README.md` and top-level README updated.

## Risks and Mitigations
- **Font variance:** bundle fonts; enforce CI on Windows.
- **Render flakiness:** stable-frame wait logic; retry capture once.
- **Baseline drift:** lock tool versions and hash CSS/assets.
- **Storage growth:** use small initial corpus; monitor size; consider git-lfs.

## Optional Follow-ups
- Add edge-based/perceptual diff mode to reduce noise.
- Add anchor-based snapshot locations in manifest.
- Expand corpus to cover more edge cases.
