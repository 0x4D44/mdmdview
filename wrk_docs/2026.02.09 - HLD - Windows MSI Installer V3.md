# HLD: Windows MSI Installer via cargo-wix (V3)

**Date:** 2026-02-09
**Status:** Draft
**Author:** Claude (with Arthur)
**Changes from V2:** Fixed critical WixUI_Minimal license requirement (RTF needed or build fails). Removed orphaned `path-guid`. Standardized Component GUIDs. Added Media element. Added test checklist. Added silent install note.

---

## 1. Summary

Add a Windows installer (.msi) for mdmdview using **cargo-wix**. The installer handles: install to Program Files, Start Menu shortcut, `.md` file association, Add/Remove Programs entry, upgrade, and clean uninstall.

## 2. Why

mdmdview is currently distributed as a bare ZIP. Users must manually place the EXE, manually set up file associations, and have no upgrade or uninstall path. An MSI gives them a standard Windows install experience.

**Tool choice:** `cargo-wix` v0.3.9 -- Rust-native, produces standard MSI packages, de facto standard for Rust on Windows. Requires WiX Toolset v3 (v3.14.1).

## 3. Scope

### What the Installer Does

| Action | Details |
|--------|---------|
| **Install binary** | `mdmdview.exe` to `C:\Program Files\mdmdview\` |
| **Install license** | `LICENSE` (MIT) to same directory |
| **Start Menu shortcut** | `Start Menu\Programs\mdmdview\mdmdview.lnk` |
| **File associations** | `.md` and `.markdown` registered |
| **Add/Remove Programs** | Entry with icon, version, publisher, GitHub link |
| **Upgrade** | New version auto-removes old via `MajorUpgrade` |

### What It Does NOT Do

- **Desktop shortcut** -- user can pin from Start Menu if desired
- **PATH modification** -- this is a GUI app, not a CLI tool
- **`.txt` association** -- too aggressive; `.txt` belongs to Notepad
- **`.mdown` / `.mkd` association** -- effectively extinct extensions
- **Delete user settings on uninstall** -- `HKCU\Software\MarkdownView` (window position, preferences) is preserved

### File Association Strategy

The installer registers a `ProgId` with `<Extension>` elements for `.md` and `.markdown`. On Windows 10+, this makes mdmdview available as a handler but does **not** forcibly override the user's current default -- Windows protects user choice. On a fresh system with no existing handler, mdmdview becomes the default.

The `Verb` argument is `"%1"`, matching the app's existing CLI behavior (`src/main.rs` parses the first positional arg as a file path).

## 4. Repository File Layout

New files added to the repo:

```
mdmdview/
├── wix/
│   ├── main.wxs         # WiX source XML (generated once by cargo wix init, then customized)
│   └── License.rtf      # MIT license in RTF format (required by WixUI_Minimal)
├── LICENSE              # MIT license (plain text, installed to Program Files)
└── ... (existing files)
```

## 5. Installed Layout

```
C:\Program Files\mdmdview\
    mdmdview.exe    (~5 MB)
    LICENSE
```

No `bin\` subdirectory -- single-binary app, flat is simpler.

## 6. WiX Source Design (`wix/main.wxs`)

### 6.1 Product Identity

```xml
<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
    <Product
        Id='*'
        Name='mdmdview'
        UpgradeCode='<STABLE-GUID>'
        Manufacturer='Martin Davidson'
        Language='1033'
        Codepage='1252'
        Version='$(var.Version)'>
```

**Critical:** `UpgradeCode` is generated once by `cargo wix init` and must **never change**. It's how Windows identifies all versions as the same product. Commit `wix/main.wxs` immediately after generation.

### 6.2 Package + Media

```xml
<Package Id='*'
    Description='Markdown viewer for Windows'
    Manufacturer='Martin Davidson'
    InstallerVersion='450'
    Languages='1033'
    Compressed='yes'
    InstallScope='perMachine'
    SummaryCodepage='1252' />

<MajorUpgrade
    Schedule='afterInstallInitialize'
    DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>

<Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1'/>
```

- `perMachine` installs to Program Files, triggers UAC prompt
- Cabinet embedded for single-file distribution
- `MajorUpgrade`: new version auto-removes old; downgrade blocked; same-version reinstall works (repair)
- **Known limitation:** If mdmdview is running during upgrade, MSI cannot replace the locked EXE and will prompt the user to close the application. Standard MSI behavior; no special handling needed.

### 6.3 Directory Structure

```xml
<Directory Id='TARGETDIR' Name='SourceDir'>
    <Directory Id='ProgramFiles64Folder' Name='PFiles'>
        <Directory Id='APPLICATIONFOLDER' Name='mdmdview'>
            <!-- binary0, License components here (flat) -->
        </Directory>
    </Directory>
    <Directory Id='ProgramMenuFolder' Name='Programs'>
        <Directory Id='ApplicationProgramsFolder' Name='mdmdview'/>
    </Directory>
</Directory>
```

### 6.4 Binary + File Association Component

```xml
<Component Id='binary0' Guid='*'>
    <File Id='exe0'
        Name='mdmdview.exe'
        DiskId='1'
        Source='$(var.CargoTargetBinDir)\mdmdview.exe'
        KeyPath='yes'/>

    <ProgId Id='mdmdview.MarkdownFile'
        Description='Markdown Document'
        Icon='exe0' IconIndex='0'>

        <Extension Id='md' ContentType='text/markdown'>
            <Verb Id='open_md' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>

        <Extension Id='markdown' ContentType='text/markdown'>
            <Verb Id='open_markdown' Command='Open' TargetFile='exe0' Argument='"%1"' />
        </Extension>
    </ProgId>
</Component>
```

- `ContentType='text/markdown'` is the official IANA MIME type (RFC 7763)
- `Icon='exe0'` uses the app's embedded icon for `.md` files in Explorer
- `Argument='"%1"'` passes the file path in quotes (handles spaces)

### 6.5 License Component

```xml
<Component Id='License' Guid='*'>
    <File Id='LicenseFile'
        Name='LICENSE'
        DiskId='1'
        Source='LICENSE'
        KeyPath='yes'/>
</Component>
```

### 6.6 Start Menu Shortcut Component

```xml
<Component Id='ApplicationShortcut' Guid='*'
    Directory='ApplicationProgramsFolder'>
    <Shortcut Id='ApplicationStartMenuShortcut'
        Name='mdmdview'
        Description='Markdown Viewer'
        Target='[#exe0]'
        WorkingDirectory='APPLICATIONFOLDER'
        Icon='ProductICO' />
    <RemoveFolder Id='CleanUpShortcutFolder'
        Directory='ApplicationProgramsFolder'
        On='uninstall'/>
    <RegistryValue Root='HKCU'
        Key='Software\mdmdview\Installer'
        Name='StartMenuShortcut'
        Type='integer' Value='1' KeyPath='yes'/>
</Component>
```

WiX requires a registry value as KeyPath for shortcut components. `RemoveFolder` cleans up the Start Menu folder on uninstall. Registry key is `Software\mdmdview\Installer` (separate from the app's `Software\MarkdownView`).

### 6.7 Feature (Single)

```xml
<Feature Id='Complete'
    Title='mdmdview'
    Description='Markdown viewer application'
    Level='1'
    ConfigurableDirectory='APPLICATIONFOLDER'
    AllowAdvertise='no'
    Absent='disallow'>

    <ComponentRef Id='binary0'/>
    <ComponentRef Id='License'/>
    <ComponentRef Id='ApplicationShortcut'/>
</Feature>
```

Single, required feature. No sub-features needed. `ConfigurableDirectory` has no visible effect with `WixUI_Minimal` (no directory picker dialog), but allows custom install paths via silent install: `msiexec /i mdmdview.msi APPLICATIONFOLDER="D:\Tools\mdmdview" /qn`.

### 6.8 Add/Remove Programs

```xml
<SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>
<Icon Id='ProductICO' SourceFile='icon.ico'/>
<Property Id='ARPPRODUCTICON' Value='ProductICO' />
<Property Id='ARPHELPLINK' Value='https://github.com/0x4D44/mdmdview'/>
```

### 6.9 Installer UI

```xml
<UI>
    <UIRef Id='WixUI_Minimal'/>
</UI>

<WixVariable Id='WixUILicenseRtf' Value='wix\License.rtf'/>
```

`WixUI_Minimal` provides: **Welcome (with inline MIT license text) -> Install -> Finish**. No feature selection, no directory picker. The `WixUILicenseRtf` is required -- `WixUI_Minimal` shows the license inline on the welcome page and the build fails (LGHT0094) without it.

`wix/License.rtf` is a simple RTF rendering of the MIT license. Create with WordPad (not Word) for clean RTF.

## 7. Uninstall Behavior

**Removed:**
- `C:\Program Files\mdmdview\` directory and all contents
- Start Menu shortcut and folder
- File association registry entries (ProgId, extensions)
- Installer registry key (`HKCU\Software\mdmdview\Installer`)

**Preserved:**
- `HKCU\Software\MarkdownView` -- user settings (window position, preferences). Removing these on uninstall would be hostile; users expect preferences to survive reinstall.

## 8. Implementation Steps

1. Create `LICENSE` at repo root (MIT, copyright Martin Davidson)
2. Create `wix/License.rtf` (MIT license in RTF format)
3. Update `Cargo.toml`: description, authors, license, `[package.metadata.wix]`
4. Install prerequisites: WiX Toolset v3.14.1, `cargo install cargo-wix`
5. Run `cargo wix init` to generate `wix/main.wxs` with stable GUIDs
6. Customize `wix/main.wxs` per section 6 (flat directory, file associations, Start Menu, Minimal UI)
7. Build and test: `cargo wix`, then run through test checklist (section 9)
8. Update `release.yml` to produce MSI alongside ZIP
9. Add MSI build instructions to `CLAUDE.md`

### Build Commands

```bash
# Full build (compiles release + creates MSI):
cargo wix

# Separate steps (useful with custom feature flags):
cargo build --release
cargo wix --no-build

# Silent install (for testing or enterprise deployment):
msiexec /i target\wix\mdmdview-1.3.4-x86_64.msi /qn
```

Output: `target\wix\mdmdview-<version>-x86_64.msi`

### Cargo.toml Changes

```toml
# Update existing fields:
[package]
description = "A markdown viewer for Windows"
authors = ["Martin Davidson <martingdavidson@gmail.com>"]
license = "MIT"

# Add new section:
[package.metadata.wix]
upgrade-guid = "<generated-by-cargo-wix-init>"
product-icon = "icon.ico"
eula = false
```

## 9. Test Checklist

| Test | Expected Result |
|------|----------------|
| Double-click `.msi` | UAC prompt, then: Welcome (with MIT license) -> Install -> Finish |
| Check `C:\Program Files\mdmdview\` | `mdmdview.exe` and `LICENSE` present |
| Start Menu search "mdmdview" | Shortcut present; launches app correctly |
| Right-click `.md` file -> Open With | "mdmdview" appears as an option |
| Double-click `.md` file | Opens in mdmdview (if set as default) |
| Settings -> Apps -> "mdmdview" | Entry with correct icon, version, Uninstall button |
| `msiexec /i mdmdview.msi /qn` | Silent install succeeds |
| Install newer version over old | Old version removed, new version installed, settings preserved |
| Uninstall via Add/Remove Programs | All files, shortcuts, registry entries removed; `HKCU\Software\MarkdownView` preserved |

## 10. Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| **UpgradeCode GUID lost** | Breaks upgrade chain for existing installs | Commit `wix/main.wxs` immediately; add warning comment in file |
| **File association conflict** | User's default `.md` handler changes unexpectedly | Windows 10+ protects user choice; ProgId registration doesn't override |
| **App running during upgrade** | MSI can't replace locked EXE | Standard MSI: prompts user to close. No special handling needed |
| **cargo-wix / WiX v3 deprecation** | Can't build MSI in future | Low urgency; WiX v3 works today |

## 11. Resolved Questions

1. **License** -- MIT. Standard MIT text, copyright Martin Davidson.
2. **Manufacturer** -- "Martin Davidson" in all installer metadata.
3. **Help URL** -- `https://github.com/0x4D44/mdmdview`.
4. **PATH** -- Cut entirely. GUI app; no terminal use case.
5. **File extensions** -- `.md` and `.markdown` only. `.mdown`/`.mkd` are dead.
6. **EULA dialog** -- `WixUI_Minimal` shows MIT license inline on welcome page. Requires `wix/License.rtf`.
7. **Install directory** -- Flat `C:\Program Files\mdmdview\`. No `bin\` subdirectory.
