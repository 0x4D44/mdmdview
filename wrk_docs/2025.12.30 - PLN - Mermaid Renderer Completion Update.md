# PLN - Mermaid Renderer Completion Update

Date: 2025.12.30
Based on: wrk_docs/2025.12.30 - HLD - Mermaid Renderer Completion Update.md

## Overview

## Stage 1 - Feature and dependency model
- Update `Cargo.toml`:
  - Add `mermaid-embedded = ["mermaid-quickjs"]`.
  - Set `default = ["mermaid-embedded"]`.
  - Make `ureq` optional.
Deliverables:
- Default build uses embedded renderer.
Exit criteria:
- `cargo build` succeeds with defaults.
- `cargo build --no-default-features` succeeds (Mermaid disabled).

## Stage 2 - Renderer capability handling
Goal: deterministic selection and clear messaging when a renderer is unavailable.
- If embedded requested but not compiled or JS missing, show a warning and fall back to source rendering.
- Update preference tests to cover capability gaps.
Deliverables:
- Renderer selection behaves consistently across all combinations.
Exit criteria:

## Stage 3 - Embedded validation tests
Goal: validate the QuickJS path with real render output.
- Add feature-gated tests that:
  - Render a flowchart, sequence, and class/state diagram to SVG.
  - Assert SVG output is non-empty.
  - Rasterize at least one SVG and assert RGBA output and size bounds.
- Add a test that asserts `mermaid_embed::MERMAID_JS` is non-empty when embedded is enabled.
Deliverables:
- QuickJS render tests pass with `--features mermaid-quickjs`.
Exit criteria:
- `cargo test --features mermaid-quickjs` passes locally.

## Stage 4 - Regression harness coverage
Goal: lock Mermaid output to embedded rendering in regression.
- Update `tools/regression/runner.py` to set:
  - `MDMDVIEW_MERMAID_RENDERER=embedded`
- Regenerate reference and baseline output for `tests/regression/cases/008-mermaid.md`.
Deliverables:
- Mermaid regression case uses embedded output with no network rendering.
Exit criteria:

## Stage 5 - Docs and licensing
Goal: align documentation and assets with the new defaults.
- Add Mermaid license text under `assets/vendor/` or `THIRD_PARTY_NOTICES.md`.
- Update `src/sample_files.rs` and other docs to remove feature-gated language.
Deliverables:
- Docs and samples reflect embedded defaults and licensing.
Exit criteria:
- README and samples match expected behavior without extra flags.

## Stage 6 - Final validation
Goal: verify builds and tests across feature variants.
- Run `cargo fmt --all`.
- Run `cargo clippy --all-targets -- -D warnings`.
- Run `cargo test` and `cargo test --features mermaid-quickjs`.
- Run regression harness update and compare.
Deliverables:
- Clean checks and release builds for all feature combinations.
Exit criteria:
- All commands succeed with no warnings.
