# PLN - Mermaid Renderer Completion Update

Date: 2025.12.30
Based on: wrk_docs/2025.12.30 - HLD - Mermaid Renderer Completion Update.md

## Overview
Complete the built-in Mermaid renderer by making embedded rendering the default, gating Kroki behind an explicit feature, adding missing validation, and updating regression coverage and documentation.

## Stage 1 - Feature and dependency model
Goal: make embedded rendering the default and isolate Kroki behind a feature.
- Update `Cargo.toml`:
  - Add `mermaid-embedded = ["mermaid-quickjs"]`.
  - Add `mermaid-kroki = ["dep:ureq"]`.
  - Set `default = ["mermaid-embedded"]`.
  - Make `ureq` optional.
- Add `#[cfg(feature = "mermaid-kroki")]` guards for Kroki fields, workers, and render helpers in `src/mermaid_renderer.rs`.
- Provide stubs or messages when Kroki is not compiled.
Deliverables:
- Default build uses embedded renderer.
- Kroki code compiles only with `mermaid-kroki`.
Exit criteria:
- `cargo build` succeeds with defaults.
- `cargo build --no-default-features` succeeds (Mermaid disabled).
- `cargo build --features mermaid-kroki` succeeds.

## Stage 2 - Renderer capability handling
Goal: deterministic selection and clear messaging when a renderer is unavailable.
- Add capability flags for embedded and Kroki availability.
- If embedded requested but not compiled or JS missing, show a warning and fall back to source rendering.
- If Kroki requested but not compiled, show a warning and fall back to source rendering.
- Update preference tests to cover capability gaps.
Deliverables:
- Renderer selection behaves consistently across all combinations.
Exit criteria:
- Unit tests cover embedded/kroki/off preference cases and capability gaps.

## Stage 3 - Embedded validation tests
Goal: validate the QuickJS path with real render output.
- Add feature-gated tests that:
  - Render a flowchart, sequence, and class/state diagram to SVG.
  - Assert SVG output is non-empty.
  - Rasterize at least one SVG and assert RGBA output and size bounds.
- Add a test that asserts `mermaid_embed::MERMAID_JS` is non-empty when embedded is enabled.
Deliverables:
- QuickJS render tests pass with `--features mermaid-quickjs`.
Exit criteria:
- `cargo test --features mermaid-quickjs` passes locally.

## Stage 4 - Regression harness coverage
Goal: lock Mermaid output to embedded rendering in regression.
- Update `tools/regression/runner.py` to set:
  - `MDMDVIEW_MERMAID_RENDERER=embedded`
  - `MDMDVIEW_ENABLE_KROKI=0`
- Regenerate reference and baseline output for `tests/regression/cases/008-mermaid.md`.
Deliverables:
- Mermaid regression case uses embedded output with no network rendering.
Exit criteria:
- Regression run completes with embedded rendering and no Kroki use.

## Stage 5 - Docs and licensing
Goal: align documentation and assets with the new defaults.
- Add Mermaid license text under `assets/vendor/` or `THIRD_PARTY_NOTICES.md`.
- Update README to describe embedded as default and Kroki as optional.
- Update `src/sample_files.rs` and other docs to remove feature-gated language.
Deliverables:
- Docs and samples reflect embedded defaults and licensing.
Exit criteria:
- README and samples match expected behavior without extra flags.

## Stage 6 - Final validation
Goal: verify builds and tests across feature variants.
- Run `cargo fmt --all`.
- Run `cargo clippy --all-targets -- -D warnings`.
- Run `cargo test` and `cargo test --features mermaid-quickjs`.
- Run `cargo build --release` and `cargo build --release --features mermaid-kroki`.
- Run regression harness update and compare.
Deliverables:
- Clean checks and release builds for all feature combinations.
Exit criteria:
- All commands succeed with no warnings.
