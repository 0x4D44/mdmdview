# HLD - Regression Visual Test Suite for Markdown Rendering

Date: 2025.12.25
Revision: Design review update

## Summary
Create a regression test suite that renders a curated set of markdown documents in mdmdview and compares screenshots against canonical outputs produced by a pinned, standard markdown renderer (browser-based). The suite captures consistent images, computes diffs, and surfaces regressions with reproducible artifacts. A pluggable reference renderer adapter will allow either a headless browser pipeline or an external tool such as mdscreensnap.

## Design Review Updates
Issues identified during review and their resolutions are incorporated below:
- Issue: The reference renderer was not pinned or standardized, risking inconsistent baselines. Resolution: choose a pinned reference pipeline (cmark-gfm + headless Chromium) with locked versions and local CSS/assets; alternative adapters are optional but must emit metadata for reproducibility.
- Issue: Pixel diffs would be dominated by styling differences between mdmdview and a browser. Resolution: define a canonical CSS and font bundle for the reference renderer that approximates mdmdview defaults and allow per-case tolerances/masks.
- Issue: mdmdview screenshots could include UI chrome (menus/status bar) and hover/animation noise. Resolution: add a content-only screenshot mode that hides chrome, disables animations, and waits for render stabilization.
- Issue: Long documents only capture the first screen. Resolution: add multi-snapshot support with scroll offsets or anchors per case.
- Issue: Mermaid/emoji/highlighting parity with the reference renderer was unclear. Resolution: define per-case compare modes and a reference pre-render step for mermaid/emoji, with fallback to mdmdview-only baselines when needed.

## Goals
- Provide a reliable visual regression suite that catches rendering regressions across markdown features.
- Use canonical outputs from a standard markdown renderer to keep the baseline independent of mdmdview.
- Capture mdmdview screenshots deterministically and compare them to reference images with tolerances and masks.
- Make the suite easy to run locally and in CI with clear artifacts and metadata.

## Non-Goals
- Perfect pixel equality across OSes, GPUs, and font stacks; we will scope CI to a controlled environment.
- Full fidelity layout parity with GitHub or any single site. The reference is a stable, pinned renderer and CSS.
- Replacing existing unit tests. This suite complements unit tests and manual checks.

## Scope and Assumptions
- Primary target for CI is Windows (matching the app's main platform). Optional Linux/macOS support can be added later.
- All inputs are local files; network access is not required for rendering once tooling is installed.
- mdmdview uses the production rendering pipeline; the test harness only drives it.

## Baseline Strategy
- Primary comparison: mdmdview screenshots vs reference renderer screenshots.
- Secondary baseline: mdmdview-only for cases that cannot be represented in the reference renderer.
- Manifest field `compare_mode` selects `reference`, `mdmdview`, or `hybrid` (reference image + ignore mask).
- Each case records which renderer, CSS hash, and version produced its canonical output.

## Test Corpus Design
Create a curated set of markdown documents that exercise all supported features and known regression areas.

Coverage categories:
- Basic structure: headings, paragraphs, blockquotes, horizontal rules.
- Lists: ordered/unordered, nested, mixed, tight/loose spacing.
- Inline formatting: bold, italic, strikethrough, inline code, links, autolinks.
- Code blocks: fenced, language hints, long lines, wrapping behavior.
- Tables: alignment, long text, wrapping, mixed inline content.
- Images: local PNG/JPEG/SVG, captions, missing images.
- Emoji: shortcodes and Unicode.
- Footnotes and anchors (if supported).
- Mermaid diagrams (embedded renderer enabled for mdmdview).
- Edge cases: non-UTF8, mixed line endings, Unicode width, RTL samples.
- Performance: large document with 500-1000 elements.

Corpus layout:
```
/tests/regression/
  cases/
    001-headings.md
    002-lists.md
    003-inline.md
    004-code.md
    005-tables.md
    006-images.md
    007-emoji.md
    008-mermaid.md
    009-unicode.md
    010-large.md
  assets/
    image-a.png
    image-b.jpg
    diagram.svg
  manifest.toml
```

### Manifest schema (example)
```
[[case]]
id = "005-tables"
path = "cases/005-tables.md"
compare_mode = "reference"
reference = "cmark-gfm"
viewport = { width = 1280, height = 720, dpr = 1.0 }
theme = "light"
zoom = 1.0
table_wrap = true
snapshots = [
  { name = "top", scroll = 0.0 },
  { name = "mid", scroll = 0.5 }
]
diff = { max_percent = 0.15, max_pixels = 500, mask = ["status_bar"] }
```

Notes:
- `scroll` can be a 0..1 ratio or an anchor ID (future extension).
- `mask` refers to predefined regions (status bar, menu, scrollbars) or a custom PNG mask.

## Reference (Canonical) Rendering Pipeline
### Decision: Headless Browser Renderer (Preferred)
- Convert markdown to HTML using a pinned standard renderer (cmark-gfm or markdown-it with GFM).
- Render HTML in headless Chromium with a pinned CSS and local assets (no network).
- Take a screenshot with a fixed viewport and device scale.

Pinned toolchain example:
- Markdown -> HTML: cmark-gfm (pinned version)
- HTML -> screenshot: Playwright Chromium (pinned version)
- CSS: local canonical CSS approximating mdmdview typography and colors
- Fonts: bundled font set used by both mdmdview and the reference HTML

Implementation option A:
- `tools/regression/reference_runner` (Node or Python)
- Converts markdown, injects template, inlines CSS and fonts, renders with Playwright
- Outputs `reference.html`, `reference.png`, and `reference.json`

Implementation option B (adapter):
- Use mdscreensnap if installed
- Adapter must emit the same JSON metadata (renderer version, CSS hash, viewport, DPR)
- If mdscreensnap cannot guarantee pinned renderer versions, it is treated as local-only (not CI)

Reference outputs stored per case:
```
/tests/regression/reference/005-tables/
  reference.html
  reference.png
  reference.json
```

## mdmdview Screenshot Pipeline
Introduce a deterministic screenshot mode in the app, invoked by the test harness.

Key requirements:
- Fixed window size and DPI scaling.
- Deterministic theme (light/dark), zoom, and table wrap setting.
- Content-only capture (hide menu/status bar and other chrome).
- Disable non-deterministic UI (live image refresh animations, cursor, blinking caret).
- Wait for content to settle:
  - Images loaded
  - Mermaid renders finished or timed out
  - N consecutive frames with no layout changes

Proposed CLI:
- `mdmdview --screenshot <input.md> --output <png> --width 1280 --height 720 --theme light --zoom 1.0`
- `--table-wrap` or `--no-table-wrap`
- `--content-only` (hide chrome; crop to document area)
- `--scroll 0.5` (optional per snapshot)
- `--wait-ms 2000` and `--settle-frames 3`
- `--test-fonts <dir>` (load bundled fonts for deterministic output)

Output metadata JSON:
```
/tests/regression/actual/005-tables/actual.json
```
Includes app version, renderer flags, viewport, zoom, theme, font bundle ID, and timing data.

## Image Diff and Reporting
Use a pixel diff library to compare mdmdview output to reference images.

Diff outputs:
```
/tests/regression/diff/005-tables/
  diff.png
  diff.json
```

Diff metrics:
- total pixels
- differing pixels
- percentage difference
- max channel delta
- optional SSIM/perceptual score

Thresholding:
- Default strict threshold (0.0% or very low).
- Per-case overrides in the manifest for known minor variations.
- Ignore masks for UI chrome or unavoidable differences (scrollbars, caret).

## Orchestration and CLI
Create a regression runner with clear subcommands and adapters.

Recommended structure:
```
/tools/regression/
  runner.py (or xtask)
  adapters/
    reference_cmark_gfm.py
    reference_mdscreensnap.py
    mdmdview_capture.py
```

CLI examples:
- `regress run` -- run all cases and compare
- `regress run --case 005-tables` -- run one case
- `regress update-reference` -- regenerate canonical outputs
- `regress update-baseline` -- regenerate mdmdview screenshots
- `regress report` -- summarize diffs and open report

Runner steps:
1. Load manifest and resolve cases.
2. Generate reference outputs if missing or update requested.
3. Capture mdmdview screenshots (one per snapshot).
4. Compare images and generate diffs.
5. Emit a summary report (JSON and Markdown).

## CI Integration
- CI runs on Windows to minimize font/GPU variance.
- PRs run a smoke subset; nightly runs full suite.
- Cache Playwright browsers and reference outputs to reduce CI time.
- Upload diff images and reports as artifacts.
- CI fails if any case exceeds diff thresholds.

## Determinism Controls
- Bundle fonts and load them explicitly in mdmdview test mode and reference HTML.
- Pin viewport, device scale, and theme.
- Disable animations and transient UI elements.
- Stabilize GPU rendering (prefer a consistent backend on CI).

## Handling Non-Standard Features
- Mermaid: use mermaid-cli (pinned) in the reference pipeline to pre-render SVG/PNG when compare_mode is `reference`; otherwise mark as mdmdview baseline.
- Emoji: use a pinned Twemoji asset set in the reference HTML to match mdmdview behavior.
- Syntax highlighting: use a fixed highlight theme in the reference HTML; consider a custom CSS theme aligned with mdmdview colors.

## Storage and Repository Impact
- Store reference and baseline PNGs in-repo for reproducibility.
- Keep viewport reasonable to limit image size and prefer a small initial corpus.
- Consider git-lfs if total size grows beyond a few hundred MB.

## Risks and Mitigations
- Font rendering differences: restrict CI to Windows and bundle fonts for both renderers.
- GPU variance: use consistent CI runner types and consider software rendering if feasible.
- Async rendering flakiness: enforce wait-for-stable logic with timeouts and retries.
- Large binary artifacts: keep case count focused and compress PNGs.
- Reference drift: lock tool versions and record hashes in metadata.

## Open Questions
- Which reference renderer to standardize on for CI: cmark-gfm + Playwright vs markdown-it + Playwright?
- Should mdscreensnap be supported only for local runs, or allowed in CI with version pinning?
- Do we want a separate "structure-only" diff mode (grayscale or edge-based) to reduce noise?

## Proposed Next Steps
- Decide on the reference renderer toolchain and pin versions in lockfiles.
- Draft the manifest schema and a starter set of 10-15 cases.
- Implement mdmdview screenshot mode and the reference adapter.
- Wire a smoke test into CI and add artifact uploads.
