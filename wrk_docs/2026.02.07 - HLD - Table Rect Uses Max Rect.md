# HLD: Table Cell Rect Uses max_rect for Vertical Bounds

**Date**: 2026-02-07
**Status**: DRAFT
**Predecessor**: `wrk_docs/2026.02.07 - HLD - Table Border Vertical Expansion.md`
**Affects**: `src/markdown_renderer.rs` — `render_table_tablebuilder`

## 1. Problem Statement

After the vertical border expansion fix (v1.3.2), the bottom border is
still ~1-2px above the stripe shading extent. The top border shows a
similar but less visible gap.

## 2. Root Cause

The table rect's vertical bounds are derived from `ui.min_rect()` of each
cell (lines 4435 and 4476), but egui's striped backgrounds are based on
`ui.max_rect()` (the allocated cell rect).

**`ui.min_rect()`** — the tight bounding box of rendered content. If a
cell's text doesn't fill the full allocated row height, `min_rect().bottom()`
is above the allocated bottom.

**`ui.max_rect()`** — the full allocated cell rect from egui's row layout
system. This is what the stripe expansion is based on:

```
// egui_extras layout.rs:122
let gapless_rect = max_rect.expand2(0.5 * item_spacing);
```

The gap between `min_rect.bottom()` and `max_rect.bottom()` for the last
row is typically 1-2px, depending on how `uniform_row_height` compares
to actual content height. This directly explains the ~1-2px border gap
Arthur observed.

### Diagram

```
    ┌─────────────────────────┐  ← max_rect.top() = min_rect.top()
    │ Cell text content       │
    │                         │  ← min_rect.bottom() (content ends here)
    │                         │  ← max_rect.bottom() (allocated row ends here, 1-2px below)
    └─────────────────────────┘
    ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓  ← stripe extends from max_rect.bottom() + spacing/2
```

Our border uses `min_rect.bottom() + spacing/2`, but the stripe uses
`max_rect.bottom() + spacing/2`. The 1-2px difference is
`max_rect.bottom() - min_rect.bottom()`.

### Why Width Is Not Affected

The existing code already handles width separately: column widths come
from `body.widths()` (the allocated column widths), not from
`min_rect().width()`. There's even a comment at line 4432 warning about
this:

```rust
// NOTE: Do NOT capture ui.min_rect().width() here - that's the content width,
// not the column width. Column widths are captured from body.widths() below.
```

The vertical dimension has the same content-vs-allocated mismatch, but
it was never addressed because `body.widths()` has no vertical equivalent.

## 3. Design

### 3.1 Change `ui.min_rect()` to `ui.max_rect()` at Two Call Sites

**Line 4435** — header cell rect:
```rust
// Was:
Self::extend_table_rect(&mut header_rect, ui.min_rect());
// Now:
Self::extend_table_rect(&mut header_rect, ui.max_rect());
```

**Line 4476** — body cell rect:
```rust
// Was:
Self::extend_table_rect(&mut body_rect, ui.min_rect());
// Now:
Self::extend_table_rect(&mut body_rect, ui.max_rect());
```

### 3.2 Why This Is Safe

The `header_rect` and `body_rect` values flow to `resolve_table_rects`
which uses them for:

- **`top`** (line 4595): `header_rect.top()` — `max_rect.top()` and
  `min_rect.top()` are identical (content starts at the top of the cell).
  No change.

- **`bottom`** (line 4599): `body_rect.bottom()` — changes from
  `min_rect.bottom()` to `max_rect.bottom()`. This is the fix: the border
  now aligns with the allocated row bottom, matching the stripe base.

- **`left`** (line 4590): `layout_rect.left()` takes priority (from
  `body.max_rect()`). `header_rect.left()` and `body_rect.left()` are only
  fallbacks. Since `layout_rect` is always populated, the left edge is
  unchanged.

- **Width**: Not derived from `header_rect` or `body_rect` at all. Width
  comes from `body.widths()` via `calculated_width`. Unaffected.

### 3.3 What About `max_rect` Width?

`ui.max_rect()` returns the full allocated cell rect, which includes
the correct column width AND the correct row height. Using it for
`extend_table_rect` gives us accurate vertical bounds without affecting
horizontal bounds (which are already handled by `body.widths()`).

The `extend_table_rect` function takes the union of all rects. For width,
the union of `max_rect` across all cells in a row equals the full row
width. But this is fine because `resolve_table_rects` doesn't use
`header_rect` or `body_rect` for the horizontal dimension — it uses
`layout_rect.left()` and `calculated_width`.

### 3.4 Update Comment at Line 4432

The existing comment warns about `min_rect().width()` vs column width.
Update it to explain why `max_rect()` is used:

```rust
// NOTE: Use ui.max_rect() (allocated cell bounds), not ui.min_rect()
// (content bounds). The allocated rect matches what egui uses for
// striped backgrounds, ensuring the border aligns with the stripe extent.
// Column widths are captured separately from body.widths() below.
```

### 3.5 Summary of Changes

| # | Change | Location | Lines |
|---|--------|----------|-------|
| 1 | `ui.min_rect()` → `ui.max_rect()` | Line 4435 (header cells) | 1 |
| 2 | `ui.min_rect()` → `ui.max_rect()` | Line 4476 (body cells) | 1 |
| 3 | Update comment explaining why | Lines 4432-4434 | ~3 |

Total: ~5 lines changed.

## 4. Impact Analysis

### 4.1 Visual Impact

| Edge | Before | After |
|------|--------|-------|
| Top | Border ~0-1px below stripe top | Border matches stripe top |
| Bottom | Border ~1-2px above stripe bottom | Border matches stripe bottom |
| Left | No change | No change |
| Right | No change | No change |

### 4.2 Test Impact

No test changes needed. The `extend_table_rect` function is unchanged.
The `header_rect` and `body_rect` values are only used in
`resolve_table_rects` for border positioning, which is cosmetic. No tests
assert exact vertical positions of the table rect.

### 4.3 Risk Assessment

| Risk | Severity | Mitigation |
|------|----------|------------|
| `max_rect` returns unexpected values | Low | egui's cell `max_rect` is the allocated cell bounds; well-defined |
| `max_rect.top()` differs from `min_rect.top()` | None | Content starts at the top of the cell; these are identical |
| Horizontal dimension affected | None | Width comes from `body.widths()`, not from header/body rect |
| First-frame estimation differs | None | Self-healing via table metrics cache; second frame corrects |

## 5. Files to Modify

| File | Change |
|------|--------|
| `src/markdown_renderer.rs` | Lines 4432-4435, 4475-4476: use `max_rect()` and update comments |
