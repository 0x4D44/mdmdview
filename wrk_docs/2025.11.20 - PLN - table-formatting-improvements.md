# Table Formatting Implementation Plan (2025-11-20)

## Staging Overview
1) Parsing fixes & tests
2) Table identity & cache hygiene
3) Adaptive header/row heights
4) Column policy + stats upgrades
5) Legacy renderer safety patch
6) Integration/tests/docs

## Stage 1 — Parsing fixes & tests
- Replace `collect_cell_spans` with shared inline parser (break-aware) for table cells.
- Preserve images, links, nested styling, soft/hard breaks inside cells.
- Add unit tests: newline preservation, image-in-cell, styled link in cell, mixed code/text.
- Deliverable: green `cargo test` with new parsing tests.

## Stage 2 — Table identity & cache hygiene
- Add per-element index when creating `MarkdownElement::Table`.
- Extend `compute_table_id` to include element index + document hash; bump metrics/persisted-width version salt.
- Clear caches when element count changes; ensure persisted widths are scoped to new table_id/version.
- Add tests: identical tables at different positions get distinct ids; persisted widths don’t bleed.

## Stage 3 — Adaptive header & row heights
- Pre-measure header cells to derive dynamic header height (TableBuilder path only).
- Row height stabilization: update stored height immediately when measured > hint; request repaint on growth (feature flag for two-pass if needed).
- Tests: wrapped header height exceeds legacy 28px; tall body cell avoids clipping on next frame (simulate via hint update).

## Stage 4 — Column policy & stats upgrades
- Compute stats for full column count (headers + widest row); synthesize missing header labels.
- Allow up to 2 remainder columns when stats indicate long/rich content; relax first-column fixed rule.
- Switch to display-width estimation using `unicode_width` for stats.
- Update tooltips to reflect new policies.
- Tests: multiple remainder selection, CJK width > ASCII width, extra-column stats applied.

## Stage 5 — Legacy renderer safety patch
- Replace image width estimate with capped heuristic (thumbnail or cached natural size, else body*12).
- Test: image in legacy table does not balloon desired widths; widths still sum to available.

## Stage 6 — Integration, docs, and polish
- Add integration-style helper to render small tables headless and assert no panic.
- Update `TABLE_LAYOUT_QUICK_REFERENCE.md` and README toggle note for new behaviors/policies.
- Optional: surface cache hit/miss + row counts in status hover; ensure cleared in `clear_table_layout_cache`.
- Final test sweep: `cargo test`, `cargo clippy --all-targets -- -D warnings`, `cargo fmt`.

## Risk & Mitigation
- Perf regression from extra measurement: bucket layout cache by width; keep rest optional feature flag.
- Persisted width invalidation: version salt avoids user confusion; log once if widths are reset.

## Milestones/Checkpoints
- M1: Stage 1 merged — parsing correctness ensured.
- M2: Stage 2 merged — cache bleed fixed; widths stable per table.
- M3: Stage 3 merged — headers/rows adapt; no clipping.
- M4: Stage 4 merged — better sizing for wide/CJK tables.
- M5: Stage 5 merged — legacy path safe.
- M6: Stage 6 merged — docs/tests complete; suite green.
