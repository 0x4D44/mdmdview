# 2025.11.07 - Selection Issue and Workaround

## The Problem

User reported: "I can select some text with the mouse and it highlights - good. But as soon as I click the right mouse button the selection disappears."

This is a fundamental limitation in egui, the GUI framework used by mdmdview.

## Technical Analysis

### Root Cause
1. **egui's Architecture**: Each piece of text in the markdown viewer is rendered as a separate `Label` widget
2. **No Cross-Widget Selection**: egui doesn't support text selection that spans multiple Label widgets
3. **Right-Click Behavior**: When you right-click in egui, it clears any text selection before showing the context menu
4. **Event Order**: The selection is cleared before the context menu handler can access it

### Why This Happens
- We render formatted text (bold, italic, links, code) as individual segments
- Each segment is a separate widget to maintain proper formatting
- egui treats right-click as a new interaction, clearing previous state

### Attempted Solutions

I explored several approaches:

1. **TextEdit Widget**: Using read-only TextEdit widgets for paragraphs
   - ‚úÖ Preserves selection on right-click
   - ‚ùå Loses all formatting (bold, italic, links, etc.)
   - Verdict: Not acceptable as it degrades the viewing experience

2. **SelectableLabel**: Using egui's SelectableLabel widget
   - ‚ùå Designed for list selection, not text selection
   - ‚ùå Doesn't solve the right-click issue
   - Verdict: Wrong tool for the job

3. **Selection Tracking**: Attempting to capture and store selected text
   - ‚ùå Selection is cleared before we can capture it
   - ‚ùå No egui API to get selected text before it's cleared
   - Verdict: Not possible with current egui APIs

4. **Event Interception**: Trying to handle right-click before selection clears
   - ‚ùå egui processes the right-click first
   - ‚ùå No way to prevent the default behavior
   - Verdict: Not supported by framework

## Implemented Workaround

Since we cannot prevent the selection from being cleared on right-click, we've implemented a pragmatic workaround:

### User Workflow
1. **Select text** with the mouse (click and drag)
2. **Use Ctrl+C** to copy the selected text (standard keyboard shortcut)
3. **Right-click** for context menu to copy entire segments or documents

### Context Menu Improvements
- Added helpful tip: "üí° Select text, then use Ctrl+C to copy"
- Retained "Copy Text" option for individual segments
- Kept "Copy All Text" and "Copy as Markdown" for document-level operations

### User Communication
The context menus now clearly communicate the limitation and provide the workaround:
- Tips appear in context menus explaining to use Ctrl+C
- Alternative copy options are available for convenience

## Future Possibilities

### Framework Changes
If egui adds support for:
- Persistent text selection across right-clicks
- Cross-widget text selection
- Selection state preservation APIs

We could implement proper "Copy Selection" in context menus.

### Alternative Approaches
1. **Custom Text Rendering**: Implement our own text selection system
   - Pro: Full control over selection behavior
   - Con: Significant complexity, potential performance impact

2. **Different GUI Framework**: Switch to a framework with better text selection
   - Pro: Native selection behavior
   - Con: Complete rewrite required

3. **Hybrid Rendering**: Use web view for content, native GUI for chrome
   - Pro: Perfect text selection
   - Con: Loses single-binary simplicity, adds dependencies

## Recommendation

The current workaround is the best compromise given the constraints:
- **Preserves formatting**: All markdown formatting remains intact
- **Standard behavior**: Ctrl+C is the universal copy shortcut
- **Clear communication**: Users understand the limitation
- **Functional**: Users can still copy any text they need

## User Impact

- **Minor inconvenience**: Extra step (Ctrl+C) required
- **Discoverable**: Context menu tips guide users
- **Industry standard**: Ctrl+C is well-known
- **Acceptable tradeoff**: Maintains rich formatting

## Conclusion

While not ideal, this solution provides a functional text copying experience within the constraints of the egui framework. The limitation is clearly communicated to users, and the workaround uses standard keyboard shortcuts that most users already know.

The alternative of losing all text formatting to gain selection persistence would be a worse user experience overall.