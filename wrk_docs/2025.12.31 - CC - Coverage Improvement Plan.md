# Coverage Improvement Plan (Multi-Stage)

## Goal
Raise first-party `src/` line coverage from **89.88%** to **98%** while keeping tests deterministic and fast.

## Stage 0: Baseline + Measurement Hygiene
- **Target**: Confirm baseline numbers using `cargo llvm-cov` and ignore generated bindings under `target/llvm-cov-target` for reporting.
- **Actions**:
  - Run `cargo llvm-cov --summary-only --ignore-filename-regex 'target/'` to capture a clean baseline.
  - Store updated summary and missing lines in `wrk_docs/`.
- **Exit criteria**: Baseline coverage numbers recorded and reproducible.

## Stage 1: Pure-Logic Modules (quick wins)
- **Targets**: `src/table_support/column_spec.rs`, `src/window_state.rs`, `src/main.rs`.
- **Actions**:
  - Add tests for remaining classification branches (clip + remainder caps + edge labels) and rich-content flags.
  - Add tests for additional `window_state` paths (missing file, malformed values, fallback order).
  - Cover `main()` stub (invoke via test wrapper if available).
- **Coverage goal**: `column_spec.rs` ? 95%, `window_state.rs` ? 95%.

## Stage 2: Markdown Renderer Core Logic
- **Target**: `src/markdown_renderer.rs`.
- **Actions**:
  - Expand renderer tests to cover missing branches in:
    - Table rendering (wrap vs no-wrap, overflow, empty headers, missing cells).
    - Image/SVG error paths (missing files, invalid bytes).
    - Anchor/heading ID generation (duplicates, punctuation, non-ASCII).
    - Inline rendering variants (links, images, emoji shortcode expansion, strikethrough/code).
  - Add tests that exercise layout caching and cache invalidation paths.
- **Coverage goal**: `markdown_renderer.rs` ? 96% lines.

## Stage 3: App/UI State Logic
- **Target**: `src/app.rs`.
- **Actions**:
  - Add tests for search navigation edge cases (empty query, no matches, wrap-around).
  - Add tests for raw editor cursor move logic and write-mode toggling.
  - Add tests for drag-and-drop queue handling and folder-drop filtering.
- **Coverage goal**: `app.rs` ? 97% lines.

## Stage 4: Consolidation + Coverage Gate
- **Actions**:
  - Re-run coverage and identify remaining gaps.
  - Add targeted tests for remaining hot paths.
  - Document coverage results in `wrk_docs/` with updated summary/missing lines.
- **Exit criteria**: First-party `src/` line coverage **? 98%** and tests remain stable.
