# Implementation Plan - Table Rendering Bug Fixes

**Date:** 2025-11-28
**Author:** Claude
**Branch:** feat/table-dividers
**HLD Reference:** `wrk_docs/2025.11.28 - HLD - Table Rendering Bug Fixes.md`

---

## Overview

This plan implements fixes for two table rendering bugs:
1. Dividers drawn at incorrect positions
2. Column widths captured from wrong source

The fix is surgical - we modify only the width capture mechanism without restructuring the table rendering logic.

---

## Stage 1: Prepare Width Capture Infrastructure

**Goal:** Set up the mechanism to capture widths from `body.widths()` instead of `ui.min_rect()`.

### Tasks:

1.1. **Add width capture variable with interior mutability**
   - File: `src/markdown_renderer.rs`
   - Location: `render_table_tablebuilder()` around line 3365
   - Change: Replace `let mut column_widths = vec![...]` with a `RefCell` or `Cell` wrapper
   - Rationale: The body closure needs to write to this, and we need to read it after

1.2. **Remove incorrect width capture from header callback**
   - File: `src/markdown_renderer.rs`
   - Location: Header callback around line 3380
   - Change: Remove `column_widths[ci] = ui.min_rect().width();`
   - Rationale: Header min_rect is not the column width

### Validation:
- `cargo check` should pass
- Table should still render (dividers will be broken until Stage 2)

---

## Stage 2: Capture Correct Widths from Body

**Goal:** Use `body.widths()` to get actual column widths.

### Tasks:

2.1. **Capture widths at start of body closure**
   - File: `src/markdown_renderer.rs`
   - Location: Body closure around line 3391
   - Change: Add `let actual_widths = body.widths().to_vec();` before `heterogeneous_rows`
   - Store in the RefCell from Stage 1

2.2. **Preserve body for `heterogeneous_rows`**
   - Verify that calling `widths()` before `heterogeneous_rows` doesn't cause borrow issues
   - The API docs confirm `widths()` returns `&[f32]` which we immediately clone

### Validation:
- `cargo check` should pass
- `cargo test` should pass
- Manual test: Open a table and verify dividers are now aligned

---

## Stage 3: Fix Table Rect Calculation

**Goal:** Ensure the table rect accurately represents the table bounds.

### Tasks:

3.1. **Capture body max_rect for accurate table bounds**
   - File: `src/markdown_renderer.rs`
   - Location: Body closure
   - Change: Consider using `body.max_rect()` for more accurate table boundary
   - Currently using union of all cell min_rects - verify this is sufficient

3.2. **Validate rect includes header**
   - The header also contributes to the table rect
   - Ensure `extend_table_rect` is called for header cells too

### Validation:
- Visual inspection: Table border should encompass entire table
- No clipping of border at edges

---

## Stage 4: Clean Up and Optimize

**Goal:** Remove dead code and optimize the implementation.

### Tasks:

4.1. **Remove unused width capture in body rows**
   - If any width capture happens in row callbacks, remove it
   - The correct widths are already captured at body start

4.2. **Review Clippy warnings**
   - Address any new warnings from the changes
   - Ensure no unused variables

4.3. **Add inline documentation**
   - Document why we capture widths from `body.widths()`
   - Explain the closure ownership pattern

### Validation:
- `cargo clippy` clean
- `cargo fmt` clean
- `cargo test` all passing

---

## Stage 5: Add Regression Tests

**Goal:** Prevent future regressions with automated tests.

### Tasks:

5.1. **Add unit test for width capture**
   - Test that captured widths match column spec allocations
   - Test edge cases (single column, many columns)

5.2. **Manual visual regression test**
   - Test with `examples/regressions/table-wrap.md`
   - Test with `examples/regressions/table-threat-model.md`
   - Test at different window sizes

5.3. **Document the fix**
   - Update journal with implementation notes

### Validation:
- All tests pass
- Visual inspection confirms dividers align correctly

---

## Stage 6: Final Verification

**Goal:** Complete end-to-end validation.

### Tasks:

6.1. **Full test suite**
   ```
   cargo fmt
   cargo clippy
   cargo test
   cargo build --release
   ```

6.2. **Visual verification**
   - Open each regression test file
   - Verify dividers at 100%, 125%, 150% DPI (if possible)
   - Resize window and verify dividers stay aligned

6.3. **Compare with screenshots**
   - If previous screenshots exist, compare before/after

### Validation:
- All builds succeed
- All tests pass
- Visual regression tests pass

---

## Code Changes Summary

### File: `src/markdown_renderer.rs`

| Line Range | Change Type | Description |
|------------|-------------|-------------|
| 3365 | Modify | Change `column_widths` to use `RefCell` or move capture |
| 3376-3388 | Modify | Remove width capture from header callback |
| 3391-3423 | Modify | Add `body.widths()` capture at body closure start |
| 3531-3558 | Verify | `paint_table_dividers` uses correct widths |

### Estimated Changes:
- ~20 lines modified
- ~5 lines removed
- ~10 lines added (documentation)

---

## Rollback Plan

If the fix causes issues:

1. Revert the width capture changes
2. The previous (buggy) behavior is restored
3. File an issue for deeper investigation

---

## Timeline

| Stage | Estimated Time | Cumulative |
|-------|---------------|------------|
| Stage 1 | 5 minutes | 5 minutes |
| Stage 2 | 10 minutes | 15 minutes |
| Stage 3 | 5 minutes | 20 minutes |
| Stage 4 | 5 minutes | 25 minutes |
| Stage 5 | 10 minutes | 35 minutes |
| Stage 6 | 10 minutes | 45 minutes |

---

## Dependencies

- No external dependencies required
- Uses existing egui_extras API (`body.widths()`)
- No changes to Cargo.toml

---

## Success Criteria

1. **Functional:** Dividers align with column boundaries
2. **Performance:** No measurable performance regression
3. **Code Quality:** Clippy clean, tests pass
4. **Documentation:** Changes documented in journal
