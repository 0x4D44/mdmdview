# Full Repo Code Review Report

Date: 2025.12.31
Plan: wrk_docs/2025.12.31 - CR - Full Repo Code Review Plan.md
Scope: Rust sources (src/, build.rs, analyze_text.rs, examples/gen_webp.rs, navigation_tests_backup.rs), tooling (tools/*.py), and regression manifests.

## Summary
- Codebase is generally well structured with clear module boundaries and good use of Result-based error handling.
- No unsafe Rust blocks found; external execution is limited to local file reads and webbrowser link opening.
- Tests are extensive for core rendering, tables, mermaid, and window state.
- Issues found are mostly in tooling and edge-case behavior; no critical defects identified.

## Findings (ordered by severity)

### Medium
1) Mermaid render return semantics are ambiguous and can lead to double rendering.
   - Files: src/mermaid_renderer.rs:289, src/mermaid_renderer.rs:296, src/markdown_renderer.rs:3457
   - Detail: Mermaid placeholders are drawn but render_block returns false in some cases. markdown_renderer then renders a full code block as fallback. The comment on render_mermaid_block says it returns true when handled, but current behavior is mixed (true for pending jobs, false for errors/disabled).
   - Impact: Potential duplicate UI output and inconsistent behavior in disabled/error states.
   - Recommendation: Decide whether placeholders should be terminal. Either return true when a placeholder is shown or update the comment and add explicit intent to show the source block.

2) Image decoding is unbounded for raster images and can exhaust memory on large inputs.
   - Files: src/image_decode.rs:41, src/markdown_renderer.rs:4863
   - Detail: image::load_from_memory decodes full images without size caps; large or crafted images can cause high memory use or slow UI.
   - Impact: Potential UI freezes or memory exhaustion when opening untrusted markdown with large images.
   - Recommendation: Add size/byte limits or preflight dimensions before full decode; reject or downscale overly large images.

### Low
3) Image cache does not invalidate when the source file is deleted.
   - File: src/markdown_renderer.rs:4927
   - Detail: image_source_stale returns false if the path no longer exists, so cached textures remain after file removal.
   - Impact: Stale images can remain visible even when the file is gone.
   - Recommendation: Treat missing files as stale to show the placeholder instead of cached data.

4) Mermaid visual diff crop logic likely targets background pixels instead of non-background content.
   - File: tools/mermaid_visual_check.py:215
   - Detail: crop_to_background computes bounds using background-colored pixels, which typically returns the full canvas and defeats cropping.
   - Impact: Visual diffs become more sensitive to window size and padding.
   - Recommendation: Invert the condition to bound non-background pixels, or rename the function and adjust its intent.

5) Mermaid visual check uses primary monitor sizing even when a different monitor is selected.
   - File: tools/mermaid_visual_check.py:91, tools/mermaid_visual_check.py:483
   - Detail: Width/height always come from primary monitor size; --monitor only affects mdscreensnap.
   - Impact: Mismatched window sizing on multi-monitor setups.
   - Recommendation: Add monitor-aware sizing or require explicit width/height when --monitor is not primary.

   - Files: tools/regression/runner.py:208, tests/regression/manifest.toml:59
   - Impact: Confusing or misleading configuration surface.
   - Recommendation: Remove unused flags or wire them to actual behavior.

7) navigation_tests_backup.rs appears stale and would not compile if included.
   - File: navigation_tests_backup.rs
   - Detail: References types without imports and is not part of the crate; likely leftover.
   - Impact: Maintenance confusion.
   - Recommendation: Remove or convert into proper tests under src/app.rs.

8) load_fonts_from_dir can silently overwrite fonts with duplicate stems.
   - File: src/main.rs:147
   - Detail: Font names are derived from file stems without deduplication, so multiple files can map to the same name.
   - Impact: Non-deterministic font selection in test-font mode.
   - Recommendation: Add collision handling or include an index in the name.

## Additional observations
- Good: clear separation between app state, markdown rendering, and mermaid rendering.
- Good: defensive handling of window state and path validation; remote image loading is blocked by default.
- Tests are numerous and cover parser behavior, table layout, and mermaid helpers; regression tooling is well documented.

## Open questions / assumptions
- Should mermaid-disabled states show both placeholder text and source code, or just one? The current code does both in some paths.
- Is the ability for markdown to reference parent directories via relative image paths considered acceptable for this viewer?

