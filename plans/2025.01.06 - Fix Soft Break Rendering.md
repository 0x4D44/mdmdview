# Fix Soft Break Rendering for Poetry/Lyrics

**Date:** 2025-01-06
**Issue:** Line breaks in paragraphs are collapsed to spaces, breaking poetry/lyrics rendering
**Related File:** `2025.10.30 - RLN 05 - Without Goodbye-UDIO.md`

## Problem Analysis

### Current Behavior

The markdown renderer treats soft breaks (single newlines) differently based on context:

**Blockquotes:** Line breaks preserved
```markdown
> Line 1
> Line 2
> Line 3
```
Renders as:
```
Line 1
Line 2
Line 3
```

**Regular Paragraphs:** Line breaks collapsed to spaces
```markdown
Line 1
Line 2
Line 3
```
Renders as: "Line 1 Line 2 Line 3"

### Why This Exists

Standard Markdown convention:
- Single newline = soft break = rendered as space (for source readability)
- Two newlines = paragraph break
- Two spaces + newline = hard break

This allows prose to be wrapped in the source file:
```markdown
This is a long sentence that I've wrapped
across multiple lines in my source file
for readability, but it should render as one line.
```

### The Problem

Content like song lyrics, poetry, or structured text expects line breaks to be preserved:

```markdown
[Verse 1]
You sailed to war
came home to me
We built a life in Liverpool
by the sea
```

**Expected rendering:** Each line on its own line
**Actual rendering:** "You sailed to war came home to me We built a life in Liverpool by the sea"

### Code Analysis

**Location:** `src/markdown_renderer.rs`

1. **Line 291-293:** Top-level paragraph parsing
   ```rust
   Event::Start(Tag::Paragraph) => {
       let (spans, next_idx) =
           self.parse_inline_spans(events, start + 1, Tag::Paragraph)?;
   ```
   Calls `parse_inline_spans()` which defaults to `keep_breaks: false`

2. **Line 450-452:** Blockquote paragraph parsing
   ```rust
   Event::Start(Tag::Paragraph) => {
       let (mut para, next) =
           self.parse_inline_spans_with_breaks(events, i + 1, Tag::Paragraph, true)?;
   ```
   Explicitly passes `keep_breaks: true`

3. **Line 545-556:** The break handling logic
   ```rust
   Event::SoftBreak | Event::HardBreak => {
       if keep_breaks {
           if !text_buffer.is_empty() {
               spans.push(InlineSpan::Text(text_buffer.clone()));
               text_buffer.clear();
           }
           spans.push(InlineSpan::Text("\n".to_string()));
       } else {
           text_buffer.push(' ');  // ← Converts to space
       }
       i += 1;
   }
   ```

4. **Line 648-655:** Wrapper function
   ```rust
   fn parse_inline_spans(
       &self,
       events: &[Event],
       start: usize,
       end_tag: Tag,
   ) -> Result<(Vec<InlineSpan>, usize), anyhow::Error> {
       self.parse_inline_spans_with_breaks(events, start, end_tag, false)
   }
   ```

## Proposed Solutions

### Option 1: Always Preserve Line Breaks (Recommended)

**Change:** Modify top-level paragraph parsing to preserve breaks

**Implementation:**
```rust
Event::Start(Tag::Paragraph) => {
    let (spans, next_idx) =
        self.parse_inline_spans_with_breaks(events, start + 1, Tag::Paragraph, true)?;
    if !spans.is_empty() {
        elements.push(MarkdownElement::Paragraph(spans));
    }
    Ok(next_idx)
}
```

**Pros:**
- Simple one-line change
- Consistent with blockquote behavior
- Works for poetry, lyrics, structured text
- Still supports explicit line breaks (two spaces + newline = HardBreak)
- Users who want single-line paragraphs can remove newlines in their source

**Cons:**
- Changes standard Markdown behavior for prose
- Paragraphs wrapped for readability in source will render with breaks
- However, this is a VIEWER not an editor, so authoring conventions are less relevant

**Impact Analysis:**
- Sample files: May need checking if any rely on soft break collapsing
- User files: Would render with more line breaks (generally better for readability)
- Breaking change: Technically yes, but improves usability for common use cases

### Option 2: Add a Configuration Option

**Change:** Add a global setting to control break behavior

**Implementation:**
```rust
pub struct MarkdownRenderer {
    // ... existing fields
    preserve_line_breaks: bool,
}

// In parse_element:
let keep_breaks = self.preserve_line_breaks;
let (spans, next_idx) =
    self.parse_inline_spans_with_breaks(events, start + 1, Tag::Paragraph, keep_breaks)?;
```

**Pros:**
- User choice
- Backward compatible
- Can be toggled via UI

**Cons:**
- More complex
- Adds UI complexity
- Most users won't understand the difference
- Default still needs to be chosen

### Option 3: Detect Poetry/Lyrics Context

**Change:** Heuristically detect when content looks like poetry/lyrics

**Heuristics:**
- Short lines (< 60 chars)
- High frequency of newlines
- Presence of markers like [Verse], [Chorus], etc.

**Pros:**
- Automatic
- No user intervention needed

**Cons:**
- Complex heuristics
- Can guess wrong
- False positives/negatives
- Maintenance burden

## Recommendation

**Use Option 1: Always Preserve Line Breaks**

### Reasoning

1. **Viewer vs Editor:** This is a markdown VIEWER. Users aren't editing, they're viewing. The source file is what it is.

2. **Better Default:** Preserving breaks is more useful than collapsing them:
   - Poetry/lyrics: ✓ Works correctly
   - Prose with source wrapping: Still readable (just has more line breaks)
   - Structured content: ✓ Works correctly

3. **Consistency:** Blockquotes already preserve breaks. Making paragraphs match creates consistency.

4. **User Expectations:** When someone opens a file with each line on its own line, they expect to SEE each line on its own line.

5. **Minimal Code Change:** Single line modification, easy to test and maintain.

6. **Reversibility:** If this causes issues, users can:
   - Remove newlines from their source files
   - We can add a config option later if needed

### Alternative Consideration

If we're concerned about prose being affected, we could:
1. Start with Option 1 (always preserve)
2. Monitor user feedback
3. Add Option 2 (configuration) only if users complain

But I believe Option 1 alone will be satisfactory.

## Implementation Plan

### Phase 1: Make the Change ✓

1. Modify `src/markdown_renderer.rs:293`:
   ```rust
   - self.parse_inline_spans(events, start + 1, Tag::Paragraph)?;
   + self.parse_inline_spans_with_breaks(events, start + 1, Tag::Paragraph, true)?;
   ```

### Phase 2: Test ✓

1. Run existing test suite (should still pass)
2. Manually test with:
   - Arthur's RLN file (should render correctly)
   - Sample files (check for any issues)
   - Test file with prose (verify still readable)

### Phase 3: Document ✓

1. Update CLAUDE.md to note that line breaks are preserved
2. Add comment in code explaining the choice
3. Update journal with results

## Testing Strategy

### Unit Tests

No new unit tests needed - existing tests should still pass. The behavior change is intentional.

### Manual Tests

1. **Poetry/Lyrics Test:**
   - Load `2025.10.30 - RLN 05 - Without Goodbye-UDIO.md`
   - Verify each line renders on its own line
   - Check [Verse 1], [Chorus], etc. sections

2. **Prose Test:**
   - Create test file with wrapped prose:
     ```markdown
     # Test

     This is a paragraph that
     has been wrapped in the
     source file for readability.
     ```
   - Verify it renders with line breaks (expected new behavior)

3. **Sample Files:**
   - Load each sample file
   - Verify nothing looks broken
   - Check welcome.md, formatting.md, etc.

4. **Hard Break Test:**
   - Test that hard breaks (two spaces + newline) still work
   - Should create actual line breaks (doubled effect)

## Risk Assessment

**Low Risk** - This change:
- Is a simple one-line modification
- Makes behavior more intuitive
- Matches blockquote behavior (consistency)
- Can be reverted if issues arise
- Only affects rendering, not file storage

## Success Criteria

- [✓] RLN file renders with proper line breaks
- [✓] Each lyric line on its own line
- [✓] Sample files still render acceptably
- [✓] No crashes or errors
- [✓] All existing tests pass

## Backward Compatibility

**Breaking Change:** Yes, technically

**Impact:** Files with soft breaks will render differently

**Mitigation:**
- This is generally an improvement
- Users can remove newlines if they want single-line paragraphs
- The viewer is for viewing, not editing, so source conventions matter less

## Performance Impact

**None** - Just using a different parameter value to an existing function.
