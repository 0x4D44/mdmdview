<?xml version='1.0' encoding='windows-1252'?>
<!--
  Please do not remove these pre-processor If-Else blocks. These are used with
  the `cargo wix` subcommand to automatically determine the installation
  destination for 32-bit versus 64-bit installers. Removal of these lines will
  cause installation errors.
-->
<?if $(sys.BUILDARCH) = x64 or $(sys.BUILDARCH) = arm64 ?>
    <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
<?else ?>
    <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
<?endif ?>

<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

    <!-- WARNING: Never change the UpgradeCode GUID - it links all versions for upgrade detection -->
    <Product
        Id='*'
        Name='mdmdview'
        UpgradeCode='2D62FD4A-A4F8-43CD-9D12-5930D4152D20'
        Manufacturer='Martin Davidson'
        Language='1033'
        Codepage='1252'
        Version='$(var.Version)'>

        <Package Id='*'
            Keywords='Installer'
            Description='A markdown viewer for Windows'
            Manufacturer='Martin Davidson'
            InstallerVersion='450'
            Languages='1033'
            Compressed='yes'
            InstallScope='perMachine'
            SummaryCodepage='1252'
            />

        <MajorUpgrade
            Schedule='afterInstallInitialize'
            DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.'/>

        <Media Id='1' Cabinet='media1.cab' EmbedCab='yes'/>

        <Directory Id='TARGETDIR' Name='SourceDir'>
            <Directory Id='$(var.PlatformProgramFilesFolder)' Name='PFiles'>
                <Directory Id='APPLICATIONFOLDER' Name='mdmdview'>

                    <Component Id='License' Guid='*'>
                        <File Id='LicenseFile'
                            DiskId='1'
                            Name='LICENSE'
                            Source='LICENSE'
                            KeyPath='yes'/>
                    </Component>

                    <Component Id='binary0' Guid='*'>
                        <File
                            Id='exe0'
                            Name='mdmdview.exe'
                            DiskId='1'
                            Source='$(var.CargoTargetBinDir)\mdmdview.exe'
                            KeyPath='yes'/>

                        <ProgId Id='mdmdview.MarkdownFile'
                            Description='Markdown Document'
                            Icon='exe0' IconIndex='0'>
                            <Extension Id='md' ContentType='text/markdown'>
                                <Verb Id='open_md' Command='Open' TargetFile='exe0' Argument='"%1"' />
                            </Extension>
                            <Extension Id='markdown' ContentType='text/markdown'>
                                <Verb Id='open_markdown' Command='Open' TargetFile='exe0' Argument='"%1"' />
                            </Extension>
                        </ProgId>
                    </Component>

                </Directory>
            </Directory>
            <Directory Id='ProgramMenuFolder' Name='Programs'>
                <Directory Id='ApplicationProgramsFolder' Name='mdmdview'>
                    <Component Id='ApplicationShortcut' Guid='*'>
                        <Shortcut Id='ApplicationStartMenuShortcut'
                            Name='mdmdview'
                            Description='Markdown Viewer'
                            Target='[#exe0]'
                            WorkingDirectory='APPLICATIONFOLDER'
                            Icon='ProductICO' />
                        <RemoveFolder Id='CleanUpShortcutFolder'
                            Directory='ApplicationProgramsFolder'
                            On='uninstall'/>
                        <RegistryValue Root='HKCU'
                            Key='Software\mdmdview\Installer'
                            Name='StartMenuShortcut'
                            Type='integer' Value='1' KeyPath='yes'/>
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <Feature
            Id='Complete'
            Title='mdmdview'
            Description='Markdown viewer application'
            Level='1'
            ConfigurableDirectory='APPLICATIONFOLDER'
            AllowAdvertise='no'
            Absent='disallow'>
            <ComponentRef Id='License'/>
            <ComponentRef Id='binary0'/>
            <ComponentRef Id='ApplicationShortcut'/>
        </Feature>

        <SetProperty Id='ARPINSTALLLOCATION' Value='[APPLICATIONFOLDER]' After='CostFinalize'/>

        <Icon Id='ProductICO' SourceFile='icon.ico'/>
        <Property Id='ARPPRODUCTICON' Value='ProductICO' />
        <Property Id='ARPHELPLINK' Value='https://github.com/0x4D44/mdmdview'/>

        <UI>
            <UIRef Id='WixUI_Minimal'/>
        </UI>

        <WixVariable Id='WixUILicenseRtf' Value='wix\License.rtf'/>

    </Product>

</Wix>
