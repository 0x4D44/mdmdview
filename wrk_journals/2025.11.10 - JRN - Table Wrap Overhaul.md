# Work Journal - Table Wrap Overhaul

**Date:** 2025-11-10

## Entries

### 14:45 - Kickoff
- Reviewed plan and confirmed Stage 1 scope (fragment builder + helpers).
- Created journal file to log progress per user request.
### 15:20 - Stage 1 Fragment Builder
- Added CellFragment enum plus helper methods (currently behind dead_code allow outside tests).
- Implemented fragment splitter + span classifier with unit tests covering merge/split cases and consecutive widgets.
- Ran cargo fmt/test (all suites green) to validate no regressions.
### 15:35 - Stage 2 Prep
- Noted requirement to keep journaling throughout implementation; journal file already in place and will be updated after each milestone.
- Ready to start Stage 2 (layout job builder) next.
### 16:05 - Stage 2 Layout Job Builder
- Added layout-job scaffolding: highlight slicing helper, normalized span text, and append helpers + code color utilities.
- Implemented `build_layout_job_for_inline_spans` producing `LayoutJobBuild` (wrap width, plain text, link metadata) and new tests for wrapping, highlighting, and link ranges.
- Refactored existing highlight rendering to reuse the shared `highlight_slices` helper.
- Validated with `cargo fmt` + `cargo test` (77 tests).
### 16:15 - Stage 3 Planning
- Beginning Stage 3 (table renderer refactor). Will integrate fragment/layout builder behind feature flag for safe rollout.
### 16:45 - Stage 3 Partial Implementation
- Added `MDMDVIEW_TABLE_WRAP_OVERHAUL` env flag and new table-rendering path that uses fragment + layout-job pipeline when the flag is set.
- New helpers render cells via `LayoutJobBuild`, keep legacy grid as fallback when flag is off; added tests validating layout job output.
- Known gap: link clicks not yet wired in the flagged path (tooltips use hover text for now). Tests remain green.
### 17:05 - Stage 3 (Wrap Flag Wiring)
- Plumbed `table_wrap_overhaul_enabled` into `MarkdownViewerApp` (env flag) and status bar, so QA can confirm which renderer is active via the UI.
- Old grid renderer still available; new path gated via env. Need follow-up to add in-app toggle/CLI flag if desired.
### 17:15 - Stage 3 Link TODO
- Next step: restore link interactions in wrapped cells (hover cursor + click).
### 17:35 - Stage 3 Link Interactions
- Re-enabled link hover/click when wrap flag is on by laying out `LayoutJob`s manually, tracking galley + link ranges, and mapping pointer positions back to URLs.
- Status bar flag indicator already in place; next steps are broader QA + optional UI toggle.
### 17:45 - Next Steps
- Plan: add CLI/UI toggle for wrap flag and add regression sample for QA.
### 18:00 - CLI/UI Toggle + Regression Sample
- Added command-line flags (`--table-wrap` / `--no-table-wrap`) and status-bar/menu toggles so QA can enable/disable the new renderer without env vars.
- Synced renderer + app state via `set_table_wrap_overhaul_enabled` and created regression sample `examples/regressions/table-wrap.md`.
- Tests (`cargo fmt`, `cargo test`) still green.
### 18:30 - Stage 4 Cache Implementation
- Added per-cell layout cache (512 entry LRU) keyed by row/col, width, fonts, highlight, and content hash; flushes on zoom/highlight/toggle/load.
- Wrapped renderer now reuses cached `LayoutJob`s/galley instances and records hit/miss counters (future telemetry).
- CLI/UI toggles + regression sample already in place; ready for QA to validate performance gains.
### 18:50 - Stage 4 Cache Polish
- Implemented per-cell layout cache (512 entries) with LRU eviction, hit/miss counters, and invalidation on content/zoom/highlight/flag changes.
- Added CLI/UI toggles and regression sample earlier; Stage 4 now ready for QA to profile cache effectiveness.
### 19:00 - Next Steps
- Need cache metrics exposure (hit/miss) and QA profiling plan; consider docs update referencing new CLI/UI toggles.
### 19:15 - Cache Metrics Surfaced
- Renderer now exposes hit/miss counters and the status-bar tooltip shows cached stats when the wrap path is on; CLI/View menu toggles already wired.
- cargo fmt && cargo test ✅ (79 tests).
### 19:30 - Next Focus
- Need doc updates + QA perf plan leveraging cache stats; consider telemetry hook for hits/misses.
### 20:05 - Cache Hit Fix + Trace
- Row/col-aware cache keys now yield hits; added optional MDMDVIEW_TABLE_WRAP_TRACE logging + tooltip stats, plus README/QA doc updates and regression sample instructions.
- cargo fmt && cargo test ✅ (79 tests).
### 20:20 - QA Guide Added
- Documented table-wrap QA process (docs/QA-table-wrap.md), updated README feature blurb + instructions; regression CSV sample added; tests ✅.
### 21:00 - Legacy Path Bypass TODO
- Noted that legacy renderer still paints when flag is on -> need to short-circuit and always use wrapped path (incl. headers) + add cache clear button.
