# JRN - Regression Visual Test Suite

Date: 2025.12.25

## Entry 1
Started implementation for the regression visual test suite. Created the initial journal and prepared to add the Stage 0 decision log plus the Stage 1 corpus/manifest scaffolding.

## Entry 2
Stage 0/1: Added `tests/regression` scaffold with decisions in `tests/regression/README.md`, created `manifest.toml`, and wrote initial case markdown files plus local assets (`image-a.png`, `diagram.svg`) for image tests.

## Entry 3
Implemented Stage 2 screenshot mode: added CLI parsing for screenshot flags, deterministic capture flow, content-only chrome hiding, scroll offset support, settle-frame logic, metadata JSON output, zoom scale setter, and pending-render checks. Added regression tooling scaffolding (reference CSS, reference renderer, runner, requirements) plus a Windows CI smoke workflow and README updates for regression usage.

## Entry 4
Expanded Stage 3/4/5 support: added optional font-bundle handling in the reference renderer, wired `--test-fonts` through the runner, and recorded Playwright/browser versions in reference metadata. Implemented per-case diff mask support in the runner with mask-aware diff metrics. Updated regression docs, added a fonts README, ignored generated artifacts in git, and added CI caching for Playwright and reference outputs.

## Entry 5
Validation: `cargo fmt --all`, `cargo clippy --all-targets -- -D warnings`, and `cargo build --release`.

## Entry 6
Tried to install regression Python deps on Python 3.13 to generate reference outputs; Playwright's greenlet dependency failed to build (cp313). Updated `pillow` pin to 11.0.0 and noted Python 3.11/3.12 requirement in docs. Reference outputs still need to be generated with a supported Python version.

## Entry 7
Updated Playwright to 1.57.0 for cp313 wheels, installed Chromium, fixed reference renderer API usage, removed BOM in manifest, and generated reference outputs. Adjusted screenshot handling to normalize DPI and allow viewport resizing in screenshot mode. Set regression comparisons to use mdmdview baselines by default while still generating canonical references; captured new baselines and verified `runner.py run` passes. Ran `cargo clippy --all-targets -- -D warnings` after updates.

## Entry 8
Expanded regression documentation with setup steps, comparison modes, tolerances/mask guidance, and troubleshooting notes. Updated top-level README visual regression instructions.

## Entry 9
Ran `cargo clippy --all-targets -- -D warnings` after the latest screenshot/DPI changes and doc updates.

## Entry 10
Added comprehensive table regression cases (alignments, wrapping, escaping, missing/extra cells, inline elements, wide tables), updated the manifest, regenerated references/baselines, and reviewed outputs for table-specific issues.

## Entry 11
Implemented table alignment propagation through layout jobs/caching and render paths, added table-row inline-code pipe escaping with restore logic, and enabled horizontal scrolling for legacy/no-wrap wide tables. Added a unit test for code pipes inside table cells. Ran `cargo fmt --all` and `cargo test`.

## Entry 12
Updated table baselines for alignment/pipe fixes and reran regression suite (0 failures). Addressed clippy warnings (trim_end_matches, too many args) and ran `cargo clippy --all-targets -- -D warnings`.

## Entry 13
Added regression cases for table line breaks and legacy no-wrap missing cells, fixed `<br>` handling in inline parsing, and ensured legacy tables render empty cells/extra columns consistently. Ran `cargo fmt --all`, `cargo test`, rebuilt release, updated baselines for new cases, and reran the regression suite (0 failures).

## Entry 14
Handled `<br>`/breaks inside inline styles (strong/emphasis/links) by threading break handling into `collect_until_tag_end`. Added a bold line-break row to the table line-breaks case, updated its baseline, and reran `cargo fmt --all`, `cargo test`, rebuild, and the regression suite (0 failures).

## Entry 15
Fixed HTML `<br>` detection to accept attributes (e.g., `<br class="tight">`). Added an attribute break row to the table line-breaks case, updated its baseline, and reran `cargo fmt --all`, `cargo test`, rebuild, and the regression suite (0 failures).

## Entry 16
Improved table cell hover tooltips so clipped single-line text (long words/code) now shows the full content on hover, not just multi-line wraps.

## Entry 17
Fixed table inline-code pipe escaping for tables inside blockquotes by stripping blockquote prefixes during table prepass detection while still honoring indented code blocks. Added unit tests for blockquote tables/code blocks and reran `cargo fmt --all` + `cargo test`.

## Entry 18
Fixed table prepass to recognize fenced code blocks inside blockquotes (tracks blockquote level for fence start/end), preventing inline-code pipe escaping inside blockquoted fences. Added unit test coverage and reran `cargo fmt --all` + `cargo test`.

## Entry 19
Fixed table inline-code pipe escaping so unmatched backticks no longer cause pipes to be escaped (prepass now rolls back pipe sentinels for unterminated code spans). Added a unit test and reran `cargo fmt --all` + `cargo test`.

## Entry 20
Fixed table cell alignment so right/center aligned text can overflow left when wider than the column (preserves alignment instead of forcing left alignment on overflow). Added a unit test for overflow alignment and reran `cargo fmt --all` + `cargo test`.

## Entry 21
Fixed table header height estimation by caching actual header cell heights per table and requesting repaint when header content needs more space, preventing clipped headers in narrow columns. Added a metrics unit test and reran `cargo fmt --all` + `cargo test`.

## Entry 22
Fixed table emoji rendering so link-only emoji spans remain interactive (no longer converted into standalone emoji fragments). Added a unit test for link emoji fragments and reran `cargo fmt --all` + `cargo test`.

## Entry 23
Added list-item fenced code block detection to the table pipe-escape prepass so pipes inside list fences remain untouched. Added a unit test for list fenced blocks and reran `cargo fmt --all` + `cargo test`.

## Entry 24
Fixed table inline-code pipe escaping to ignore backticks that are escaped in plain text (backslashes no longer start code spans). Added a unit test for escaped backticks and reran `cargo fmt --all` + `cargo test`.

## Entry 25
Fixed table inline-code pipe escaping so list-item indented code blocks are no longer treated as tables (list marker parsing now detects code indentation). Added unit test coverage and reran `cargo fmt --all` + `cargo test`.

## Entry 26
Fixed table detection so delimiter rows must include at least one pipe, preventing horizontal-rule lines from triggering table inline-code escaping. Added a unit test and reran `cargo fmt --all` + `cargo test`.

## Entry 27
Fixed table pipe-escape prepass for tables nested inside list items (handles list content indentation for delimiter/row detection). Added a unit test for nested list tables and reran `cargo fmt --all` + `cargo test`.

## Entry 28
Fixed table pipe-escape prepass to handle tables that start on the line after an ordered list marker (using list content indentation) without misclassifying list-indented code blocks. Added unit coverage for the ordered-list case and reran `cargo fmt --all` + `cargo test`.

## Entry 29
Fixed table pipe-escape detection for list tables separated by blank lines (now scans back across blank/indented lines to find list markers without misclassifying list-indented code blocks). Added a unit test for the blank-line list table case and reran `cargo fmt --all` + `cargo test`.

## Entry 30
Fixed table pipe-escape prepass to recognize nested list markers indented beyond three spaces when still within a parent list context, while avoiding list-indented code blocks. Added unit tests for 4-space nested lists, deeply nested lists, and indented list-marker code blocks, then reran `cargo fmt --all` + `cargo test`.

## Entry 31
Fixed table pipe-escape detection for tables inside list-item blockquotes by stripping list indentation before blockquote parsing, while keeping list-marker header detection intact. Added a unit test for list-item blockquote tables and reran `cargo fmt --all` + `cargo test`.

## Entry 32
Fixed table pipe-escape detection for list items whose content is indented by four spaces after the marker (valid list content, previously misclassified as code). Removed the list-marker code-block heuristic, adjusted list-code tests to use real list code blocks, and added coverage for 4-space list marker tables. Reran `cargo fmt --all` + `cargo test`.

## Entry 33
Fixed table row detection so pipes inside inline code no longer keep a table "open" beyond its end. Added a helper to check for pipes outside inline code and a test ensuring paragraphs with inline code pipes after a table are not escaped. Reran `cargo fmt --all` + `cargo test`.

## Entry 34
Fixed table row detection to ignore escaped pipes outside inline code, preventing table prepass from continuing into paragraphs that only contain `\|`. Added a regression test for escaped-pipe paragraphs after tables and reran `cargo fmt --all` + `cargo test`.

## Entry 35
Fixed list-table detection so tables end when list indentation is no longer present (even if following lines contain pipes), preventing inline-code pipe escaping in dedented paragraphs after list tables. Added a regression test for list-table dedent with pipes and reran `cargo fmt --all` + `cargo test`.

## Entry 36
Fixed nested-list fenced code block handling in the table pipe-escape prepass by adding a parent list indent lookup and reusing it for list marker detection. This keeps fences inside nested lists from being treated as tables. Reran `cargo fmt --all` + `cargo test`.

## Entry 37
Fixed table pipe-escape prepass to honor list continuation indentation when detecting fenced code blocks, ensuring list-item blockquote fences are not misclassified as tables. Added a regression test for list-item blockquote fenced blocks and reran `cargo fmt --all` + `cargo test`.

## Entry 38
Fixed blockquote table detection for lines that use a tab after the `>` marker, so inline-code pipe escaping works in those tables. Added a regression test for tab-separated blockquote tables and reran `cargo fmt --all` + `cargo test`.

## Entry 39
Extended list-table coverage to tab-indented nested lists, ensuring inline-code pipes are escaped inside the table but not after a dedent. Added two unit tests for tab-indented list tables and reran `cargo fmt --all` + `cargo test`.

## Entry 40
Fixed tab indentation handling for list marker parsing and indent stripping to honor tab stops (instead of treating tabs as fixed 4 columns). Added unit tests covering tab stops after list markers and in leading whitespace, and reran `cargo fmt --all` + `cargo test`.

## Entry 41
Fixed list-table prepass to use full list content indentation when tracking table scope, preventing nested list tables from leaking inline-code pipe escaping into following list paragraphs. Added a regression test for nested list table dedent handling and reran `cargo fmt --all` + `cargo test`.

## Entry 42
Fixed list-marker table detection when the list item starts with a blockquote (e.g., `- > | Col | ... |`), ensuring blockquote level is derived from list content rather than the raw list marker line. Added unit coverage for blockquote tables that begin on the list marker line and reran `cargo fmt --all` + `cargo test`.

## Entry 43
Fixed list-marker table detection so delimiter rows must remain within list indentation; dedented delimiter lines no longer start a table. Added a unit test that ensures inline-code pipes on the list header line remain unescaped when the delimiter is outdented, and reran `cargo fmt --all` + `cargo test`.

## Entry 44
Fixed table prepass handling for tables inside list items within blockquotes by supporting list indentation either before or after blockquote markers. Added a unit test for blockquote lists containing tables and reran `cargo fmt --all` + `cargo test`.

## Entry 45
Refined list+blockquote table parsing so list indentation can be stripped either before or after blockquote markers when scanning table rows. Added coverage for blockquote lists with tables and reran `cargo fmt --all` + `cargo test`.

## Entry 46
Fixed table column width persistence collisions for duplicate header labels by including column index in the policy hash. Added a unit test to guard hash uniqueness and reran `cargo test`.

## Entry 47
Fixed resizable column persistence to use a stable policy hash (ignoring preferred width), preventing user-resized widths from reverting on the next frame. Updated unit tests and reran `cargo test`.

## Entry 48
Fixed table divider/border positioning to use the table layout bounds (not just content bounds), preventing misaligned borders when the first column is centered or right-aligned. Reran `cargo test`.

## Entry 49
Fixed table cell emoji rendering so only pure-emoji cells render as emoji images, preventing bold/emphasized emoji from breaking inline flow with adjacent text. Added unit coverage and reran `cargo test`.

## Entry 50
Fixed legacy table horizontal scroll to use per-table IDs so scroll offsets no longer bleed between tables when table wrap is disabled.

## Entry 51
Fixed table divider and border positioning in the TableBuilder path to account for column spacing, preventing separators from drifting into column content.

## Entry 52
Fixed highlight updates to avoid clearing persisted table widths and unnecessary cache clears, and added a unit test to guard persisted widths across highlight changes.

## Entry 53
Fixed legacy table width calculations to account for inter-column spacing, so horizontal scrolling and width allocation no longer ignore spacing.

## Entry 54
Adjusted legacy table width measurement to respect explicit line breaks (max line width instead of summed lines) to avoid overstated no-wrap columns. Added a unit test for line-break measurements and added a no-wrap line-break regression case plus manifest entry (case 020).

## Entry 55
Fixed TableBuilder border rendering for single-column tables by drawing borders/header separator even when there are no vertical dividers. Added a regression case for a single-column table (case 021) and updated the manifest.

## Entry 56
Fixed legacy table width measurement to normalize unicode text (matching render-time normalization and superscript expansion) so column sizing reflects actual rendered text. Added unit coverage for unicode normalization in width measurement and added a no-wrap unicode table regression case (case 022).

## Entry 57
Fixed legacy table border styling to use theme-aware window stroke (improves visibility in dark theme). Added a dark-theme legacy table regression case (case 023) and manifest entry.

## Entry 58
Fixed markdown BOM handling by stripping UTF-8 BOMs during file load, preventing headings/tables from being misparsed when files start with BOM. Added unit coverage in app file loading. Also stripped BOMs in the reference renderer for CSS/markdown to keep canonical outputs clean.
## Entry 59
Refactored list parsing/rendering to treat list items as block collections so tables and other blocks can render inside lists. Added a per-frame table counter for stable table ids across nested tables. Added a regression case for tables inside lists (case 024) and updated the manifest.

## Entry 60
Updated blockquote rendering to handle block elements (so tables render inside quotes) and preserved override text color during quote rendering. Fixed list/blockquote tests for the ListItem block structure and collect_blockquotes signature. Added a blockquote table regression case (case 025) and updated the manifest. Ran `cargo fmt --all` + `cargo test`.

## Entry 61
Adjusted list marker coloring to use the current UI text color so bullets/numbers respect quote text overrides (fixes dark quote backgrounds showing black markers). No tests run for this change.

## Entry 62
Fixed table detection to insert a scoped blank line before table headers when a table immediately follows non-blank text (enables blockquote/list tables that markdown-it parses). Added unit coverage for blockquote tables following paragraphs and list items. Ran `cargo fmt --all` + `cargo test`.

## Entry 63
Fixed TableBuilder ID clashes by scoping table rendering with ui.push_id(table_id), eliminating duplicate table state warnings. Added unit tests for blockquote tables following paragraphs and blockquote list tables after text, and adjusted the blockquote table regression case to include blank lines for markdown-it compatibility. Ran `cargo fmt --all`, `cargo test`, and `cargo build`.

## Entry 64
Fixed table layout cache coloring by keying cached layout jobs on current text color (prevents stale header colors in blockquotes or after theme changes). Added unit coverage for color-sensitive cache keys and ran `cargo fmt --all` + `cargo test`.

## Entry 65
Fixed strong text color handling to respect override text color, ensuring table headers render correctly in blockquotes. Added unit coverage for strong text color selection and ran `cargo fmt --all`, `cargo test`, and `cargo build`.

## Entry 66
Fixed single-column table alignment drift by scoping `TableBuilder` state to an available-width bucket and forcing the table layout to a consistent max width before rendering. Captured updated screenshots for the single-column case plus list/blockquote tables to confirm layout stability.

## Entry 67
Fixed missing table rows and clipped images in the new TableBuilder renderer by disabling its internal vertical scrolling (`TableBuilder::vscroll(false)`), which was virtualizing rows under a nested scroll area. Captured screenshots for line-break tables (wrap and no-wrap), inline elements, and blockquote/list tables to verify all rows render.

## Entry 68
Fixed wide tables truncating extra columns by wrapping the TableBuilder renderer in a horizontal ScrollArea sized to the estimated total column width. Captured a new wide-table screenshot to confirm columns can be scrolled horizontally.
