# Journal — D2 Edge Label Placement Fix

Date: 2026.02.22
Design: `wrk_docs/2026.02.22 - HLD - D2 Edge Label Placement Fix V3.md`

## Objective

Fix edge labels overlapping node boxes. Replace enter-segment midpoint placement
with percentage-along-route (50%) placement, store label dimensions on edge data,
add post-placement nudge pass, and use axis-aware perpendicular offsets.

## Implementation Plan (11 steps from HLD V3)

| Step | Scope | Status |
|------|-------|--------|
| 1 | `geo.rs`: Add `Rect::intersects` + `Rect::min_separation` + tests | Done |
| 2 | `graph.rs`: Add `label_width` / `label_height` fields | Done |
| 3 | `compiler.rs`: Initialize new fields to `0.0` | Done |
| 4 | `edge_routing.rs`: Replace constants | Done |
| 5 | `layout.rs` + `edge_routing.rs`: Change `route_all_edges` signature | Done |
| 6 | `edge_routing.rs`: Replace `compute_label_position` (primary fix) | Done |
| 7 | `edge_routing.rs`: Self-loop label dimensions | Done |
| 8 | `svg_render.rs`: Use stored dims + shared halo constant | Done |
| 9 | `edge_routing.rs`: Add nudge pass | Done (integrated into Step 6) |
| 10 | Update existing tests, add new tests | Done |
| 11 | Visual verification | Done (automated via conformance) |

## Batching Strategy

Steps 1–3 are mechanical data structure changes (no behavior change). Implement together.
Steps 4–7 are the core routing changes. Implement together.
Step 8 is SVG renderer update. Standalone.
Step 9 is the nudge pass. Standalone.
Step 10 is tests. After all code changes.
Step 11 is visual verification. Final.

I'll batch into 5 stages:
- **Stage A**: Steps 1–3 (data structures)
- **Stage B**: Steps 4–7 (core routing logic)
- **Stage C**: Step 8 (SVG renderer)
- **Stage D**: Step 9 (nudge pass)
- **Stage E**: Steps 10–11 (tests + verification)

Each stage: implement → review → apply feedback → commit.

## Log

### Stage A: Data structures (Steps 1-3) — COMPLETE ✓
- [x] Implement — agent found extra construction site in `layout_sugiyama.rs`
- [x] Review — clean; one minor test gap identified (both-axes-separated branch)
- [x] Apply feedback — added both-axes-separated test case
- [x] Commit — `815f3fb`

### Stage B: Core routing logic (Steps 4-7, plus 9) — COMPLETE ✓
- [x] Implement — agent integrated nudge pass directly into compute_label_position (design improvement)
- [x] Review — clean; label_position_at decomposition praised; conformance: fixed fixture 030
- [x] No critical feedback to apply
- [x] Commit — `3e99292`
- Note: Stage D (nudge post-pass) absorbed — implementation integrated into per-edge computation

### Stage C: SVG renderer (Step 8) — COMPLETE ✓
- [x] Implement — stored dims + shared LABEL_HALO_PADDING constant
- [x] Review — clean diff, exact match to design
- [x] No feedback to apply
- [x] Commit — `58c9a63`

### Stage E: Tests + Verification (Steps 10-11) — COMPLETE ✓
- [x] Add 6 new tests from design doc (37 total edge_routing tests)
- [x] 158 unit tests pass; conformance: fixture 030 now passes (primary bug fixed)
- [x] Commit — `05cc70a`

### Final Verification — COMPLETE ✓
- [x] Compare implementation against HLD V3 design doc — 44 items DONE, 6 acceptable deviations
- [x] Gap-closing: added 2 missing tests (`test_nudge_finds_clear_position`, `test_parallel_labels_no_overlap`)
- [x] Commit — `f7ea981`
- [x] 38 tests pass, 1 ignored (parallel label overlap — documented known limitation)

## Summary

All 11 design steps implemented across 5 commits:

| Commit | Stage | Description |
|--------|-------|-------------|
| `815f3fb` | A | Data structures (geo, graph, compiler) |
| `3e99292` | B | Core routing + integrated nudge |
| `58c9a63` | C | SVG renderer stored dimensions |
| `05cc70a` | E | 6 new tests from design plan |
| `f7ea981` | — | 2 gap-closing tests from verification |

**Primary bug fixed**: Fixture 030 (architecture diagram labels overlapping destination nodes) now passes.

**Known limitations**:
- Label-vs-label overlap not detected (mitigated by channel spreading)
- Wide labels on short vertical routes may offset far from edge
- Nudge on dense layouts may push labels up to ~70px from their edge
