# JRN - Built-in Mermaid Rendering

Date: 2025.12.25

## Entry 1
Start implementation of the built-in Mermaid rendering plan. Reviewed current Mermaid handling in `src/markdown_renderer.rs` and identified existing QuickJS/Kroki paths to refactor into a dedicated module. Next: introduce `src/mermaid_renderer.rs` with service skeleton and wire it into `MarkdownRenderer`, keeping behavior unchanged.

## Entry 2
Created `src/mermaid_renderer.rs` and moved Mermaid/Kroki logic and tests into it, including a local QuickJS path and Kroki worker pool. Added shared image decoding helpers in `src/image_decode.rs` and updated `src/markdown_renderer.rs` to delegate Mermaid rendering to the new module while keeping UI integration intact.

## Entry 3
Ran `cargo fmt --all`, `cargo clippy --all-targets -- -D warnings`, and `cargo build --release` after refactors. Fixed clippy warnings by scoping `HashSet` imports to tests and tightening Mermaid renderer visibility. All checks and release build succeeded.

## Entry 4
Implemented Stage 2: added an async QuickJS worker pool for Mermaid rendering, upgraded the DOM shim with text measurement stubs, promise-aware rendering wrapper, and runtime time/memory limits. Wired new result/pending tracking into Mermaid rendering flow and reran `cargo fmt`, `cargo clippy --all-targets -- -D warnings`, and `cargo build --release`.

## Entry 5
Implemented Stage 3: moved SVG rasterization into QuickJS workers with shared fontdb, blocked external image hrefs, and added width/scale/background keyed LRU caches for SVGs/textures plus raster error caching. Updated render flow to use texture keys, added cache/scale tests, and reran `cargo fmt --all`, `cargo clippy --all-targets -- -D warnings`, and `cargo build --release`.

## Entry 6
Ran `cargo test`; one pre-existing failure in `markdown_renderer::tests::test_resolve_table_widths_branches` (expected [5.0, 5.0] but got [0.0, 0.0]). No Mermaid changes touched that logic.

## Entry 7
Implemented Stage 4: added renderer preference parsing (embedded/kroki/off), site config JSON builder with strict security defaults, deterministic ID seed, and theme variable merging. Updated Mermaid init/render JS to sanitize directives, merge configs, and disable html labels under strict mode. Added tests for renderer preference and security parsing, and reran `cargo fmt --all`, `cargo clippy --all-targets -- -D warnings`, and `cargo build --release`.

## Entry 8
Updated README Mermaid terminology to "embedded" for QuickJS rendering, refreshed optional feature wording, asset comment, and troubleshooting label.

## Entry 9
Ran `cargo fmt --all`, `cargo clippy --all-targets -- -D warnings`, and `cargo build --release` (clean). `cargo test` still fails at `markdown_renderer::tests::test_resolve_table_widths_branches` with [0.0, 0.0] vs [5.0, 5.0], matching the previously observed failure.

## Entry 10
Adjusted `resolve_table_widths` to distribute extra width when desired equals mins and to handle zero totals without collapsing. Ran `cargo fmt --all`, `cargo clippy --all-targets -- -D warnings`, `cargo test`, and `cargo build --release` (all clean).
