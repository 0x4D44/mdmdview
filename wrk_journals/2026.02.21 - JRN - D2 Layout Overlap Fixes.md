# Journal — D2 Layout Overlap Fixes Implementation

**Date:** 2026-02-21
**HLD:** `wrk_docs/2026.02.21 - HLD - D2 Layout Overlap Fixes V3.md`
**Status:** COMPLETE

## Plan

Three phases, implemented sequentially with TDD:

1. **Phase 1 (Fix A1+A2)**: Container descendant stranding fix — Critical
2. **Phase 2 (Fix B2)**: Edge label positioning — Moderate
3. **Phase 3 (Fix C)**: Adaptive container spacing — Low

Each phase: write tests → implement → review → apply feedback → commit.

## Commits

| Hash | Phase | Description |
|------|-------|-------------|
| `fd7be24` | 1 | fix: resolve container descendant stranding in D2 layout |
| `283be34` | 2 | fix: use geometric midpoint for D2 edge label placement |
| `b1009ad` | 3 | fix: add adaptive spacing for D2 container nodes |

## Log

### Phase 1 — Container Descendant Fix (Critical)

- **Files:** `graph.rs`, `layout_sugiyama.rs`, `layout.rs`

#### 1A. Tests
- 4 tests + `assert_no_leaf_overlap` helper
- `test_nested_container_no_overlap` confirmed the stranding bug (leaves at same y=108)

#### 1B. Implementation
- Added `reposition_node`, `offset_node`, `offset_subtree_inner` to D2Graph
- Patched 3 call sites in `layout_sugiyama.rs`
- Replaced `fit_containers` (triple-call bug: 3×24=72px) with `compute_root_bbox`

#### 1C. Code Review
- Verdict: **Approve with minor suggestions, no required changes**
- Applied: `let...else` pattern, epsilon comment, 2 directional container tests

#### Result: 107 → tests pass, zero warnings

### Phase 2 — Edge Label Positioning (Moderate)

- **File:** `edge_routing.rs`

#### Implementation
- Replaced Bézier midpoint + hardcoded -10px with geometric midpoint of clipped endpoints
- Set `label_position = None` for unlabeled edges
- Removed dead `bezier_midpoint` function

#### Code Review
- Verdict: **Approve, no required changes**
- Applied: removed dead code instead of `#[allow(dead_code)]`

#### Result: 109 tests pass, zero warnings

### Phase 3 — Adaptive Container Spacing (Low)

- **File:** `layout_sugiyama.rs`

#### Implementation
- Added `CONTAINER_CROSS_SPACING = 60.0` and `CONTAINER_RANK_SPACING = 80.0`
- Container-aware spacing in `assign_coordinates` (all 4 direction arms + centering)

#### Code Review
- Verdict: **Approve, no required changes**
- Noted: asymmetric gap semantics, `arrange_in_line` not updated (cosmetic)

#### Result: 111 tests pass, zero warnings

### Final Verification

All items from V3 HLD verified 100% complete:
- Fix A1: 3 methods on D2Graph, 3 call sites patched ✓
- Fix A2: fit_containers deleted, compute_root_bbox added ✓
- Fix B2: geometric midpoint, None for unlabeled ✓
- Fix C: container-aware spacing constants + logic ✓
- Tests: all 8 HLD tests + 3 bonus tests ✓
- 111 tests pass, zero warnings ✓
