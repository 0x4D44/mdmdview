# Journal — D2 Orthogonal Edge Routing Implementation

**Date:** 2026-02-21
**Plan:** `wrk_docs/2026.02.21 - PLN - D2 Orthogonal Edge Routing.md`
**HLD:** `wrk_docs/2026.02.21 - HLD - D2 Orthogonal Edge Routing V3.md`

---

## Progress

| Stage | Status | Commit | Notes |
|-------|--------|--------|-------|
| 1 — Data Model | Done | `0cce2c6` | RouteType enum, field on D2EdgeData, version bump to 0.2.0 |
| 2 — Utilities + Polyline | Done | `f61b207` | Hierarchy utils (4 fns, 9 tests), SVG polyline (1 fn, 5 tests) |
| 3 — Orthogonal Router | Done | `75d2396` | Three-pass router + code review fixes (6 issues) |
| 4 — Label Placement | Done | `01aed4e` | Enter-segment labels, axis-aware offset, 4 new tests |
| 5 — Full Build + Visual | Done | — | Full workspace builds clean, 147 tests pass |

---

## Log

### Entry 1 — Kickoff
- Starting Stage 1: Add `RouteType` enum and field to `D2EdgeData`
- Spawning implementation agent for Stage 1

### Entry 2 — Stage 1 Complete
- RouteType enum added to graph.rs (Bezier, Orthogonal variants)
- route_type field added to D2EdgeData
- All struct literals updated (compiler.rs, edge_routing.rs tests, layout_sugiyama.rs tests)
- Version bumped to 0.2.0
- 127 tests pass, commit `0cce2c6`

### Entry 3 — Stage 2 Complete
- Two parallel agents: 2A (hierarchy utilities) and 2B (SVG polyline)
- 2A: ancestor_chain, find_lca, child_ancestor_of, effective_direction + 9 tests
- 2B: polyline_with_rounded_corners, build_bezier_path extraction, RouteType branch + 5 tests
- 132 tests pass, commit `f61b207`

### Entry 4 — Stage 3 Starting
- Spawning agent for the core orthogonal router
- Three-pass architecture: Classify → Allocate → Build
- This is the largest stage — replaces Bézier routing for all non-self-loop edges

### Entry 5 — Stage 3 Complete
- Three-pass orthogonal router implemented (965 insertions, 115 deletions)
- Code review found 6 issues, all fixed:
  1. Critical: Added missing `lca` field to `EdgeClassification`, fixed channel grouping key
  2. Critical: Fixed same-rank dest port side (jog side, not opposite)
  3. Removed dead code in channel clamping
  4. Merged identical `build_forward_route`/`build_backward_route` into `build_three_segment_route`
  5. Extracted `LABEL_OFFSET` constant from hardcoded 10.0
  6. Skip container-descendant edges in channel allocation
- 143 tests pass, commit `75d2396`

### Entry 6 — Stage 4 Complete
- Changed `compute_label_position` to use enter segment (last segment before destination)
- Fixed perpendicular offset: horizontal → Y upward, vertical → X leftward
- Added 4 new tests (label_horizontal, label_vertical, label_unlabeled, labels_spread)
- All existing label tests pass unchanged
- 147 tests pass, commit `01aed4e`

### Entry 7 — Stage 5 Complete
- Full workspace debug build: zero warnings
- Full workspace release build: zero warnings
- All 147 D2 tests pass
- App launches with test file, no crashes
- Screenshot capture failed (RDP/display issue) — visual verification deferred to user

### Entry 8 — Completeness Check
- Audit found 3 missing tests:
  1. `test_orthogonal_route_renders_polyline` (Stage 2B, svg_render) — added
  2. `test_ortho_channel_spread` (Stage 3, edge_routing) — added
  3. `test_ortho_deep_nesting` (Stage 3, edge_routing) — added
- 150 tests pass, commit `44f2176`
- All plan items verified: constants, types, functions, tests — 100% complete

### Summary
- **4 commits:** `0cce2c6`, `f61b207`, `75d2396`, `01aed4e`, `44f2176`
- **150 tests** (18 pre-existing + 132 new across all stages)
- **Zero warnings** in debug and release builds
- **Code review** performed with 6 issues found and fixed
- **Completeness audit** performed with 3 missing tests added
