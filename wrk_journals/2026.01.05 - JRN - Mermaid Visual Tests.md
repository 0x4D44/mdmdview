# Mermaid Visual Tests Journal

## 2026.01.05
- Ran class/class_complex review packs after enabling computed style defaults and viewBox-aware bbox fallback; class_complex now within thresholds, class still over diff threshold (~15.7%).
- Diagnosed classDiagram SVG viewBox too small; added viewBox-stripped usvg parse for bbox sizing and removed enforced overflow=hidden in svg normalization.
- Confirmed class rendering now visible (no longer sparse); differences are mostly padding/margins vs reference.
- Next: re-run broader failing set (er/flowchart/state/timeline/mindmap), adjust bbox/transform alignment for class, and validate against reference crops.

## 2026.01.05 (continued)
- Ran review pack subset (er/flowchart/flowchart_subgraph/gitgraph/state/state_nested/timeline). flowchart/state/state_nested pass; er/gitgraph/timeline failed (er 12.28%, gitgraph 15.43%, timeline 16.74%).
- Added svg child-bounds handling in __mdmdview_bbox and re-generated timeline; viewBox now large enough and layout matches reference (arrow length, title centering) though diff still over pixel threshold.
- Added lightweight CSS class font-size parsing to DOM shim; er and gitgraph now pass (er 8.25%, gitgraph 2.95%).
- Class diagram still failing (diff ~18%); multi-case class runs timing out, single case now shows clipping/padding mismatches.
- New debug outputs under tests/mermaid_visual/debug_dump_timeline2, debug_dump_er, debug_dump_gitgraph; review packs under tests/mermaid_visual/review_pack/2026.01.05-*.


## 2026.01.05 (continued)
- Added font-weight-aware text measuring: JS passes weight into native measurer; Rust now selects bold face and applies fallback bold width scaling; DOM shim parses class-based font weights.
- Tightened CSS selector parsing to avoid descendant selector misapplication; added classTitle weight handling and line-height scaling to better match reference baselines.
- Rebuilt release and re-ran class review packs; class now visually matches reference, but diff remains ~14.4% due to rasterization/text antialias differences.
- Current class output dimensions nearly identical to reference (rect width/height within ~0.3px); remaining diffs are subtle text edge deltas.
- Next: decide on diff tolerance adjustments vs further renderer tweaks; re-run full failing set (including mindmap/timeline) once class strategy chosen.

## 2026.01.05 (continued)
- Added Promise-based timer pumping in the mermaid wrapper plus setInterval/clearInterval support in the DOM shim; attempted to unblock mindmap rendering.
- Patched Mermaid mindmap layout to use breadthfirst and bypass p.ready with immediate resolve; patch confirms applied via debug logs.
- Mindmap still hangs (pending_renders/timeouts) after 20-60s waits; no SVG emitted, screenshot stays on "Rendering diagram locally...". Debug dumps: debug_dump_mindmap4/5/6/7, debug_dump_mindmap_wait2.
- Extracted reference mindmap SVG via mmdc for layout inspection at tests/mermaid_visual/debug_dump_mindmap_ref/mindmap.svg.
- Current blockers: mindmap render promise never resolves in QuickJS; next step is to replace cytoscape-based layout with a deterministic in-JS layout or further patch mindmap renderer to return SVG synchronously.

## 2026.01.05 (continued)
- Added a cytoscape stub and deterministic mindmap layout in the DOM shim; patched Mermaid JS to use the stub for mindmap rendering.
- Mindmap now renders (pending_renders=false) and produces SVG; output is horizontally laid out with left/right branches instead of the reference's radial/angled layout.
- Tweaked mindmap spacing (gap_x/gap_y) and per-side vertical offsets to better center left/right subtrees; diff still ~23%.
- Latest review pack mindmap outputs: tests/mermaid_visual/review_pack/2026.01.05-round13 and 2026.01.05-round14.
- Next: improve mindmap layout to match reference angles and child spread, and re-run gitgraph/timeline after mindmap settles.

## 2026.01.05 (continued)
- Replaced the mindmap layout with a radial, angle-bucketed layout to better match Mermaid's reference mindmap geometry; edges now connect via radial offsets from node bounds.
- Added label-based child sorting and symmetric angle ranges; iterated on gap/angle math to spread branches more like the reference.
- Mindmap now renders consistently (pending_renders=false) but diff remains ~26% due to remaining geometry differences.
- Latest outputs: tests/mermaid_visual/review_pack/2026.01.05-round15 and 2026.01.05-round16.
- Next: tune angle ranges/radius per depth and add curvature/segment offsets to match Mermaid's edge routing; then re-run gitgraph/timeline.

## 2026.01.05 (continued)
- Iterated on root angle ranges and spacing; removed the root-side nudge block and tried tighter left/right ranges with right-side adjustments.
- Updated depth-0 distance factor to reduce cosine stretching and increased the single-child factor to keep branches compact.
- Ran mindmap review packs: round27 diff 18.74%, round28 diff 24.89%, round29 diff 19.65% (still above threshold). Outputs in tests/mermaid_visual/review_pack/2026.01.05-round27 through 2026.01.05-round29.
- Current layout still clusters too tight around root; Research/Notes are stacked more vertically than reference and Origins sits flatter than the reference angle.
- Next: recalibrate root angles toward target positions (Origins ~160 deg, Uses ~130 deg, Research ~-5 deg) and adjust child spread to lift Notes and lower Planning.

## 2026.01.05 (continued)
- Switched mindmap spread to a larger base (38 deg) with left-side bias; updated child spread/offset rules and depth spacing to better match reference angles.
- Increased depth distances and added depth-specific factor adjustments to push grandchildren outward without distorting root geometry.
- Mindmap diff dropped to 7.77% (round33) and 6.94% (round34); round34 passes thresholds. Outputs in tests/mermaid_visual/review_pack/2026.01.05-round33 and tests/mermaid_visual/review_pack/2026.01.05-round34.
- Extracted angle and distance diagnostics from debug SVGs to align child branch angles with the reference.
- Next: re-run the broader mermaid suite to ensure other diagrams remain in-threshold and check whether any minor spacing tweaks are still needed for mindmap.

## 2026.01.06 (continued)
- Ran full mermaid visual pack to check for regressions: tests/mermaid_visual/review_pack/2026.01.05-full (command returns nonzero due to zenuml warnings, but report.json and index.html were generated).
- Failing cases: class (14.47% diff), gantt (sparse_render; near-empty output), gitgraph (12.94% diff), timeline (diff_pixels 54850 exceeds pixel threshold).
- Passing cases: class_complex, er, flowchart, flowchart_subgraph, journey, mindmap, pie, sequence, sequence_alt_loop, state, state_nested.
- Next: inspect gantt sparse render, re-check gitgraph/timeline diffs, and decide whether to tune thresholds or adjust rendering.
