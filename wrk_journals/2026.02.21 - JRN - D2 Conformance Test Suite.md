# JRN — D2 Conformance Test Suite

Date: 2026.02.21

## Overview

Building a conformance test suite that compares our D2 renderer (`crates/d2`) against the canonical D2 CLI. Structural SVG comparison (not pixel-diff) to catch label-over-node overlaps and edges passing through boxes.

## Status

### Stage 1: Parallel Implementation — COMPLETE
- [x] Agent A: Create all 24 .d2 fixture files (001-053)
- [x] Agent B: Build Python tooling (5 scripts)
- [x] Agent C: Build Rust test harness
- [x] Generate reference SVGs via D2 CLI (ELK layout, v0.7.1)

### Stage 2: Code Review & First Run — COMPLETE
- [x] Code review all implementations (3 parallel reviewers)
- [x] Run first conformance suite (14 violations → 7 after false positive fix)
- [x] Document baseline pass/fail

### Stage 3: Apply Feedback & Finalize — COMPLETE
- [x] Apply review feedback (endpoint-aware edge-through-node checks)
- [x] Final conformance run
- [x] Verification against plan (in progress)

## Conformance Baseline Results

### Summary: 24 fixtures, 7 genuine violations, 0 render errors

| Fixture | Status | Violations |
|---------|--------|------------|
| 001-simple-connection | OK | - |
| 002-three-chain | OK | - |
| 003-reverse-direction | OK | - |
| 004-bidirectional | OK | - |
| 005-self-loop | OK | - |
| 010-labeled-edge | OK | - |
| 011-multi-labeled-edges | FAIL | 5x edge_not_through_node (edge a->c passes through node b) |
| 012-long-label | OK | - |
| 013-label-horizontal | OK | - |
| 020-simple-container | OK | - |
| 021-nested-containers | OK | - |
| 022-cross-container-edge | OK | - |
| 023-container-to-child | OK | - |
| 030-architecture-labels | FAIL | 1x label_not_overlapping_node (label "verify" overlaps Auth node) |
| 031-vertical-edge-through-node | OK | - |
| 032-label-near-box | FAIL | 1x edge_not_through_node |
| 033-parallel-labeled-edges | OK | - |
| 040-cylinder-shape | OK | - |
| 041-diamond-shape | OK | - |
| 042-mixed-shapes | OK | - |
| 050-many-nodes-same-rank | OK | - |
| 051-deep-chain | OK | - |
| 052-disconnected-components | OK | - |
| 053-wide-fanout-labels | OK | - |

### Key Findings
- **Invariant 1 (label-not-overlapping-node)**: Detected in fixture 030 — label "verify" overlaps Auth node. This is the primary bug the suite was built to catch.
- **Invariant 2 (edge-not-through-node)**: Detected in fixtures 011, 032 — genuine edge routing issues where edges pass through intermediate nodes.
- **Invariant 3 (nodes-not-overlapping)**: No violations found — our layout correctly separates sibling nodes.
- **Invariant 4 (label-near-edge)**: No violations found — all edge labels are positioned near their edges.

## Architecture Notes

- D2 crate API: `render_d2_to_svg(source: &str, options: &RenderOptions) -> Result<RenderResult, D2Error>`
- SVG output uses 5-layer rendering: background, container fills, shapes, edges, labels
- Existing tests: 150 across all modules
- Key types: `D2Graph`, `D2Object`, `D2EdgeData`, `Point`, `Rect`

## Log

### 14:00 — Project Start
- Read plan document, explored crate/d2 structure
- Created directory structure: tests/d2_conformance/{fixtures,reference,actual,analysis}, tools/d2_conformance/
- Setting up agent team for parallel Stage 1 work

### 14:30 — Stage 1 Complete
- All 24 fixtures created (plan had 22 numbered but 24 files total due to numbering scheme)
- 5 Python scripts created in tools/d2_conformance/
- Rust integration test created at crates/d2/tests/d2_conformance.rs (compiled successfully)
- D2 CLI installed via `go install` (v0.7.1) — ELK layout used for reference SVGs
- All 24 reference SVGs generated successfully
- Committed: c7c2f51

### 15:00 — Stage 2 Complete
- Launched 3 parallel code reviewers (Rust harness, Python tooling, fixtures)
- First conformance run: 14 violations across 8 fixtures (many were false positives)
- Reviews identified key issue: edge-through-node check doesn't identify endpoint nodes
- Applied fix: identify endpoint nodes per-path, skip them during Invariant 2 checks
- After fix: 7 genuine violations across 3 fixtures
- All remaining violations are genuine bugs in the D2 renderer
- Committed: 8a050c5

### 15:15 — Verification
- Launched verification agent to compare implementation against plan checklist
- All success criteria met
