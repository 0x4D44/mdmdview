# Journal: Code Coverage Improvement

**Date:** 2026-02-07
**Commit:** 2f6f6c5

## Objective

Analyze code coverage, write a detailed report, devise a multistage improvement plan, and implement until coverage reached 98%.

## Baseline (902 tests)

| Metric | Value |
|--------|-------|
| Lines | 99.10% (23,900/24,118) |
| Functions | 99.71% (2,052/2,058) |
| Regions | 98.43% (38,991/39,614) |

Only file below 98% regions: **app.rs at 97.36%** (235 missed regions).

## Final Result (918 tests)

| Metric | Value |
|--------|-------|
| Lines | **99.51%** (24,225/24,344) |
| Functions | **99.86%** (2,086/2,089) |
| Regions | **98.84%** (39,528/39,991) |

### Per-File Regions

| File | Regions % | Missed |
|------|-----------|--------|
| app.rs | 98.30% | 156 |
| emoji_assets.rs | 100.00% | 0 |
| emoji_catalog.rs | 97.78% | 9 |
| image_decode.rs | 100.00% | 0 |
| markdown_renderer.rs | 98.77% | 217 |
| mermaid_renderer.rs | 99.45% | 47 |
| sample_files.rs | 100.00% | 0 |
| column_spec.rs | 98.56% | 23 |
| metrics.rs | 98.84% | 4 |
| window_state.rs | 99.45% | 7 |

## What Was Done

### Tests Added (16 total)

**app.rs** (+10 tests):
- `test_poll_readability_discards_stale_result` — stale result ID filtering
- `test_spawn_readability_worker_error_path` — thread spawn failure via `FORCE_THREAD_SPAWN_ERROR`
- `test_render_status_bar_with_readability_stats` — status bar with Flesch score
- `test_render_status_tooltip_all_reading_levels` — all 7 Flesch interpretation brackets
- `test_render_status_bar_no_readability_with_content` — "Flesch: ..." pending state
- `test_menu_allow_remote_images_toggle` — Allow Remote Images menu action
- `test_render_status_bar_empty_content_no_readability` — empty content + no stats branch
- `test_render_status_bar_readability_pending_with_content` — readability pending format
- `test_debug_repaint_logging_path` — debug repaint logging (idle + active frames)
- `test_debug_scroll_logging_path` — debug scroll trace logging

**markdown_renderer.rs** (+7 tests):
- `test_allow_remote_images_getter` — getter toggle
- `test_render_link_with_emoji_characters` — emoji-aware link rendering
- `test_render_link_with_mixed_emoji_and_text` — mixed text/emoji links
- `test_render_text_with_search_highlighting_active` — search highlight during render
- `test_render_strong_link_with_emoji` — bold emoji links
- `test_render_text_with_emojis_and_styles` — emoji with inline styles
- `test_render_link_context_menu_in_test_mode` — link context menu path

### Production Code Changes

1. **Debug logging testability** (app.rs): Added `FORCE_DEBUG_REPAINT` and `FORCE_DEBUG_SCROLL` AtomicBool flags behind `#[cfg(test)]`. In test builds, these replace the `OnceLock`-based env var checks so debug logging can be exercised without process-level initialization issues.
2. **Debug scroll log path** (app.rs): `#[cfg(test)]` redirects scroll trace to `std::env::temp_dir()` instead of hardcoded `c:\tmp`.
3. **Unused variable fix** (markdown_renderer.rs): `r` → `_r` in test-cfg'd context menu code.

## Key Findings

- **~200 missed regions are assertion macro artifacts**: `assert!()`, `assert_eq!()`, and `unwrap_or_else()` each generate a failure branch that llvm-cov counts as a region. These never execute in passing tests and cannot be covered.
- **OnceLock prevents test toggling**: The debug logging used `OnceLock<bool>` which initializes once per process. Multiple tests in the same process can't toggle the flag. Solved with `#[cfg(test)]` AtomicBool alternatives.
- **emoji_catalog.rs at 97.78%** is the only file below 98% regions, and all 9 missed regions are test assertion failure paths — structurally impossible to improve.

## Deliverables

- `wrk_docs/2026.02.07 - CC - Code Coverage Analysis.md` — detailed gap analysis with before/after
- `wrk_docs/2026.02.07 - CC - Coverage Improvement Plan.md` — multistage plan with execution status
