# 2026.01.03 - Mermaid Visual Tests



- Ran `python tools/mermaid_visual_check.py` repeatedly to verify mermaid visual diffs; focused on class, mindmap, timeline cases.

- Fixed internal QuickJS DOM gaps for mermaid rendering:

  - Added `document.head`, `document.documentElement`, and `getElementsByTagName` support.

  - Added canvas `getContext` stub and text measurement plumbing.

  - Added element `addEventListener`/`removeEventListener`, plus `text`, `attr`, and `append` helpers.

  - Patched mermaid JS for D3 EnterNode parent fallback and safer text wrap logic.

- Increased mermaid QuickJS memory limit to 1GB and default render timeout to 12s.

- Added per-case wait override in `tools/mermaid_visual_check.py` for `mindmap` to avoid screenshot timeouts.



Results:

- Timeline now renders without JS errors; diff is ~11.85% but exceeds pixel threshold.

- Class diff still ~15% (over percent threshold).

- Mindmap renders but remains far from reference (~20-66% diff depending on wait); still a visual mismatch.



Next:

- Investigate mindmap layout differences (SVG output vs reference, CSS/resvg limitations) and decide on threshold tuning vs renderer fixes.

- Adjust diff thresholds per-case once acceptable visual parity is confirmed.



Update (2026.01.03):

- Compared `mdmdview --screenshot` output against a manual re-run at 2560x1440; images are identical (diff 0%).

- Mindmap placeholder is coming from render failures, not capture timing. New dump logs show `Mermaid render timed out` and `Mermaid render error: out of memory`.

- `pending_renders` stays false while the error placeholder renders, so the screenshot settles with the error panel.

More work (2026.01.03):
- Investigated mindmap timeouts: mermaid mindmap uses cytoscape (cose-bilkent) layout; QuickJS hits render timeout or OOM even with longer waits.
- Added DOM reset helper to clear children/text cache each render; added timer queue and flush; added performance.now to use Date.now; stubbed getComputedStyle; improved getBBox/getBoundingClientRect with w/h and HTML element sizing defaults.
- Added parentNode tracking (parent_set) and detach cleanup for innerHTML/removeChild.
- Added mindmap layout patch hooks; tried numIter reductions and breadthfirst layout swap; still timing out.
- Raised QuickJS memory limit to 2GB for stress testing; still OOM on long waits.
- Generated mermaid CLI SVG for mindmap to inspect reference layout positions.

Review pack (2026.01.03):
- Added tools/mermaid_review_pack.py to generate an eyeball-friendly screenshot pack with mdmdview vs mermaid-cli + diff + index.html.
Review pack run (2026.01.04):
- Generated review pack under tests/mermaid_visual/review_pack/2026.01.04 with 15 cases; failures: gitgraph, mindmap, timeline.

Review pack script tweaks (2026.01.04):
- Added non-background coverage metrics and sparse-render detection in tools/mermaid_review_pack.py; index now shows cropped images + coverage numbers.
- Rerun timed out before finishing, so report.json still reflects the earlier run.

Update (2026.01.04):
- Implemented bbox-based rasterize fallback in mermaid renderer to correct tiny viewBox outputs; render now uses usvg abs_stroke_bounding_box with a small padding and pre-translate before scaling.

Update (2026.01.04):
- Fixed svg getBBox for root <svg> to derive bounds from children so viewBox sizing is correct; most diagrams now render full content (class/flowchart/state/etc).
- Added bbox-aware rasterization fallback; combined with svg bbox fix removes tiny-viewBox clipping.
- Updated text measurement line height to use font ascender/descender metrics (fallback 1.2x); class/timeline diffs improved.
- Re-ran review packs: most cases now pass; remaining diffs are class (~14% over threshold) and timeline (~8% over threshold), with er/flowchart_subgraph sometimes flagged by sparse detection due to full-size mdmdview screenshots.

Update (2026.01.04):
- Adjusted native/fallback text measurement to use font ascender/descender line height (1.2x fallback).
- Class viewBox now ~300px tall with node heights close to mermaid-cli; class diff improved slightly (~14%).
- Timeline diff improved to ~8.4% in a focused run.
