# 2026.01.03 - Mermaid Visual Tests

- Ran `python tools/mermaid_visual_check.py` repeatedly to verify mermaid visual diffs; focused on class, mindmap, timeline cases.
- Fixed internal QuickJS DOM gaps for mermaid rendering:
  - Added `document.head`, `document.documentElement`, and `getElementsByTagName` support.
  - Added canvas `getContext` stub and text measurement plumbing.
  - Added element `addEventListener`/`removeEventListener`, plus `text`, `attr`, and `append` helpers.
  - Patched mermaid JS for D3 EnterNode parent fallback and safer text wrap logic.
- Increased mermaid QuickJS memory limit to 1GB and default render timeout to 12s.
- Added per-case wait override in `tools/mermaid_visual_check.py` for `mindmap` to avoid screenshot timeouts.

Results:
- Timeline now renders without JS errors; diff is ~11.85% but exceeds pixel threshold.
- Class diff still ~15% (over percent threshold).
- Mindmap renders but remains far from reference (~20-66% diff depending on wait); still a visual mismatch.

Next:
- Investigate mindmap layout differences (SVG output vs reference, CSS/resvg limitations) and decide on threshold tuning vs renderer fixes.
- Adjust diff thresholds per-case once acceptable visual parity is confirmed.

Update (2026.01.03):
- Compared `mdmdview --screenshot` output against a manual re-run at 2560x1440; images are identical (diff 0%).
- Mindmap placeholder is coming from render failures, not capture timing. New dump logs show `Mermaid render timed out` and `Mermaid render error: out of memory`.
- `pending_renders` stays false while the error placeholder renders, so the screenshot settles with the error panel.
